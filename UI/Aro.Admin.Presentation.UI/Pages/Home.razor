@page "/"

@attribute [Authorize]
@using Microsoft.AspNetCore.Components.Authorization

@inject ISnackbar Snackbar

<PageTitle>ARO Admin - Home</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid h-100">
            <div class="vstack gap-3 p-3 h-100">
                <div class="d-flex justify-content-end">
                    <div class="hstack gap-5">
                        @if (IsVisible)
                        {
                            <div class="bg-white shadow">
                                <MudInput T="string"
                                          Value="@_searchInput"
                                          ValueChanged="OnSearchInputChanged"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                            </div>
                        }

                        <MudIconButton Icon="@(IsVisible? Icons.Material.Filled.Close : Icons.Material.Filled.Search)"
                                       Variant="Variant.Text"
                                       Color="Color.Dark"
                                       Class="button-search shadow"
                                       @onclick="ShowSearchbar"
                                       title="Search button" />
                    </div>
                </div>

                <GroupList ClientFilter="@ClientNameFilter" />
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject] private NavigationManager? NavigationManager { get; set; }

    private bool IsVisible = false;

    // Actual value passed to GroupList (debounced)
    private string ClientNameFilter = string.Empty;

    // Raw keystroke value
    private string _searchInput = string.Empty;

    private CancellationTokenSource? _typingCts;

    private void ShowSearchbar()
    {
        IsVisible = !IsVisible;

        if (!IsVisible)
        {
            _searchInput = string.Empty;
            ClientNameFilter = string.Empty;
        }
    }

    private async Task OnSearchInputChanged(string value)
    {
        _searchInput = value;

        _typingCts?.Cancel();
        _typingCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(600, _typingCts.Token); // debounce delay
            ClientNameFilter = _searchInput;
        }
        catch (TaskCanceledException)
        {
            // Expected while user is typing
        }
    }

    private void HandleSettings()
    {
        NavigationManager?.NavigateTo("/settings");
    }
}
