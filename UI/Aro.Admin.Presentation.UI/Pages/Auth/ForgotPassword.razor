@page "/forgot-password"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@inject NavigationManager NavigationManager
@inject IPasswordResetService PasswordResetService
@inject ISnackbar Snackbar

<div class="login-container">
    <div class="login-left-panel">
        <div class="logo-container">
            <img src="aro-logo.svg" alt="ARO Digital Strategy" class="aro-logo-svg" />
        </div>
    </div>

    <div class="login-right-panel">
        <div class="login-card">
            @if (emailSent)
            {
                <div class="login-header">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Class="mb-3" />
                    <h2 class="login-text">Check Your Email</h2>
                </div>

                <MudAlert Severity="Severity.Success" Class="mb-4">
                    We've sent a password reset link to <strong>@model.Email</strong>
                </MudAlert>

                <MudText Typo="Typo.body2" Class="mb-4">
                    Please check your email and click on the reset password link to continue.
                    The link will expire in 60 minutes.
                </MudText>

                <div class="login-button-container">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               Href="/login"
                               FullWidth="false">
                        Back to Login
                    </MudButton>
                </div>
            }
            else
            {
                <div class="login-header">
                    <h1 class="welcome-text">Forgot Password?</h1>
                    <h2 class="login-text">Reset Your Password</h2>
                </div>

                <MudText Typo="Typo.body2" Class="mb-4">
                    Enter your email address and we'll send you a link to reset your password.
                </MudText>

                <MudForm @ref="form" Class="login-form">
                    <MudTextField @bind-Value="model.Email"
                                  Label="Email Address"
                                  Variant="Variant.Outlined"
                                  Class="login-input"
                                  Required="true"
                                  RequiredError="Email is required"
                                  Validation="@(new EmailAddressAttribute() { ErrorMessage = "Invalid email format" })" />

                    <div class="login-button-container">
                        <MudButton Variant="Variant.Filled"
                                   Class="login-button"
                                   OnClick="HandleSendResetLink"
                                   Disabled="@isLoading"
                                   FullWidth="false">
                            @if (isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Sending...</MudText>
                            }
                            else
                            {
                                <MudText>Send Reset Link</MudText>
                            }
                        </MudButton>
                    </div>

                    <div class="forgot-password-container">
                        <span>Remember your password? <MudLink Href="/login" Underline="Underline.Always" Color="Color.Dark">Login here.</MudLink></span>
                    </div>
                </MudForm>
            }
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private ForgotPasswordModel model = new();
    private bool isLoading = false;
    private bool emailSent = false;

    private async Task HandleSendResetLink()
    {
        await form!.Validate();

        if (!form.IsValid)
        {
            return;
        }

        isLoading = true;

        try
        {
            var success = await PasswordResetService.SendPasswordResetLinkAsync(model.Email);

            if (success)
            {
                // Clear any existing toasts
                Snackbar.Clear();

                emailSent = true;
                Snackbar.Add("Password reset link sent successfully!", Severity.Success);
            }
            else
            {
                // Clear any existing toasts
                Snackbar.Clear();

                Snackbar.Add("Failed to send reset link. Please check the email address and try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            // Clear any existing toasts
            Snackbar.Clear();

            Snackbar.Add("An error occurred. Please try again.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class ForgotPasswordModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = string.Empty;
    }
}
