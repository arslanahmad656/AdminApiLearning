@page "/login"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Aro.UI.Application.Exceptions
@inject NavigationManager NavigationManager
@inject IAuthenticationService AuthService
@inject ApiAuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IErrorHandlingService ErrorHandler

<div class="login-container">
    <div class="login-left-panel">
        <div class="logo-container">
            <img src="aro-logo.svg" alt="ARO Digital Strategy - Company Logo" class="aro-logo-svg" role="img" />
        </div>
    </div>

    <div class="login-right-panel">
        <div class="mobile-logo-panel">
            <img src="aro-logo.svg" alt="ARO Digital Strategy - Company Logo" class="mobile-logo" />
        </div>

        <div class="login-card">
            @if (showSuccessMessage)
            {
                <MudAlert MudBlazor.Severity="MudBlazor.Severity.Success" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => showSuccessMessage = false)">
                    New password has been set!
                </MudAlert>
            }

            <div class="login-header">
                <h1 id="login-title" class="welcome-text">Welcome</h1>
                <h2 id="login-subtitle" class="login-text">Login</h2>
            </div>

            <MudForm @ref="form" Class="login-form" role="form" aria-labelledby="login-title login-subtitle">
                <MudTextField @bind-Value="model.Email"
                              Label="Email"
                              Variant="Variant.Outlined"
                              Class="login-input"
                              Required="true"
                              RequiredError="Email is required"
                              Immediate="true"
                              Validation="@(new EmailAddressAttribute() { ErrorMessage = "Please enter a valid email address" })"
                              OnKeyDown="@HandleKeyDown"
                              aria-label="Email input"
                              tabindex="1" />

                <MudTextField @bind-Value="model.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="@passwordInputType"
                              Class="login-input password-field"
                              Required="true"
                              RequiredError="Password is required"
                              Immediate="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              OnKeyDown="@HandleKeyDown"
                              AdornmentAriaLabel="@(passwordVisible ? "Hide password" : "Show password")"
                              aria-label="Password input"
                              tabindex="2" />

                <div class="remember-me-container">
                    <MudCheckBox @bind-Value="model.RememberMe" Color="Color.Dark" tabindex="4" aria-label="Remember me checkbox">
                        Remember me
                    </MudCheckBox>
                </div>

                <div class="forgot-password-container">
                    <span>Forgot your password? <MudLink Href="/forgot-password" Underline="Underline.Always" Color="Color.Dark" tabindex="5" aria-label="Reset password link">Reset here.</MudLink></span>
                </div>

                <div class="login-button-container">
                    <MudButton Variant="Variant.Filled"
                               Class="@($"login-button {(IsLoginDisabled ? "login-button-disabled" : "")}")"
                               OnClick="HandleLogin"
                               Disabled="@IsLoginDisabled"
                               FullWidth="false"
                               aria-label="@(IsLoginDisabled ? "Login button disabled - please fill in email and password" : "Login button")"
                               tabindex="6">
                        @if (isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Logging in...</MudText>
                        }
                        else
                        {
                            <MudText>Continue</MudText>
                        }
                    </MudButton>
                </div>
            </MudForm>
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private LoginModel model = new();
    private bool showSuccessMessage = false;
    private bool isLoading = false;
    private bool passwordVisible = false;
    private InputType passwordInputType = InputType.Password;
    private string passwordIcon = Icons.Material.Filled.Visibility;

    // Computed property to disable login button until both fields are filled
    private bool IsLoginDisabled => isLoading ||
                                    string.IsNullOrWhiteSpace(model.Email) ||
                                    string.IsNullOrWhiteSpace(model.Password);

    protected override void OnInitialized()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (query["passwordReset"] == "true")
        {
            showSuccessMessage = true;
        }
    }

    private void TogglePasswordVisibility()
    {
        passwordVisible = !passwordVisible;
        passwordInputType = passwordVisible ? InputType.Text : InputType.Password;
        passwordIcon = passwordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    // Handle Enter key press to submit form
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !IsLoginDisabled)
        {
            await HandleLogin();
        }
    }

    private async Task HandleLogin()
    {
        await form!.Validate();

        if (!form.IsValid)
        {
            return;
        }

        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(model.Email, model.Password, model.RememberMe);

            if (response != null)
            {
                Snackbar.Clear();
                await AuthStateProvider.MarkUserAsAuthenticated();
                Snackbar.Add("Login successful! Welcome back.", MudBlazor.Severity.Success);
                await Task.Delay(500);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                Snackbar.Clear();
                Snackbar.Add("Invalid email or password. Please try again.", MudBlazor.Severity.Error);
            }
        }
        catch (AccountLockedException lockEx)
        {
            Snackbar.Clear();
            if (lockEx.RemainingMinutes > 0)
            {
                Snackbar.Add($"Your account has been locked due to too many failed attempts. Please try again in {lockEx.RemainingMinutes} minute(s).", MudBlazor.Severity.Error);
            }
            else
            {
                Snackbar.Add("Your account has been locked due to too many failed attempts. Please try again later.", MudBlazor.Severity.Error);
            }
        }
        catch (HttpRequestException)
        {
            Snackbar.Clear();
            Snackbar.Add("Unable to connect to the server. Please check your internet connection and try again.", MudBlazor.Severity.Error);
        }
        catch (TaskCanceledException)
        {
            Snackbar.Clear();
            Snackbar.Add("The request timed out. Please try again.", MudBlazor.Severity.Error);
        }
        catch (Exception ex)
        {
            ErrorHandler.ShowError(ex, "An unexpected error occurred during login. Please try again.");
        }
        finally
        {
            isLoading = false;
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; } = false;
    }
}
