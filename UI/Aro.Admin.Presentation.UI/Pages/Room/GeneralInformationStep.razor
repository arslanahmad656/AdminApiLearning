@using Aro.UI.Application.DTOs.Room
@using Aro.Admin.Presentation.UI.Shared

@inject IValidator<RoomModel> roomValidator
@inject IRoomService RoomService
@inject IPropertyService PropertyService

<StepTitle StepNumber="1" Title="General Information" />

<MudForm @ref="roomForm"
    Model="Wizard.Entity"
    Validation="@(roomValidator.GetValidateValue())">

    <div class="row gy-2 mt-5">

        <!-- Room Name -->
        <div class="col-sm-8 col-xl-6">
            <div class="form-group">
                <label for="roomName" class="form-label">Room Name *</label>
                <MudTextField @bind-Value="Wizard.Entity.RoomName"
                For="@(() => Wizard.Entity.RoomName)"
                id="roomName"
                Placeholder="Room Name"
                Required="true"
                Variant="Variant.Outlined"
                Margin="Margin.Dense" />
            </div>
        </div>

        <div class="w-100"></div>

        <!-- Room Code -->
        <div class="col-sm-8 col-xl-6">
            <div class="form-group">
                <div class="vstack">
                    <label for="roomCode" class="form-label mb-0">Room Code *</label>
                    <small id="roomCodeHelp" class="form-text text-muted mb-0">Your unique ID for this room in URLs (e.g., SDB for Standard Double)</small>

                </div>
                <div class="w-25">
                    <MudTextField @bind-Value="Wizard.Entity.RoomCode"
                        For="@(() => Wizard.Entity.RoomCode)"
                        id="roomCode"
                        Placeholder="Room Code"
                        Required="true"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        aria-describedby="roomCodeHelp"
                        Immediate="true"
                        Error="@_isDuplicateRoomCode"
                        ErrorText="@_duplicateRoomCodeError"
                        @onblur="ValidateRoomCode" />
                </div>
                @if (_isValidatingRoomCode)
                {
                    <small class="text-muted mt-1">Checking room code...</small>
                }
                else if (_isDuplicateRoomCode)
                {
                    <small class="text-danger mt-1">@_duplicateRoomCodeError</small>
                }
            </div>
        </div>

        <div class="w-100"></div>

        <!-- Description -->
        <div class="col-sm-8 col-xl-6">
            <div class="form-group">
                <div class="vstack">
                    <label for="description" class="form-label mb-0">Description</label>
                    <small id="descriptionHelp" class="form-text text-muted mb-0">This is visible to people who are trying to book the room. Max 800 characters.</small>
                </div>
                <MudTextField @bind-Value="Wizard.Entity.Description"
                    id="description"
                    Placeholder="Description"
                    For="@(() => Wizard.Entity.Description)"
                    Immediate="true"
                    Variant="Variant.Outlined"
                    Margin="Margin.Dense"
                    Lines="10"
                    aria-describedby="descriptionHelp"
                    MaxLength="800"
                    @onfocus="() => isDescriptionFocused = true"/>
                @if (isDescriptionFocused)
                {
                    <p class="form-text mt-1 @(GetDescriptionRemainingChars() == 0 ? "text-danger" : "text-muted")">@GetDescriptionRemainingChars() characters left</p>
                }
            </div>
        </div>

        <div class="w-100"></div>
    </div>

</MudForm>

<WizardFooter OnBack="HandleBack"
              OnNext="HandleNext"
              BackDisabled="@(Wizard.ActiveStepIndex == 0)"
              NextDisabled="@(!IsFormValid())" />

@code {
    [CascadingParameter] public EntityWizardContext<RoomModel> Wizard { get; set; } = default!;

    private MudForm? roomForm;

    private const int MaxDescriptionLength = 800;
    private bool isDescriptionFocused = false;

    private bool _isDuplicateRoomCode = false;
    private bool _isValidatingRoomCode = false;
    private string _duplicateRoomCodeError = "";
    private string _lastValidatedRoomCode = "";

    private int GetDescriptionRemainingChars()
    {
        if (Wizard?.Entity?.Description == null)
        {
            return MaxDescriptionLength;
        }
        return MaxDescriptionLength - Wizard.Entity.Description.Length;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Wizard.CurrentStepValidation = ValidateStepAsync;
        }
    }

    private async Task ValidateRoomCode()
    {
        var roomCode = Wizard.Entity?.RoomCode;

        if (string.IsNullOrWhiteSpace(roomCode))
        {
            _isDuplicateRoomCode = false;
            _duplicateRoomCodeError = "";
            return;
        }

        if (roomCode == _lastValidatedRoomCode)
            return;

        _lastValidatedRoomCode = roomCode;
        _isValidatingRoomCode = true;
        StateHasChanged();

        try
        {
            var groupId = Wizard.Entity?.GroupId ?? Guid.Empty;
            var excludeRoomId = Wizard.Entity?.IsEditMode == true ? Wizard.Entity?.Id : null;

            // Check room code uniqueness across all properties in the group
            var exists = await CheckRoomCodeExistsInGroup(groupId, roomCode, excludeRoomId);

            _isDuplicateRoomCode = exists;
            _duplicateRoomCodeError = exists ? "A room with this code already exists. Please use a unique room code." : "";
        }
        catch
        {
            _isDuplicateRoomCode = false;
            _duplicateRoomCodeError = "";
        }
        finally
        {
            _isValidatingRoomCode = false;
            StateHasChanged();
        }
    }

    private async Task<bool> CheckRoomCodeExistsInGroup(Guid groupId, string roomCode, Guid? excludeRoomId = null)
    {
        if (groupId == Guid.Empty || string.IsNullOrWhiteSpace(roomCode))
            return false;

        try
        {
            // Get all properties in the group
            var properties = await PropertyService.GetPropertiesByGroupIdAsync(groupId);
            if (properties == null || !properties.Any())
                return false;

            // Check room codes across all properties in the group
            foreach (var property in properties)
            {
                var exists = await RoomService.CheckRoomCodeExists(property.PropertyId, roomCode, excludeRoomId);
                if (exists)
                    return true;
            }

            return false;
        }
        catch
        {
            return false;
        }
    }

    private async Task<bool> ValidateStepAsync()
    {
        if (roomForm is null) return false;

        await roomForm.Validate();

        if (!string.IsNullOrWhiteSpace(Wizard.Entity?.RoomCode) && _lastValidatedRoomCode != Wizard.Entity.RoomCode)
        {
            await ValidateRoomCode();
        }

        return roomForm.IsValid && !_isDuplicateRoomCode;
    }

    private bool IsFormValid()
    {
        if (Wizard.Entity == null) return false;
        return !string.IsNullOrWhiteSpace(Wizard.Entity.RoomName) &&
               !string.IsNullOrWhiteSpace(Wizard.Entity.RoomCode) &&
               !_isDuplicateRoomCode;
    }

    private void HandleBack()
    {
        Wizard.OnBack?.Invoke();
    }

    private async Task HandleNext()
    {
        if (!string.IsNullOrWhiteSpace(Wizard.Entity?.RoomCode) && _lastValidatedRoomCode != Wizard.Entity.RoomCode)
        {
            await ValidateRoomCode();
        }

        if (_isDuplicateRoomCode)
            return;

        if (Wizard.OnNext != null)
        {
            await Wizard.OnNext.Invoke();
        }
    }
}
