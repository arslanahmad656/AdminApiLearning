@using Aro.UI.Application.DTOs.Room

<div class="vstack gap-2 mb-5">
    <h3 class="fs-6 fw-normal">Step 4</h3>
    <h2 class="fs-4">Upload Media Files</h2>
    <span>These images will be shown in the slider to the end user when clicking on the room. Images can be reordered by dragging. Max 2MB per image.</span>
</div>

@if (Wizard.Entity is not null)
{
    <UploadMediaFilesInput Images="Wizard.Entity.Images"
                           ImagesChanged="OnImagesChanged"
                           SelectedImageChanged="OnSelectedImageChanged" />

    <div class="vstack gap-2 mt-5 mb-2">
        <h2 class="fs-4">Select Thumbnail</h2>
        <span>Click an image to set it as the thumbnail.</span>
    </div>

    <div class="row gap-3 media-container w-100 rounded border border-1 p-3">
        @foreach (var image in Wizard.Entity.Images)
        {
            <div class="col-sm-2 h-100 rounded d-flex align-items-center justify-content-center p-1 border
                                @(image.IsThumbnail ? "border-warning border-3" : "")"
                 style="cursor:pointer"
                 @onclick="() => OnSelectedImageChanged(image)">

                <img src="data:image/png;base64,@image.ContentBase64"
                     class="img-fluid rounded"
                     style="max-height: 100%; object-fit: cover;" />
            </div>
        }
    </div>
}

<WizardFooter OnBack="HandleBack"
              OnNext="HandleNext"
              BackDisabled="false"
              NextDisabled="false" />

<style>
    .media-container {
        height: 200px;
        border-color: #929292;
    }
</style>

@code {
    [CascadingParameter] public EntityWizardContext<RoomModel> Wizard { get; set; } = default!;

    private Task OnImagesChanged(List<ImageModel> images)
    {
        Wizard.Entity!.Images = images;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnSelectedImageChanged(ImageModel? image)
    {
        foreach (var img in Wizard.Entity!.Images)
            img.IsThumbnail = false;

        if (image != null)
        {
            var selected = Wizard.Entity.Images.FirstOrDefault(i => i.Id == image.Id);
            if (selected != null)
                selected.IsThumbnail = true;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private void HandleBack() => Wizard.OnBack?.Invoke();
    private Task HandleNext() => Wizard.OnNext?.Invoke() ?? Task.CompletedTask;
}
