@using Aro.UI.Application.DTOs.Group
@using Aro.Admin.Presentation.UI.Shared

@inject IValidator<PrimaryContactModel> PrimaryContactValidator
@inject ICountryMetadataService CountryMetadataService

<StepTitle StepNumber="2" Title="Primary Contact Details" />

@if (Wizard.Entity is not null && Wizard.Entity.PrimaryContact is not null)
{
    var model = Wizard.Entity.PrimaryContact;

    <MudForm @ref="primaryContactForm"
             Model="model"
             Validation="@(PrimaryContactValidator.GetValidateValue())">

        <div class="row gy-2">

            <!-- Name -->
            <div class="col-sm-8 col-xl-4 @(!Wizard.IsCreateMode ? "d-none" : "")">
                <div class="form-group">
                    <label for="primary-name" class="form-label">Name *</label>
                    <MudTextField @bind-Value="model.Name"
                                  For="@(() => model.Name)"
                                  id="primary-name"
                                  Placeholder="Name"
                                  Immediate
                                  Required
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </div>
            </div>

            <div class="w-100"></div>

            <!-- Email -->
            <div class="col-sm-10 col-xl-6">
                <div class="form-group">
                    <label for="primary-email" class="form-label">Contact Email *</label>
                    <MudTextField @bind-Value="model.Email"
                                  For="@(() => model.Email)"
                                  id="primary-email"
                                  Placeholder="Email"
                                  Required
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </div>
            </div>

            <div class="w-100"></div>

            <!-- Phone -->
            <div class="col-sm-6 col-xl-4 @(!Wizard.IsCreateMode ? "d-none" : "")">
                <div class="form-group">
                    <label for="primary-phone" class="form-label">Phone Number *</label>

                    <div class="phone-number-input hstack align-items-center @GetPhoneBorderClass()">
                        <!-- Flag with country code selector -->
                        <div class="flag-section" @onclick="ToggleCountryDropdown">
                            <img src="@(SelectedCountry?.FlagUrl ?? GetPlaceholderFlagSvg())" alt="Country Flag" class="flag-icon" />
                        </div>

                        <!-- Divider -->
                        <div class="phone-divider"></div>

                        <!-- Combined phone number display -->
                        <div class="phone-input-section">
                            <span class="country-code-display">@GetCountryCodeDisplay()</span>
                            <input type="text"
                                   class="phone-input"
                                   placeholder="Phone Number"
                                   value="@model.PhoneNumber"
                                   @oninput="OnPhoneNumberChanged" />
                        </div>
                    </div>

                    <!-- Hidden country dropdown (only shows when flag is clicked) -->
                    @if (_showCountryDropdown)
                    {
                        <div class="country-dropdown-overlay" @onclick="CloseCountryDropdown"></div>
                        <div class="country-dropdown">
                            @foreach (var c in _countryOptions)
                            {
                                <div class="country-option @(c == SelectedCountry ? "selected" : "")"
                                     @onclick="() => SelectCountry(c)">
                                    <img src="@c.FlagUrl" alt="@c.Country" class="flag-icon-small" />
                                    <span class="country-name">@c.Country</span>
                                    <span class="country-phone-code">+@c.PhoneCode</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <MudTextField @bind-Value="model.PhoneNumber"
                              For="@(() => model.PhoneNumber)"
                              Style="display:none;"
                              Immediate="true" />

            </div>

        </div>
    </MudForm>
}

<WizardFooter OnBack="HandleBack"
              OnNext="HandleNext"
              BackDisabled="false"
              NextDisabled="@(!IsFormValid())" />

<style>
    .phone-number-input {
        margin: 4px 0;
        height: 48px;
        background-color: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 4px;
        display: flex;
        align-items: center;
        overflow: hidden;
    }

    .phone-number-input.border-error {
        border-color: var(--mud-palette-error);
    }

    .phone-number-input.border-grey {
        border-color: #C3C3C3;
    }

    .flag-section {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #F6F6F6;
    }

    .flag-section:hover {
        background-color: #EBEBEB;
    }

    .phone-divider {
        width: 1px;
        height: 24px;
        background-color: #C3C3C3;
    }

    .phone-input-section {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 4px;
    }

    .country-code-display {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        color: #000000;
        white-space: nowrap;
    }

    .phone-input {
        flex: 1;
        border: none;
        background: transparent;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        color: #000000;
        outline: none;
        padding: 0;
    }

    .phone-input::placeholder {
        color: #9E9E9E;
    }

    .flag-icon {
        width: 24px;
        height: 18px;
        object-fit: cover;
    }

    .flag-icon-small {
        width: 20px;
        height: 15px;
        object-fit: cover;
    }

    /* Country dropdown styles */
    .country-dropdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
    }

    .country-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 300px;
        max-height: 250px;
        overflow-y: auto;
        background: #FFFFFF;
        border: 1px solid #C3C3C3;
        border-radius: 4px;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        margin-top: 4px;
    }

    .country-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        cursor: pointer;
        transition: background-color 0.15s;
    }

    .country-option:hover {
        background-color: #F5F5F5;
    }

    .country-option.selected {
        background-color: #FFF3E0;
    }

    .country-name {
        flex: 1;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        color: #000000;
    }

    .country-phone-code {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        color: #707070;
    }

    .form-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 16px;
        line-height: 18px;
        color: #000000;
        display: block;
        margin-bottom: 12px;
    }

    .form-group {
        position: relative;
    }
</style>

@code {
    [CascadingParameter]
    public EntityWizardContext<GroupModel> Wizard { get; set; } = default!;

    private MudForm? primaryContactForm;

    private bool IsPhoneInvalid { get; set; } = false;
    private bool _showCountryDropdown = false;

    private readonly List<CountryOption> _countryOptions = new();

    private CountryOption? _selectedCountry;

    private CountryOption? SelectedCountry
    {
        get => _selectedCountry;
        set
        {
            if (_selectedCountry == value)
                return;

            _selectedCountry = value;
            Wizard.Entity!.PrimaryContact!.CountryCode = value?.PhoneCode;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CountryMetadataService.InitializeAsync();

        _countryOptions.AddRange(
            CountryMetadataService
            .GetAll()
            // .GroupBy(c => c.PhoneCountryCode)
            // .Select(g => g.First())
            .OrderBy(c => int.Parse(c.PhoneCountryCode.TrimStart('+')))
            .Select(c => new CountryOption
            {
                Code = c.ISO2,
                Country = c.Name,
                PhoneCode = c.PhoneCountryCode,
                PhoneRegex = c.PhoneNumberRegex,
                FlagUrl = $"/flags/{c.ISO2.ToLowerInvariant()}.svg"
            }));

        _countryOptions.Sort((x, y) => string.Compare(x.PhoneCode, y.PhoneCode));
    }

    protected override void OnParametersSet()
    {
        if (_countryOptions.Count == 0)
            return;

        SelectedCountry = null;

        if (!string.IsNullOrWhiteSpace(Wizard.Entity?.PrimaryContact?.CountryCode))
        {
            SelectedCountry = _countryOptions.FirstOrDefault(c =>
                c.PhoneCode == Wizard.Entity.PrimaryContact.CountryCode);
            return;
        }
    }

    private string GetPlaceholderFlagSvg()
    {
        return "/flags/default.svg";
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Wizard.CurrentStepValidation = ValidateStepAsync;
        }
    }


    private async Task<bool> ValidateStepAsync()
    {
        if (primaryContactForm is null)
            return false;

        await primaryContactForm.Validate();

        IsPhoneInvalid = string.IsNullOrWhiteSpace(Wizard.Entity!.PrimaryContact!.PhoneNumber) ||
                         SelectedCountry is null;

        await InvokeAsync(StateHasChanged);

        return primaryContactForm.IsValid && !IsPhoneInvalid;
    }


    public void Dispose()
    {
        Wizard.CurrentStepValidation = null;
    }

    private sealed class CountryOption
    {
        public string Code { get; init; } = string.Empty;
        public string Country { get; init; } = string.Empty;
        public string PhoneCode { get; init; } = string.Empty;
        public string PhoneRegex { get; init; } = string.Empty;
        public string FlagUrl { get; init; } = string.Empty;

        public override bool Equals(object? obj)
            => obj is CountryOption other &&
               other.PhoneCode == PhoneCode &&
               other.Code == Code;

        public override int GetHashCode()
            => HashCode.Combine(PhoneCode, Code);
    }

    private string GetPhoneBorderClass()
    {
        return IsPhoneInvalid ? "border-error" : "border-grey";
    }

    private bool IsFormValid()
    {
        if (Wizard.Entity?.PrimaryContact == null) return false;
        var contact = Wizard.Entity.PrimaryContact;

        if (Wizard.IsCreateMode)
        {
            return !string.IsNullOrWhiteSpace(contact.Name) &&
                   !string.IsNullOrWhiteSpace(contact.Email) &&
                   !string.IsNullOrWhiteSpace(contact.PhoneNumber) &&
                   !string.IsNullOrWhiteSpace(contact.CountryCode);
        }
        return !string.IsNullOrWhiteSpace(contact.Email);
    }

    private void HandleBack()
    {
        Wizard.OnBack?.Invoke();
    }

    private async Task HandleNext()
    {
        if (Wizard.OnNext != null)
        {
            await Wizard.OnNext.Invoke();
        }
    }

    private void ToggleCountryDropdown()
    {
        _showCountryDropdown = !_showCountryDropdown;
    }

    private void CloseCountryDropdown()
    {
        _showCountryDropdown = false;
    }

    private void SelectCountry(CountryOption country)
    {
        SelectedCountry = country;
        _showCountryDropdown = false;
    }

    private string GetCountryCodeDisplay()
    {
        if (SelectedCountry == null)
            return "";
        return $"+{SelectedCountry.PhoneCode}";
    }

    private void OnPhoneNumberChanged(ChangeEventArgs e)
    {
        if (Wizard.Entity?.PrimaryContact != null)
        {
            Wizard.Entity.PrimaryContact.PhoneNumber = e.Value?.ToString() ?? "";
        }
    }
}
