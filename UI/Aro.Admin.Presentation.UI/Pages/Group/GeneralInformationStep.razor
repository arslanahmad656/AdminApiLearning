@using Aro.UI.Application.DTOs.Group
@using Aro.Admin.Presentation.UI.Shared

@inject IValidator<GroupModel> groupValidator
@inject ICountryMetadataService countryMetadataService

<StepTitle StepNumber="1" Title="General Information" />

@if (Wizard.Entity is not null)
{
    var model = Wizard.Entity;

    <MudForm @ref="groupForm"
             Model="model"
             Validation="@(groupValidator.GetValidateValue())">

        <div class="row gy-2">

            <!-- Group Name -->
            <div class="col-sm-8 col-xl-4">
                <div class="form-group">
                    <label for="groupName" class="form-label">Group Name *</label>
                    <MudTextField @bind-Value="model.GroupName"
                                  For="@(() => model.GroupName)"
                                  id="groupName"
                                  Placeholder="Group Name"
                                  Immediate="true"
                                  Required="true"
                                  Variant="Variant.Outlined"
                                  Margin="margin" />
                </div>
            </div>
            <div class="w-100"></div>

            <!-- Address 1 -->
            <div class="col-sm-10 col-xl-6">
                <div class="form-group">
                    <label for="addressLine1" class="form-label">Address Line 1 *</label>
                    <MudTextField @bind-Value="model.AddressLine1"
                                  For="@(() => model.AddressLine1)"
                                  id="addressLine1"
                                  Placeholder="Address Line 1"
                                  Immediate="true"
                                  Required="true"
                                  Variant="Variant.Outlined"
                                  Margin="margin" />
                </div>
            </div>
            <div class="w-100"></div>

            <!-- Address 2 -->
            <div class="col-sm-10 col-xl-6">
                <div class="form-group">
                    <label for="addressLine2" class="form-label">Address Line 2</label>
                    <MudTextField @bind-Value="model.AddressLine2"
                                  For="@(() => model.AddressLine2)"
                                  id="addressLine2"
                                  Placeholder="Address Line 2"
                                  Immediate="true"
                                  Variant="Variant.Outlined"
                                  Margin="margin" />
                </div>
            </div>
            <div class="w-100"></div>

            <!-- City & Country -->
            <div class="col-sm-6 col-xl-2">
                <div class="form-group">
                    <label for="city" class="form-label">City *</label>
                    <MudTextField @bind-Value="model.City"
                                  For="@(() => model.City)"
                                  id="city"
                                  Placeholder="City"
                                  Immediate="true"
                                  Required="true"
                                  Variant="Variant.Outlined"
                                  Margin="margin" />
                </div>
            </div>

            <div class="col-sm-6 col-xl-4">
                <div class="form-group">
                    <label class="form-label">Country *</label>

                    <div class="@($"country-dropdown hstack border-custom {(IsCountryInvalid ? "border-error" : "border-grey")}  rounded-1")">
                        <div class="py-1 px-3">
                            <img src="@(SelectedCountry?.FlagUrl ?? GetPlaceholderFlagSvg())"
                                 alt="Country Flag"
                                 class="flag-icon" />
                        </div>

                        <MudSelect T="CountryOption"
                                   @bind-Value="SelectedCountry"
                                   Placeholder="Select country"
                                   Variant="Variant.Text"
                                   Dense="true"
                                   Underline="false"
                                   Class="@($"border-start-custom {(IsCountryInvalid ? "border-error" : "border-grey")} py-1 px-3")">

                            @foreach (var c in _countryOptions)
                            {
                                <MudSelectItem Value="@c">
                                    @c.Name
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <MudTextField @bind-Value="model.Country"
                                  For="@(() => model.Country)"
                                  Style="display:none;"
                                  Immediate="true" />
                </div>
            </div>
            <div class="w-100"></div>



            <!-- Postal & Logo -->
            <div class="col-sm-6 col-xl-2">
                <div class="form-group">
                    <label for="postalCode" class="form-label">Postal Code *</label>
                    <MudTextField @bind-Value="model.PostalCode"
                                  For="@(() => model.PostalCode)"
                                  id="postalCode"
                                  Placeholder="Postal Code"
                                  Required="true"
                                  Variant="Variant.Outlined"
                                  Margin="margin" />
                </div>
            </div>

            <div class="col-sm-6 col-xl-4">
                <GroupLogoUpload @bind-model="model.Logo"
                                 ShowError="@ShowLogoError"
                                 @bind-IsEmpty="IsLogoEmpty" />



            </div>
            <div class="w-100"></div>
        </div>
    </MudForm>
}

<WizardFooter OnBack="HandleBack"
              OnNext="HandleNext"
              BackDisabled="@(Wizard.ActiveStepIndex == 0)"
              NextDisabled="@(!IsFormValid())" />

<style>
    .country-dropdown {
        margin: 4px 0;
        height: 40px;
    }

    .border-custom {
        border: 1px solid;
    }

    .border-start-custom {
        border-left: 1px solid;
    }

    .border-grey {
        border-color: #C3C3C3;
    }

    .border-error {
        border-color: var(--mud-palette-error);
    }

    .flag-icon {
        width: 24px;
        height: 18px;
        object-fit: cover;
    }

    .form-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 16px;
        line-height: 18px;
        color: #000000;
        display: block;
        margin-bottom: 12px;
    }

    /* Mobile responsive styles */
    @@media (max-width: 768px) {
        .form-label {
            font-size: 14px;
            margin-bottom: 8px;
        }
    }

    @@media (max-width: 480px) {
        .form-label {
            font-size: 13px;
            margin-bottom: 6px;
        }

        .country-dropdown {
            height: 38px;
        }
    }
</style>

@code {
    [CascadingParameter] public EntityWizardContext<GroupModel> Wizard { get; set; } = default!;

    private bool IsCountryInvalid { get; set; } = false;

    private bool IsLogoEmpty { get; set; } = true;
    private bool ShowLogoError { get; set; } = false;

    private Margin margin = Margin.Dense;
    private MudForm? groupForm;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Wizard.CurrentStepValidation = ValidateStepAsync;

        }
    }

    private async Task<bool> ValidateStepAsync()
    {
        if (groupForm is null)
            return false;

        await groupForm.Validate();

        IsCountryInvalid = string.IsNullOrWhiteSpace(Wizard.Entity!.Country);

        ShowLogoError = IsLogoEmpty;

        await InvokeAsync(StateHasChanged);

        return groupForm.IsValid && !IsCountryInvalid;
        
        // && !IsLogoEmpty;
    }


    private List<CountryOption> _countryOptions = new();

    private CountryOption? SelectedCountry
    {
        get => _countryOptions.FirstOrDefault(c => c.Name == Wizard.Entity!.Country);
        set
        {
            var newName = value?.Name ?? string.Empty;

            if (Wizard.Entity!.Country == newName)
                return;

            Wizard.Entity.Country = newName;
            IsCountryInvalid = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await countryMetadataService.InitializeAsync();

        _countryOptions = countryMetadataService
            .GetAll()
            .OrderBy(c => c.Name, StringComparer.OrdinalIgnoreCase)
            .Select(c => new CountryOption
            {
                Code = c.ISO2,
                Name = c.Name,
                FlagUrl = $"/flags/{c.ISO2.ToLowerInvariant()}.svg"
            })
            .ToList();

        _countryOptions.Sort((x, y) => string.Compare(x.Name, y.Name));
    }

    private string GetPlaceholderFlagSvg()
    {
        return "/flags/default.svg";
    }

    private sealed class CountryOption
    {
        public string Code { get; init; } = string.Empty;
        public string Name { get; init; } = string.Empty;
        public string FlagUrl { get; init; } = string.Empty;
    }

    private bool IsFormValid()
    {
        if (Wizard.Entity == null) return false;
        return !string.IsNullOrWhiteSpace(Wizard.Entity.GroupName) &&
               !string.IsNullOrWhiteSpace(Wizard.Entity.AddressLine1) &&
               !string.IsNullOrWhiteSpace(Wizard.Entity.City) &&
               !string.IsNullOrWhiteSpace(Wizard.Entity.Country) &&
               !string.IsNullOrWhiteSpace(Wizard.Entity.PostalCode) &&
               HasValidLogo(Wizard.Entity.Logo);
    }

    private static bool HasValidLogo(ImageModel? logo)
    {
        if (logo == null) return true;
        return !string.IsNullOrWhiteSpace(logo.ContentBase64) ||
               (logo.Id != Guid.Empty && !string.IsNullOrWhiteSpace(logo.Url));
    }

    private void HandleBack()
    {
        Wizard.OnBack?.Invoke();
    }

    private async Task HandleNext()
    {
        if (Wizard.OnNext != null)
        {
            await Wizard.OnNext.Invoke();
        }
    }
}
