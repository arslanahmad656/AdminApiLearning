@page "/property/review-save"
@using System.Text.Json
@using Microsoft.JSInterop
@using Aro.UI.Application.DTOs
@using Aro.UI.Application.Interfaces
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IPropertyService PropertyService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@inject IErrorHandlingService ErrorHandler

<div class="wizard-layout">
    <!-- Header Bar -->
    <div class="col-12 card-bg-dark">
        <WizardHeader HeaderTitle="@Title"
                      OnClose="HandleClose" />
    </div>
    <div class="wizard-body">
        <!-- Sidebar Steps -->
        <div class="d-none d-md-block col-xl-2  border-end bg-white">
            <WizardSteps StepTitles="@stepTitles"
                         ActiveStepIndex="5" />
        </div>

        <!-- Review Content -->
        <div class="wizard-content scrollable-content">
            <p class="step-label">Step 6</p>
            <h2 class="content-title">Review & Save</h2>

            <!-- 1. Property Information -->
            <h3 class="review-section-title">1. PROPERTY INFORMATION</h3>
            <div class="review-grid">
                <div class="review-label">Property Name</div>
                <div class="review-value">@wizardModel.PropertyName</div>

                <div class="review-label">Property Code</div>
                <div class="review-value">Auto-generated on save</div>

                <div class="review-label">Property Type</div>
                <div class="review-value">@GetPropertyTypesDisplay()</div>

                <div class="review-label">Star Rating</div>
                <div class="review-value">@(wizardModel.StarRating > 0 ? $"{wizardModel.StarRating}-Star" : "Not selected")</div>

                <div class="review-label">Description</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Description) ? "Not provided" : wizardModel.Description)</div>
            </div>

            <!-- 2. Address & Primary Contact -->
            <h3 class="review-section-title">2. ADDRESS & PRIMARY CONTACT</h3>
            <div class="review-grid">
                <div class="review-label">Address Line 1</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.AddressLine1) ? "Not provided" : wizardModel.AddressLine1)</div>

                <div class="review-label">Address Line 2</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.AddressLine2) ? "Not provided" : wizardModel.AddressLine2)</div>

                <div class="review-label">City</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.City) ? "Not provided" : wizardModel.City)</div>

                <div class="review-label">Country</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Country) ? "Not provided" : wizardModel.Country)</div>

                <div class="review-label">Postal Code</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.PostalCode) ? "Not provided" : wizardModel.PostalCode)</div>

                <div class="review-label">Phone Number</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) ? "Not provided" : wizardModel.PhoneNumber)</div>

                <div class="review-label">Website URL</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Website) ? "Not provided" : wizardModel.Website)</div>

                <div class="review-label">Primary Contact Name</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.ContactName) ? "Not provided" : wizardModel.ContactName)</div>

                <div class="review-label">Primary Contact Email</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.ContactEmail) ? "Not provided" : wizardModel.ContactEmail)</div>

                <div class="review-label">Role</div>
                <div class="review-value">Property Manager</div>
            </div>

            <!-- 3. Key Selling Points -->
            <h3 class="review-section-title">3. KEY SELLING POINTS</h3>
            <div class="review-grid">
                <div class="review-label">Key Selling Points</div>
                <div class="review-value">
                    @if (wizardModel.KeySellingPoints != null && wizardModel.KeySellingPoints.Any())
                    {
                        @string.Join(", ", wizardModel.KeySellingPoints)
                    }
                    else
                    {
                        <span>Not provided</span>
                    }
                </div>
            </div>

            <!-- 4. Media Files -->
            <h3 class="review-section-title">4. MEDIA FILES</h3>
            @if (!HasAnyMediaFiles())
            {
                <div class="review-no-media">No media files added.</div>
            }
            else
            {
                <div class="media-files-grid">
                    @if (wizardModel.Banner1 != null && wizardModel.Banner1.HasData)
                    {
                        <div class="media-file-item">
                            <div class="media-preview">
                                <img src="@GetImageSrc(wizardModel.Banner1)" alt="Banner 1" />
                            </div>
                            <div class="media-file-name">@wizardModel.Banner1.FileName</div>
                            <div class="media-file-label">Page Banner</div>
                        </div>
                    }
                    @if (wizardModel.Banner2 != null && wizardModel.Banner2.HasData)
                    {
                        <div class="media-file-item">
                            <div class="media-preview">
                                <img src="@GetImageSrc(wizardModel.Banner2)" alt="Banner 2" />
                            </div>
                            <div class="media-file-name">@wizardModel.Banner2.FileName</div>
                            <div class="media-file-label">Additional Banner</div>
                        </div>
                    }
                    @if (wizardModel.Favicon != null && wizardModel.Favicon.HasData)
                    {
                        <div class="media-file-item">
                            <div class="media-preview favicon-preview">
                                <img src="@GetImageSrc(wizardModel.Favicon)" alt="Favicon" />
                            </div>
                            <div class="media-file-name">@wizardModel.Favicon.FileName</div>
                            <div class="media-file-label">Favicon</div>
                        </div>
                    }
                </div>
            }

            <!-- 5. Meta Title & Description -->
            <h3 class="review-section-title">5. META TITLE & DESCRIPTION</h3>
            <div class="review-grid">
                <div class="review-label">Meta Title</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.MarketingTitle) ? "Not provided" : wizardModel.MarketingTitle)</div>

                <div class="review-label">Meta Description</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.MarketingDescription) ? "Not provided" : wizardModel.MarketingDescription)</div>
            </div>

            <WizardFooter OnBack="GoBack"
                          OnSave="SaveProperty"
                          ShowSave="true"
                          BackDisabled="false"
                          SaveDisabled="@isSaving" />
        </div>
    </div>
</div>

@code {
    private readonly List<string> stepTitles = new()
    {
        "Property Information",
        "Address & Primary Contact",
        "Key Selling Points",
        "Media Files",
        "Marketing & SEO",
        "Review & Save"
    };
    private PropertyWizardModel wizardModel = new();
    private bool isSaving = false;
    private Guid? _currentGroupId = null;
    private Guid? _currentPropertyId = null;
    private string Title => $"{(wizardModel.IsEditMode ? "Edit" : "Add New")} Property";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private string GetStorageKey() => PropertyWizardModel.GetLocalStorageKey(_currentGroupId, _currentPropertyId);

    private async Task LoadFromLocalStorage()
    {
        try
        {
            // FIRST: Always try to get GroupId from SelectedGroupId in localStorage
            var groupIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "SelectedGroupId");
            if (!string.IsNullOrEmpty(groupIdStr) && Guid.TryParse(groupIdStr, out var parsedGroupId))
            {
                _currentGroupId = parsedGroupId;
            }

            // Get CurrentPropertyId for edit mode
            var propertyIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "CurrentPropertyId");
            if (!string.IsNullOrEmpty(propertyIdStr) && Guid.TryParse(propertyIdStr, out var parsedPropertyId))
            {
                _currentPropertyId = parsedPropertyId;
            }

            // Now load the wizard data with the correct storage key
            var storageKey = GetStorageKey();
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;

                    // Sync _currentGroupId from wizardModel if still not set
                    if (!_currentGroupId.HasValue && wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
                    {
                        _currentGroupId = wizardModel.GroupId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", _currentGroupId.Value.ToString());
                    }
                }
            }

            // Ensure wizardModel.GroupId is set
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private string GetPropertyTypesDisplay()
    {
        var types = wizardModel.PropertyTypes.ToList();
        return types.Any() ? string.Join(", ", types) : "Not selected";
    }

    private bool HasAnyMediaFiles()
    {
        return (wizardModel.Banner1 != null && wizardModel.Banner1.HasData) ||
               (wizardModel.Banner2 != null && wizardModel.Banner2.HasData) ||
               (wizardModel.Favicon != null && wizardModel.Favicon.HasData);
    }

    private string GetImageSrc(PropertyFileModel? file)
    {
        if (file == null || !file.HasData)
            return string.Empty;

        // Use GetDisplayUrl which handles both URL and Base64Data
        var displayUrl = file.GetDisplayUrl();

        // If it's already a URL (starts with http) or data URL, return as is
        if (displayUrl.StartsWith("http") || displayUrl.StartsWith("data:"))
            return displayUrl;

        // Otherwise, construct the data URL from Base64
        var contentType = string.IsNullOrEmpty(file.ContentType) ? "image/png" : file.ContentType;
        return $"data:{contentType};base64,{displayUrl}";
    }

    private void GoBack() => NavigationManager.NavigateTo("/property/marketing-seo");

    private async Task SaveProperty()
    {
        if (isSaving) return;
        isSaving = true;
        StateHasChanged();

        try
        {
            bool success = false;
            string successMessage = "";
            string errorMessage = "";

            if (wizardModel.IsEditMode && wizardModel.PropertyId.HasValue)
            {
                // Update existing property
                var updateResponse = await PropertyService.UpdatePropertyAsync(wizardModel);
                success = updateResponse != null;
                successMessage = "Property updated successfully!";
                errorMessage = "Failed to update property. Please try again.";
            }
            else
            {
                // Create new property
                var createResponse = await PropertyService.CreatePropertyAsync(wizardModel);
                success = createResponse != null;
                successMessage = "Property created successfully!";
                errorMessage = "Failed to create property. Please try again.";
            }

            if (success)
            {
                // Clear localStorage after successful save
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", GetStorageKey());
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "CurrentPropertyId");

                Snackbar.Add(successMessage, MudBlazor.Severity.Success);

                // Navigate to property list (ViewGroup page)
                var groupIdString = await JSRuntime.InvokeAsync<string>(
                            "localStorage.getItem",
                            "SelectedGroupId"
                        );

                if (string.IsNullOrWhiteSpace(groupIdString) ||
                    !Guid.TryParse(groupIdString, out var groupId))
                {
                    NavigationManager.NavigateTo("/");
                    return;
                }
                NavigationManager.NavigateTo($"/group/view/{groupId}");
            }
            else
            {
                Snackbar.Add(errorMessage, MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            var action = wizardModel.IsEditMode ? "updating" : "creating";
            ErrorHandler.ShowError(ex, $"An error occurred while {action} the property. Please try again.");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private bool HasWizardProgress()
    {
        // Check if the wizard has any meaningful data that would be lost
        return !string.IsNullOrWhiteSpace(wizardModel.PropertyName) ||
               !string.IsNullOrWhiteSpace(wizardModel.AddressLine1);
    }

    private async Task HandleClose()
    {
        // Check if wizard has progress that would be lost
        // On the final review step, we always have progress if we got here
        if (!HasWizardProgress())
        {
            await CloseAndNavigate();
            return;
        }

        // Show Unsaved Changes modal
        var parameters = new DialogParameters
        {
            { "ShowSaveAndContinue", false }
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.Small,
        };

        var dialog = await DialogService.ShowAsync<UnsavedChangesModal>(
            "Unsaved Changes",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (result == null || result.Canceled)
            return;

        var action = (UnsavedChangesModal.UnsavedChangesResult)result.Data!;

        switch (action)
        {
            case UnsavedChangesModal.UnsavedChangesResult.Discard:
                await CloseAndNavigate();
                break;

            case UnsavedChangesModal.UnsavedChangesResult.Cancel:
                // Do nothing
                break;
        }
    }

    private async Task CloseAndNavigate()
    {
        var groupIdString = await JSRuntime.InvokeAsync<string>(
            "localStorage.getItem",
            "SelectedGroupId"
        );

        if (string.IsNullOrWhiteSpace(groupIdString) ||
            !Guid.TryParse(groupIdString, out var groupId))
        {
            return;
        }

        var storageKey = GetStorageKey();
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", storageKey);
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "CurrentPropertyId");

        NavigationManager.NavigateTo($"/group/view/{groupId}");
    }
}
<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .card-bg-dark {
        background-color: #434343;
        color: white;
    }

    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin-bottom: 24px;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        background: #FFFFFF;
        border: 1px solid #FF931E;
    }

    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    /*   .wizard-step.active .step-line {
                        background: #D9D9D9;
                    }  */

    .wizard-step:last-child .step-line {
        background: #FFFF;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */

    .wizard-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #F6F6F6;
        padding: 48px !important;
        overflow-x: hidden;
        overflow-y: auto;
    }

    /* Matches styling in other steps */
    .instruction-text {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #737373;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 24px;
        width: 50%;
    }

        .form-group label {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin-bottom: 8px;
        }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .form-control {
        font-size: 16px;
        padding: 12px;
        border: 1px solid #C3C3C3;
        border-radius: 4px;
        background-color: #F6F6F6;
        resize: none;
    }

        .form-control:focus {
            border-color: black;
            outline: none;
            background-color: #F6F6F6;
            box-shadow: none;
        }

    .form-group p {
        font-size: 12px;
        color: #737373;
        margin: 4px 0 8px 0;
        text-align: left;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin-bottom: 40px !important;
    }

    .character-label {
        text-align: left;
    }
    /* Responsive Fix */
    @@media (max-width: 768px) {
        .wizard-content {
            padding: 40px 20px;
        }

        .form-control {
            font-size: 14px;
        }

        .form-group label {
            font-size: 14px;
        }
    }

    .review-section {
        margin-bottom: 48px;
    }

    .review-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        row-gap: 16px;
        column-gap: 40px;
        margin-bottom: 32px;
    }

    .review-section-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 500;
        font-size: 16px;
        color: #000000;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .review-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #707070;
        line-height: 24px;
    }

    .review-value {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        line-height: 24px;
        word-break: break-word;
    }

    /* Media Files Section */
    .review-no-media {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #707070;
        margin-bottom: 32px;
        font-style: italic;
    }

    .media-files-grid {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        margin-bottom: 32px;
    }

    .media-file-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .media-preview {
        width: 150px;
        height: 100px;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        overflow: hidden;
        background: #F5F5F5;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .media-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .media-preview.favicon-preview {
            width: 64px;
            height: 64px;
        }

            .media-preview.favicon-preview img {
                width: 32px;
                height: 32px;
                object-fit: contain;
            }

    .media-file-name {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 14px;
        color: #000000;
        text-align: center;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .media-file-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 12px;
        color: #707070;
        text-align: center;
    }

    .wizard-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 40px;
    }

    /* .btn-back {
            border: 1px solid #ccc;
            padding: 10px 20px;
            background: white;
            cursor: pointer;
        }

        .btn-save {
            background: #FF931E;
            color: white;
            padding: 10px 24px;
            border: none;
            cursor: pointer;
        } */

    .scrollable-content {
        max-height: calc(130vh - 350px); /* Adjust based on your header/footer */
        overflow-y: auto;
        overflow-x: hidden; /* ✅ removes bottom bar */
        padding-right: 24px;
        scrollbar-width: thin;
        scrollbar-color: #aaa transparent;
    }

    /* Optional: Custom scrollbar for WebKit */
    /* .scrollable-content::-webkit-scrollbar {
                width: 8px;
            } */

    /* .scrollable-content::-webkit-scrollbar-thumb {
                background-color: #ccc;
                border-radius: 4px;
            } */

    /* .scrollable-content::-webkit-scrollbar-track {
                background-color: transparent;
            } */
</style>
