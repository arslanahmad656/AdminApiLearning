@page "/property/review-save"
@using System.Text.Json
@using Microsoft.JSInterop
@using Aro.UI.Application.DTOs
@using Aro.UI.Application.Interfaces
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IPropertyService PropertyService
@inject ISnackbar Snackbar
@inject IErrorHandlingService ErrorHandler

<div class="wizard-layout">
    <!-- Header Bar -->
    <div class="wizard-header">
        <h1 class="header-title">Create New Property</h1>
        <div class="close-icon" @onclick="HandleClose">
            <svg width="17" height="17" viewBox="0 0 17 17" fill="none">
                <line x1="1" y1="1" x2="16" y2="16" stroke="white" stroke-width="2" />
                <line x1="16" y1="1" x2="1" y2="16" stroke="white" stroke-width="2" />
            </svg>
        </div>
    </div>
    <div class="wizard-body">
        <!-- Sidebar Steps -->
        <div class="wizard-sidebar">
            @for (int i = 0; i < Steps.Length; i++)
            {
                <div class="wizard-step @(i == 5 ? "active" : "completed")">
                    <div class="step-indicator">
                        <div class="step-number">
                            @if (i < 5)
                            {
                                <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                    <path d="M1 5L6 10L15 1" stroke="white" stroke-width="2" />
                                </svg>
                            }
                            else
                            {
                                @($"{i + 1}")
                            }
                        </div>
                        @if (i < Steps.Length - 1)
                        {
                            <div class="step-line"></div>
                        }
                    </div>
                    <div class="step-title">@Steps[i]</div>
                </div>
            }
        </div>

        <!-- Review Content -->
        <div class="wizard-content scrollable-content">
            <p class="step-label">Step 6</p>
            <h2 class="content-title">Review & Save</h2>

            <!-- 1. Property Information -->
            <h3 class="review-section-title">1. PROPERTY INFORMATION</h3>
            <div class="review-grid">
                <div class="review-label">Property Name</div>
                <div class="review-value">@wizardModel.PropertyName</div>

                <div class="review-label">Property Code</div>
                <div class="review-value">Auto-generated on save</div>

                <div class="review-label">Property Type</div>
                <div class="review-value">@GetPropertyTypesDisplay()</div>

                <div class="review-label">Star Rating</div>
                <div class="review-value">@(wizardModel.StarRating > 0 ? $"{wizardModel.StarRating}-Star" : "Not selected")</div>

                <div class="review-label">Description</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Description) ? "Not provided" : wizardModel.Description)</div>
            </div>

            <!-- 2. Address & Primary Contact -->
            <h3 class="review-section-title">2. ADDRESS & PRIMARY CONTACT</h3>
            <div class="review-grid">
                <div class="review-label">Address Line 1</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.AddressLine1) ? "Not provided" : wizardModel.AddressLine1)</div>

                <div class="review-label">Address Line 2</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.AddressLine2) ? "Not provided" : wizardModel.AddressLine2)</div>

                <div class="review-label">City</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.City) ? "Not provided" : wizardModel.City)</div>

                <div class="review-label">Country</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Country) ? "Not provided" : wizardModel.Country)</div>

                <div class="review-label">Postal Code</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.PostalCode) ? "Not provided" : wizardModel.PostalCode)</div>

                <div class="review-label">Phone Number</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) ? "Not provided" : wizardModel.PhoneNumber)</div>

                <div class="review-label">Website URL</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.Website) ? "Not provided" : wizardModel.Website)</div>

                <div class="review-label">Primary Contact Name</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.ContactName) ? "Not provided" : wizardModel.ContactName)</div>

                <div class="review-label">Primary Contact Email</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.ContactEmail) ? "Not provided" : wizardModel.ContactEmail)</div>

                <div class="review-label">Role</div>
                <div class="review-value">Property Manager</div>
            </div>

            <!-- 3. Key Selling Points -->
            <h3 class="review-section-title">3. KEY SELLING POINTS</h3>
            <div class="review-grid">
                <div class="review-label">Key Selling Points</div>
                <div class="review-value">
                    @if (wizardModel.KeySellingPoints != null && wizardModel.KeySellingPoints.Any())
                    {
                        @string.Join(", ", wizardModel.KeySellingPoints)
                    }
                    else
                    {
                        <span>Not provided</span>
                    }
                </div>
            </div>

            <!-- 4. Media Files -->
            <h3 class="review-section-title">4. MEDIA FILES</h3>
            <div class="review-grid">
                <div class="review-label">Banner 1</div>
                <div class="review-value">@(wizardModel.Banner1?.FileName ?? "Not uploaded")</div>

                <div class="review-label">Banner 2</div>
                <div class="review-value">@(wizardModel.Banner2?.FileName ?? "Not uploaded")</div>

                <div class="review-label">Favicon</div>
                <div class="review-value">@(wizardModel.Favicon?.FileName ?? "Not uploaded")</div>
            </div>

            <!-- 5. Meta Title & Description -->
            <h3 class="review-section-title">5. META TITLE & DESCRIPTION</h3>
            <div class="review-grid">
                <div class="review-label">Meta Title</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.MarketingTitle) ? "Not provided" : wizardModel.MarketingTitle)</div>

                <div class="review-label">Meta Description</div>
                <div class="review-value">@(string.IsNullOrWhiteSpace(wizardModel.MarketingDescription) ? "Not provided" : wizardModel.MarketingDescription)</div>
            </div>

            <WizardFooter OnBack="GoBack"
                          OnSave="SaveProperty"
                          ShowSave="true"
                          BackDisabled="false"
                          SaveDisabled="@isSaving" />
        </div>
    </div>
</div>

@code {
    private string[] Steps = new[]
    {
        "Property Information",
        "Address & Primary Contact",
        "Key Selling Points",
        "Media Files",
        "Meta Title & Description",
        "Review & Save"
    };

    private PropertyWizardModel wizardModel = new();
    private bool isSaving = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private async Task LoadFromLocalStorage()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", PropertyWizardModel.LocalStorageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;
                }
            }
        }
        catch
        {
            // Silent fail - localStorage errors are not critical
        }
    }

    private string GetPropertyTypesDisplay()
    {
        var types = wizardModel.PropertyTypes.ToList();
        return types.Any() ? string.Join(", ", types) : "Not selected";
    }

    private void GoBack() => NavigationManager.NavigateTo("/property/marketing-seo");

    private async Task SaveProperty()
    {
        if (isSaving) return;
        isSaving = true;
        StateHasChanged();

        try
        {
            var response = await PropertyService.CreatePropertyAsync(wizardModel);

            if (response != null)
            {
                // Clear localStorage after successful save
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", PropertyWizardModel.LocalStorageKey);

                Snackbar.Add("Property created successfully!", MudBlazor.Severity.Success);

                // Navigate to property list or dashboard
                NavigationManager.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("Failed to create property. Please try again.", MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            ErrorHandler.ShowError(ex, "An error occurred while creating the property. Please try again.");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task HandleClose()
    {
        NavigationManager.NavigateTo("/");
    }
}
<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin: 0;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        border: 1px solid #FF931E;
    }

    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    /*   .wizard-step.active .step-line {
                    background: #D9D9D9;
                }  */

    .wizard-step:last-child .step-line {
        background: #FFFF;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */

    .wizard-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #F6F6F6;
        padding: 60px 80px;
        overflow-y: auto;
    }

    /* Matches styling in other steps */
    .instruction-text {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #737373;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 24px;
        width: 50%;
    }

        .form-group label {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin-bottom: 8px;
        }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .form-control {
        font-size: 16px;
        padding: 12px;
        border: 1px solid #C3C3C3;
        border-radius: 4px;
        background-color: #F6F6F6;
        resize: none;
    }

        .form-control:focus {
            border-color: black;
            outline: none;
            background-color: #F6F6F6;
            box-shadow: none;
        }

    .form-group p {
        font-size: 12px;
        color: #737373;
        margin: 4px 0 8px 0;
        text-align: left;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin-bottom: 20px;
    }

    .character-label {
        text-align: left;
    }
    /* Responsive Fix */
    @@media (max-width: 768px) {
        .wizard-content {
            padding: 40px 20px;
        }

        .form-control {
            font-size: 14px;
        }

        .form-group label {
            font-size: 14px;
        }
    }

    .review-section {
        margin-bottom: 48px;
    }

    .review-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        row-gap: 16px;
        column-gap: 40px;
        margin-bottom: 32px;
    }

    .review-section-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        margin-top: 32px;
        color: #000000;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .review-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #707070;
        line-height: 24px;
    }

    .review-value {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        line-height: 24px;
        word-break: break-word;
    }
    .wizard-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 40px;
    }

    /* .btn-back {
        border: 1px solid #ccc;
        padding: 10px 20px;
        background: white;
        cursor: pointer;
    }

    .btn-save {
        background: #FF931E;
        color: white;
        padding: 10px 24px;
        border: none;
        cursor: pointer;
    } */

    .scrollable-content {
        max-height: calc(130vh - 380px); /* Adjust based on your header/footer */
        overflow-y: auto;
        padding-right: 40px;
        scrollbar-width: thin;
        scrollbar-color: #aaa transparent;
    }

        /* Optional: Custom scrollbar for WebKit */
        /* .scrollable-content::-webkit-scrollbar {
            width: 8px;
        } */

        /* .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        } */

        /* .scrollable-content::-webkit-scrollbar-track {
            background-color: transparent;
        } */
</style>
