@page "/property/address-contact"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text.RegularExpressions
@using Aro.UI.Application.DTOs.Group
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using MudBlazor
@using Aro.UI.Application.DTOs
@using Aro.UI.Infrastructure.Services
@using Aro.Admin.Presentation.UI.Services
@using Aro.Admin.Presentation.UI.Shared
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IGroupService GroupService
@inject ICountryMetadataService CountryMetadataService
@inject IDialogService DialogService
@inject IUserService UserService
@inject IWizardNavigationService WizardNavigationService

<div class="property-wizard-container">
    <!-- Header Bar -->
    <div class="col-12 card-bg-dark">
        <WizardHeader HeaderTitle="@Title"
                      OnClose="HandleClose" />
    </div>

    <div class="wizard-body">
        <!-- Left Sidebar with Steps -->
        <div class="d-none d-md-block col-xl-2  border-end bg-white">
            <WizardSteps StepTitles="@stepTitles"
                         ActiveStepIndex="1"
                         IsEditMode="@wizardModel.IsEditMode"
                         OnStepClick="HandleStepClick" />
        </div>

        <!-- Main Content Area -->
        <div class="wizard-content">
            <div class="content-header">
                <p class="step-label">Step 2</p>
                <h2 class="content-title">Property Address</h2>
            </div>

            <MudForm @ref="form" Class="address-form">
                <!-- Set the same as Primary Checkbox - Simple inline -->
                <div class="checkbox-simple">
                    <input type="checkbox" id="sameAsPrimary" @bind="wizardModel.SetAddressSameAsGroupAddress" @bind:after="OnSameAsPrimaryChanged" />
                    <label for="sameAsPrimary" class="checkbox-label-simple">Set the same as the group address</label>
                </div>

                <!-- Primary Address and Secondary Address Row -->
                <div class="address-row-container">
                    <div class="address-column-left">
                        <div class="label-group">
                            <label class="form-label">Address Line 1 *</label>
                        </div>
                        <MudTextField T="string"
                                      Value="wizardModel.AddressLine1"
                                      ValueChanged="OnAddressLine1Changed"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsAddressLine1Invalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsAddressLine1Invalid"
                                      ErrorText="Address Line 1 is required"
                                      Placeholder="Enter address line 1"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetAddressSameAsGroupAddress"
                                      @onfocus="OnAddressLine1Focus"
                                      @onblur="OnAddressLine1Blur" />
                    </div>
                    <div class="address-column-right">
                        <div class="label-group-right">
                            <label class="form-label">Address Line 2</label>
                        </div>
                        <MudTextField @bind-Value="wizardModel.AddressLine2"
                                      Variant="Variant.Text"
                                      Class="form-input"
                                      HelperText=""
                                      HelperTextOnFocus="false"
                                      Immediate="true"
                                      Placeholder="Enter address line 2"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetAddressSameAsGroupAddress" />
                    </div>
                </div>

                <!-- City, Country, Postal Code Row -->
                <div class="form-row-three-col">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.City"
                                      ValueChanged="OnCityChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsCityInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsCityInvalid"
                                      ErrorText="City is required"
                                      Placeholder="Enter city"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetAddressSameAsGroupAddress"
                                      @onfocus="OnCityFocus"
                                      @onblur="OnCityBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <div class="@($"country-select-wrapper {(IsCountryInvalid ? "input-error-border" : "")}")" @onfocusin="OnCountryFocus" @onfocusout="OnCountryBlur">
                            <div class="country-flag">
                                <img src="@GetCountryFlagUrl(wizardModel.Country)" alt="Country Flag" class="flag-icon" />
                            </div>
                            <MudAutocomplete T="string"
                                             Value="wizardModel.Country"
                                             ValueChanged="OnCountryChanged"
                                             SearchFunc="@SearchCountries"
                                             Placeholder="Search or select country"
                                             Variant="Variant.Text"
                                             Class="country-mud-select"
                                             DisableUnderLine="true"
                                             Dense="true"
                                             ShowProgressIndicator="true"
                                             MaxItems="null"
                                             MinCharacters="0"
                                             CoerceText="false"
                                             CoerceValue="false"
                                             ResetValueOnEmptyText="true"
                                             SelectOnClick="true"
                                             Disabled="@wizardModel.SetAddressSameAsGroupAddress" />
                        </div>
                        @if (IsCountryInvalid)
                        {
                            <div class="validation-error-text">Country is required</div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postal Code *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.PostalCode"
                                      ValueChanged="OnPostalCodeChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsPostalCodeInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsPostalCodeInvalid"
                                      ErrorText="Postal Code is required"
                                      Placeholder="Enter postal code"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetAddressSameAsGroupAddress"
                                      @onfocus="OnPostalCodeFocus"
                                      @onblur="OnPostalCodeBlur" />
                    </div>
                </div>

                <!-- Phone Number and Website URL Row -->
                <div class="form-row-two-col-custom">
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <div class="@($"phone-input-wrapper {(IsPhoneNumberInvalid ? "input-error-border" : "")}")" @onfocusin="OnPhoneNumberFocus" @onfocusout="OnPhoneNumberBlur">
                            <div class="phone-country-flag">
                                <img src="@GetFlagUrlByCountryCode(wizardModel.PhoneCountryCode, _phoneCountryName)" alt="Country Flag" class="flag-icon-small" />
                            </div>
                            <select class="phone-country-code-select" value="@wizardModel.PhoneCountryCode" @onchange="OnPhoneCountryCodeChanged" disabled="@wizardModel.SetContactSameAsPrimaryContact">
                                <option value="">--</option>
                                @if (countryCodes != null)
                                {
                                    @foreach (var countryCode in countryCodes)
                                    {
                                        <option value="@countryCode">+@countryCode</option>
                                    }
                                }
                            </select>
                            <div class="phone-divider"></div>
                            <input type="tel"
                                   class="phone-number-input"
                                   @bind="wizardModel.PhoneNumber"
                                   @bind:event="oninput"
                                   @bind:after="OnPhoneNumberChanged"
                                   onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 0"
                                   placeholder="Enter phone number"
                                   pattern="[0-9]*"
                                   inputmode="numeric"
                                   maxlength="@GetPhoneNumberMaxLength()"
                                   readonly="@wizardModel.SetContactSameAsPrimaryContact" />
                        </div>
                        @if (IsPhoneNumberInvalid)
                        {
                            <div class="validation-error-text">@GetPhoneNumberErrorMessage()</div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website URL *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.Website"
                                      ValueChanged="OnWebsiteChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsWebsiteInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsWebsiteInvalid"
                                      ErrorText="@GetWebsiteErrorMessage()"
                                      Placeholder="https://example.com"
                                      DisableUnderLine="true"
                                      @onfocus="OnWebsiteFocus"
                                      @onblur="OnWebsiteBlur" />
                    </div>
                </div>

                <!-- Primary Contact Section -->
                <div class="section-divider"></div>

                <h2 class="section-title">Primary contact</h2>

                <!-- Set the same as client primary contact Checkbox - Simple inline -->
                <div class="checkbox-simple">
                    <input type="checkbox" id="sameAsClient" @bind="wizardModel.SetContactSameAsPrimaryContact" @bind:after="OnSameAsClientChanged" />
                    <label for="sameAsClient" class="checkbox-label-simple">Set the same as the group primary contact</label>
                </div>

                <!-- Primary Contact Name, Email, Role Row -->
                <div class="form-row-three-col">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.ContactName"
                                      ValueChanged="OnContactNameChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsContactNameInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsContactNameInvalid"
                                      ErrorText="Name is required"
                                      Placeholder="Enter contact name"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetContactSameAsPrimaryContact"
                                      @onfocus="OnContactNameFocus"
                                      @onblur="OnContactNameBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.ContactEmail"
                                      ValueChanged="OnContactEmailChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsContactEmailInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsContactEmailInvalid"
                                      ErrorText="@GetEmailErrorMessage()"
                                      Placeholder="example@domain.com"
                                      DisableUnderLine="true"
                                      Disabled="@wizardModel.SetContactSameAsPrimaryContact"
                                      @onfocus="OnContactEmailFocus"
                                      @onblur="OnContactEmailBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <div class="role-display-wrapper">
                            <div class="role-display">
                                <span class="role-text">Property Manager</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" class="role-icon">
                                    <path d="M1 1L6 6L11 1" stroke="#707070" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <p class="role-helper-text">Allocated by default, can't be changed.</p>
                        </div>
                    </div>
                </div>
            </MudForm>
            <!-- Footer with Buttons -->
            <WizardFooter OnBack="HandleBack"
                          OnNext="HandleNext"
                          OnSave="HandleSave"
                          BackDisabled="false"
                          NextDisabled="@(!IsFormValid())"
                          ShowSave="@wizardModel.IsEditMode" />
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private PropertyWizardModel wizardModel = new();
    private bool showValidation = false;
    private IEnumerable<string>? countryNames;
    private IEnumerable<string>? countryCodes;
    private Guid? _currentGroupId = null;
    private Guid? _currentPropertyId = null;
    private string _originalStateHash = string.Empty;
    private string Title => $"{(wizardModel.IsEditMode ? "Edit" : "Add New")} Property";
    private string? _phoneCountryName;
    private string? _originalContactEmail;

    private readonly List<string> stepTitles = new()
    {
        "Property Information",
        "Address & Primary Contact",
        "Key Selling Points",
        "Media Files",
        "Marketing & SEO",
        "Review & Save"
    };

    private readonly string[] stepRoutes = new[]
    {
        "/property/information",
        "/property/address-contact",
        "/property/key-selling-points",
        "/property/media-files",
        "/property/marketing-seo",
        "/property/review-save"
    };

    // Track if field has been interacted with (focused then blurred)
    private bool addressLine1Touched = false;
    private bool cityTouched = false;
    private bool countryTouched = false;
    private bool postalCodeTouched = false;
    private bool phoneNumberTouched = false;
    private bool websiteTouched = false;
    private bool contactNameTouched = false;
    private bool contactEmailTouched = false;

    // Track if field is currently focused (to hide error while editing)
    private bool addressLine1Focused = false;
    private bool cityFocused = false;
    private bool countryFocused = false;
    private bool postalCodeFocused = false;
    private bool phoneNumberFocused = false;
    private bool websiteFocused = false;
    private bool contactNameFocused = false;
    private bool contactEmailFocused = false;
    private bool contactEmailAlreadyExists = false;

    // Focus handlers - hide error while editing
    private void OnAddressLine1Focus() { addressLine1Focused = true; StateHasChanged(); }
    private void OnCityFocus() { cityFocused = true; StateHasChanged(); }
    private void OnCountryFocus() { countryFocused = true; StateHasChanged(); }
    private void OnPostalCodeFocus() { postalCodeFocused = true; StateHasChanged(); }
    private void OnPhoneNumberFocus() { phoneNumberFocused = true; StateHasChanged(); }
    private void OnWebsiteFocus() { websiteFocused = true; StateHasChanged(); }
    private void OnContactNameFocus() { contactNameFocused = true; StateHasChanged(); }
    private void OnContactEmailFocus() { contactEmailFocused = true; StateHasChanged(); }

    // Blur handlers - mark as touched and show error when leaving field empty
    // Using async with Task.Yield() to ensure value binding completes before validation
    private async Task OnAddressLine1Blur() { await Task.Yield(); addressLine1Focused = false; addressLine1Touched = true; StateHasChanged(); }
    private async Task OnCityBlur() { await Task.Yield(); cityFocused = false; cityTouched = true; StateHasChanged(); }
    private async Task OnCountryBlur() { await Task.Yield(); countryFocused = false; countryTouched = true; StateHasChanged(); }
    private async Task OnPostalCodeBlur() { await Task.Yield(); postalCodeFocused = false; postalCodeTouched = true; StateHasChanged(); }
    private async Task OnPhoneNumberBlur() { await Task.Yield(); phoneNumberFocused = false; phoneNumberTouched = true; StateHasChanged(); }
    private async Task OnWebsiteBlur() { await Task.Yield(); websiteFocused = false; websiteTouched = true; StateHasChanged(); }
    private async Task OnContactNameBlur() { await Task.Yield(); contactNameFocused = false; contactNameTouched = true; StateHasChanged(); }
    private async Task OnContactEmailBlur()
    {
        await Task.Yield();
        contactEmailFocused = false;
        contactEmailTouched = true;
        if (!string.IsNullOrEmpty(wizardModel.ContactEmail))
        {
            wizardModel.ContactEmail = wizardModel.ContactEmail.Trim();
        }

        contactEmailAlreadyExists = false;
        if (!string.IsNullOrWhiteSpace(wizardModel.ContactEmail) && IsValidEmail(wizardModel.ContactEmail))
        {
            if (wizardModel.IsEditMode && !string.IsNullOrWhiteSpace(_originalContactEmail) &&
                string.Equals(wizardModel.ContactEmail, _originalContactEmail, StringComparison.OrdinalIgnoreCase))
            {
                contactEmailAlreadyExists = false;
            }
            else
            {
                try
                {
                    contactEmailAlreadyExists = await UserService.UserEmailExists(new GetUserByEmailRequest(wizardModel.ContactEmail));
                }
                catch
                {
                }
            }
        }
        StateHasChanged();
    }

    // Value change handlers
    private void OnAddressLine1Changed(string? newValue) { wizardModel.AddressLine1 = newValue; }
    private void OnCityChanged(string? newValue) { wizardModel.City = newValue; }
    private void OnPostalCodeChanged(string? newValue) { wizardModel.PostalCode = newValue; }
    private void OnWebsiteChanged(string? newValue) { wizardModel.Website = newValue; }
    private void OnContactNameChanged(string? newValue) { wizardModel.ContactName = newValue; }
    private void OnContactEmailChanged(string? newValue) { wizardModel.ContactEmail = newValue; contactEmailAlreadyExists = false; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load country names and codes from service
            await CountryMetadataService.InitializeAsync();
            countryNames = CountryMetadataService.GetAllCountryNames();
            countryCodes = CountryMetadataService.GetAllCountryCodes();

            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private string GetStorageKey() => PropertyWizardModel.GetLocalStorageKey(_currentGroupId, _currentPropertyId);

    private string ComputeCurrentStateHash()
    {
        return $"{wizardModel.SetAddressSameAsGroupAddress}|{wizardModel.AddressLine1}|{wizardModel.AddressLine2}|{wizardModel.City}|{wizardModel.Country}|{wizardModel.PostalCode}|{wizardModel.PhoneCountryCode}|{wizardModel.PhoneNumber}|{wizardModel.Website}|{wizardModel.SetContactSameAsPrimaryContact}|{wizardModel.ContactName}|{wizardModel.ContactEmail}";
    }

    private bool HasUnsavedChanges() => _originalStateHash != ComputeCurrentStateHash();

    private bool HasWizardProgress()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.PropertyName) ||
               !string.IsNullOrWhiteSpace(wizardModel.AddressLine1) ||
               !string.IsNullOrWhiteSpace(wizardModel.City) ||
               !string.IsNullOrWhiteSpace(wizardModel.Country) ||
               !string.IsNullOrWhiteSpace(wizardModel.ContactName) ||
               !string.IsNullOrWhiteSpace(wizardModel.ContactEmail);
    }

    private async Task LoadFromLocalStorage()
    {
        try
        {
            // Get GroupId from localStorage
            var groupIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "SelectedGroupId");
            if (!string.IsNullOrEmpty(groupIdStr) && Guid.TryParse(groupIdStr, out var parsedGroupId))
            {
                _currentGroupId = parsedGroupId;
            }

            // Get PropertyId from localStorage (for edit mode)
            var propertyIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "CurrentPropertyId");
            if (!string.IsNullOrEmpty(propertyIdStr) && Guid.TryParse(propertyIdStr, out var parsedPropertyId))
            {
                _currentPropertyId = parsedPropertyId;
            }

            // Load the wizard data with the correct storage key (create vs edit)
            var storageKey = GetStorageKey();
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;

                    // Sync _currentGroupId from wizardModel if still not set
                    if (!_currentGroupId.HasValue && wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
                    {
                        _currentGroupId = wizardModel.GroupId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", _currentGroupId.Value.ToString());
                    }

                    // Sync _currentPropertyId from wizardModel if in edit mode
                    if (!_currentPropertyId.HasValue && wizardModel.PropertyId.HasValue && wizardModel.PropertyId.Value != Guid.Empty)
                    {
                        _currentPropertyId = wizardModel.PropertyId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "CurrentPropertyId", _currentPropertyId.Value.ToString());
                    }
                }
            }

            // Ensure wizardModel.GroupId is set
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Parse phone number to extract country code if in format "+XX XXXXXXX"
            // This handles data loaded from API where phone number includes country code
            if (!string.IsNullOrEmpty(wizardModel.PhoneNumber) && string.IsNullOrEmpty(wizardModel.PhoneCountryCode))
            {
                var (countryCode, phoneNumber) = ParsePhoneNumber(wizardModel.PhoneNumber);
                if (!string.IsNullOrEmpty(countryCode))
                {
                    wizardModel.PhoneCountryCode = countryCode;
                    wizardModel.PhoneNumber = phoneNumber;
                }
            }

            // Sanitize phone number in case invalid data was stored
            if (!string.IsNullOrEmpty(wizardModel.PhoneNumber))
            {
                wizardModel.PhoneNumber = SanitizePhoneNumber(wizardModel.PhoneNumber);
            }

            if (!string.IsNullOrWhiteSpace(wizardModel.PhoneCountryCode))
            {
                var country = CountryMetadataService.GetByCountryCode(wizardModel.PhoneCountryCode);
                _phoneCountryName = country?.Name;
            }
            else
            {
                _phoneCountryName = null;
            }

            // In edit mode, compare property data with group data to determine checkbox states
            if (wizardModel.IsEditMode && _currentGroupId.HasValue)
            {
                await CompareWithGroupDataAsync();
                _originalContactEmail = wizardModel.ContactEmail;
            }

            _originalStateHash = ComputeCurrentStateHash();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private async Task SaveToLocalStorage()
    {
        try
        {
            // Ensure GroupId is preserved
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Always ensure SelectedGroupId is saved for subsequent pages
            if (wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", wizardModel.GroupId.Value.ToString());
                _currentGroupId = wizardModel.GroupId;
            }

            wizardModel.CurrentStep = 2;
            var storageKey = GetStorageKey();
            var json = JsonSerializer.Serialize(wizardModel);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, json);
            _originalStateHash = ComputeCurrentStateHash();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    // Regex patterns for validation
    private static readonly Regex PhoneNumberRegex = new Regex(@"^\d+$", RegexOptions.Compiled);
    private static readonly Regex EmailRegex = new Regex(@"^[^@\s]+@[^@\s]+\.[^@\s]+$", RegexOptions.Compiled | RegexOptions.IgnoreCase);
    private static readonly Regex UrlRegex = new Regex(@"^(https?:\/\/)?(www\.)?[a-zA-Z0-9][a-zA-Z0-9\-]*\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?(\/[\w\-._~:/?#\[\]@!$&'()*+,;=]*)?$", RegexOptions.Compiled | RegexOptions.IgnoreCase);

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.AddressLine1) &&
               !string.IsNullOrWhiteSpace(wizardModel.City) &&
               !string.IsNullOrWhiteSpace(wizardModel.Country) &&
               !string.IsNullOrWhiteSpace(wizardModel.PostalCode) &&
               !string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) &&
               IsValidPhoneNumber(wizardModel.PhoneNumber) &&
               !string.IsNullOrWhiteSpace(wizardModel.Website) &&
               IsValidUrl(wizardModel.Website) &&
               !string.IsNullOrWhiteSpace(wizardModel.ContactName) &&
               !string.IsNullOrWhiteSpace(wizardModel.ContactEmail) &&
               IsValidEmail(wizardModel.ContactEmail) &&
               !contactEmailAlreadyExists;
    }

    // Format validation methods
    private bool IsValidPhoneNumber(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
            return false;
        if (!PhoneNumberRegex.IsMatch(phone))
            return false;

        if (!string.IsNullOrWhiteSpace(wizardModel.PhoneCountryCode))
        {
            return CountryMetadataService.ValidateTelephone(wizardModel.PhoneCountryCode, phone);
        }

        return phone.Length >= 7 && phone.Length <= 15;
    }
    private bool IsValidEmail(string? email) => !string.IsNullOrWhiteSpace(email) && EmailRegex.IsMatch(email.Trim());
    private bool IsValidUrl(string? url) => !string.IsNullOrWhiteSpace(url) && UrlRegex.IsMatch(url);

    // Validation helper methods - show error when:
    // 1. Field is NOT currently focused (hide error while editing), AND
    // 2. Field is empty/invalid, AND
    // 3. Field was touched (focused then blurred) OR user clicked Next (showValidation)
    private bool IsAddressLine1Invalid => !addressLine1Focused && string.IsNullOrWhiteSpace(wizardModel.AddressLine1) && (showValidation || addressLine1Touched);
    private bool IsCityInvalid => !cityFocused && string.IsNullOrWhiteSpace(wizardModel.City) && (showValidation || cityTouched);
    private bool IsCountryInvalid => !countryFocused && string.IsNullOrWhiteSpace(wizardModel.Country) && (showValidation || countryTouched);
    private bool IsPostalCodeInvalid => !postalCodeFocused && string.IsNullOrWhiteSpace(wizardModel.PostalCode) && (showValidation || postalCodeTouched);
    private bool IsPhoneNumberInvalid => !phoneNumberFocused && (string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) || !IsValidPhoneNumber(wizardModel.PhoneNumber)) && (showValidation || phoneNumberTouched);
    private bool IsWebsiteInvalid => !websiteFocused && (string.IsNullOrWhiteSpace(wizardModel.Website) || !IsValidUrl(wizardModel.Website)) && (showValidation || websiteTouched);
    private bool IsContactNameInvalid => !contactNameFocused && string.IsNullOrWhiteSpace(wizardModel.ContactName) && (showValidation || contactNameTouched);
    private bool IsContactEmailInvalid => !contactEmailFocused && (string.IsNullOrWhiteSpace(wizardModel.ContactEmail) || !IsValidEmail(wizardModel.ContactEmail) || contactEmailAlreadyExists) && (showValidation || contactEmailTouched);

    // Error message methods
    private string GetPhoneNumberErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.PhoneNumber))
            return "Phone Number is required";
        if (!PhoneNumberRegex.IsMatch(wizardModel.PhoneNumber))
            return "Phone Number must contain only numeric values";

        if (wizardModel.PhoneNumber.StartsWith("0"))
            return "Use international format without leading 0";

        var (minLength, maxLength) = !string.IsNullOrWhiteSpace(wizardModel.PhoneCountryCode)
            ? CountryMetadataService.GetPhoneLengthRequirements(wizardModel.PhoneCountryCode)
            : (7, 15);

        if (minLength == maxLength)
        {
            if (wizardModel.PhoneNumber.Length != minLength)
                return $"Phone Number must be exactly {minLength} digits";
        }
        else
        {
            if (wizardModel.PhoneNumber.Length < minLength)
                return $"Phone Number must be at least {minLength} digits";
            if (wizardModel.PhoneNumber.Length > maxLength)
                return $"Phone Number must not exceed {maxLength} digits";
        }

        return string.Empty;
    }

    private string GetWebsiteErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.Website))
            return "Website URL is required";
        if (!IsValidUrl(wizardModel.Website))
            return "Enter a valid URL with domain (e.g., example.com or https://example.com)";
        return string.Empty;
    }

    private string GetEmailErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.ContactEmail))
            return "Email is required";
        if (!IsValidEmail(wizardModel.ContactEmail))
            return "Please enter a valid email address";
        if (contactEmailAlreadyExists)
            return "Email already exists";
        return string.Empty;
    }

    private int GetPhoneNumberMaxLength()
    {
        if (!string.IsNullOrWhiteSpace(wizardModel.PhoneCountryCode))
        {
            var (_, maxLength) = CountryMetadataService.GetPhoneLengthRequirements(wizardModel.PhoneCountryCode);
            return maxLength;
        }
        return 15; // Default max length
    }

    // Sanitize phone number - strips non-numeric characters and enforces max length
    /// <summary>
    /// Parses a phone number string like "+92 30254545" into country code and phone number parts.
    /// </summary>
    private (string countryCode, string phoneNumber) ParsePhoneNumber(string? fullPhoneNumber)
    {
        if (string.IsNullOrWhiteSpace(fullPhoneNumber))
            return ("", "");

        var phone = fullPhoneNumber.Trim();

        // Check if it starts with "+"
        if (phone.StartsWith("+"))
        {
            phone = phone.Substring(1); // Remove the "+"

            // Split by space to separate country code and phone number
            var parts = phone.Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length == 2)
            {
                return (parts[0], parts[1]);
            }
            else if (parts.Length == 1)
            {
                // No space found, try to extract country code (assume 1-3 digits at start)
                // This is a fallback for formats like "+9230254545"
                for (int i = 3; i >= 1; i--)
                {
                    if (phone.Length > i)
                    {
                        return (phone.Substring(0, i), phone.Substring(i));
                    }
                }
            }
        }

        // If no country code format detected, return as-is for phone number
        return ("", fullPhoneNumber);
    }

    /// <summary>
    /// Compares property data with group data to determine if checkboxes should be checked in edit mode.
    /// </summary>
    private async Task CompareWithGroupDataAsync()
    {
        try
        {
            if (!_currentGroupId.HasValue) return;

            var groupResponse = await GroupService.GetGroup(new GetGroupRequest(_currentGroupId.Value, "Address,PrimaryContact,PrimaryContact.ContactInfo"));
            if (groupResponse?.Group == null) return;

            var group = groupResponse.Group;

            // Compare address fields - if all match, check the address checkbox
            var addressMatches =
                string.Equals(wizardModel.AddressLine1?.Trim(), group.AddressLine1?.Trim(), StringComparison.OrdinalIgnoreCase) &&
                string.Equals(wizardModel.AddressLine2?.Trim(), group.AddressLine2?.Trim(), StringComparison.OrdinalIgnoreCase) &&
                string.Equals(wizardModel.City?.Trim(), group.City?.Trim(), StringComparison.OrdinalIgnoreCase) &&
                string.Equals(wizardModel.Country?.Trim(), group.Country?.Trim(), StringComparison.OrdinalIgnoreCase) &&
                string.Equals(wizardModel.PostalCode?.Trim(), group.PostalCode?.Trim(), StringComparison.OrdinalIgnoreCase);

            wizardModel.SetAddressSameAsGroupAddress = addressMatches;

            // Compare contact fields - if all match, check the contact checkbox
            var contactMatches =
                string.Equals(wizardModel.ContactName?.Trim(), group.PrimaryContactName?.Trim(), StringComparison.OrdinalIgnoreCase) &&
                string.Equals(wizardModel.ContactEmail?.Trim(), group.PrimaryContactEmail?.Trim(), StringComparison.OrdinalIgnoreCase);

            wizardModel.SetContactSameAsPrimaryContact = contactMatches;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error comparing with group data: {ex.Message}");
        }
    }

    private string SanitizePhoneNumber(string? phone)
    {
        if (string.IsNullOrEmpty(phone))
            return string.Empty;

        // Remove all non-numeric characters
        var numericOnly = new string(phone.Where(char.IsDigit).ToArray());

        // Enforce max length of 15 digits
        if (numericOnly.Length > 15)
            numericOnly = numericOnly.Substring(0, 15);

        return numericOnly;
    }

    // Phone number change handler - strips non-numeric characters after binding (handles paste)
    private void OnPhoneNumberChanged()
    {
        if (!string.IsNullOrEmpty(wizardModel.PhoneNumber))
        {
            var sanitized = SanitizePhoneNumber(wizardModel.PhoneNumber);
            if (sanitized != wizardModel.PhoneNumber)
            {
                wizardModel.PhoneNumber = sanitized;
            }
        }
    }

    private void OnCountryChanged(string newCountry)
    {
        wizardModel.Country = newCountry;

        if (!wizardModel.SetContactSameAsPrimaryContact && !string.IsNullOrWhiteSpace(newCountry))
        {
            var country = CountryMetadataService.GetByName(newCountry);
            if (country != null && !string.IsNullOrWhiteSpace(country.PhoneCountryCode))
            {
                wizardModel.PhoneCountryCode = country.PhoneCountryCode;
                _phoneCountryName = newCountry;
            }
        }

        StateHasChanged();
    }

    private void OnPhoneCountryCodeChanged(ChangeEventArgs e)
    {
        var newCode = e.Value?.ToString() ?? string.Empty;
        wizardModel.PhoneCountryCode = newCode;

        if (!string.IsNullOrWhiteSpace(newCode))
        {
            var country = CountryMetadataService.GetByCountryCode(newCode);
            _phoneCountryName = country?.Name;
        }
        else
        {
            _phoneCountryName = null;
        }

        StateHasChanged();
    }

    private async Task<IEnumerable<string>> SearchCountries(string searchText, CancellationToken cancellationToken)
    {
        if (countryNames == null)
            return Enumerable.Empty<string>();

        // If search text is empty OR matches the currently selected country, show all countries
        if (string.IsNullOrWhiteSpace(searchText) ||
            string.Equals(searchText, wizardModel.Country, StringComparison.OrdinalIgnoreCase))
        {
            var sortedAll = countryNames
                .OrderBy(c => c, StringComparer.OrdinalIgnoreCase)
                .ToList();

            // Scroll to the selected country after dropdown renders
            if (!string.IsNullOrWhiteSpace(wizardModel.Country))
            {
                _ = ScrollToSelectedCountryAsync(wizardModel.Country);
            }

            return sortedAll;
        }

        var filtered = countryNames
            .Where(c => c.StartsWith(searchText, StringComparison.OrdinalIgnoreCase))
            .OrderBy(c => c, StringComparer.OrdinalIgnoreCase)
            .ToList();

        return filtered;
    }

    private async Task ScrollToSelectedCountryAsync(string selectedCountry)
    {
        // Small delay to allow dropdown to render
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("scrollToSelectedCountry", selectedCountry);
    }

    private async Task OnSameAsPrimaryChanged()
    {
        // Reset validation states FIRST before any async operations
        // Only reset address-related fields, NOT phone/website (they are independent)
        addressLine1Touched = false;
        cityTouched = false;
        countryTouched = false;
        postalCodeTouched = false;
        showValidation = false;

        if (wizardModel.SetAddressSameAsGroupAddress && wizardModel.GroupId.HasValue)
        {
            try
            {
                var groupResponse = await GroupService.GetGroup(new GetGroupRequest(wizardModel.GroupId.Value, "Address,PrimaryContact,PrimaryContact.ContactInfo"));
                if (groupResponse?.Group != null)
                {
                    // Only copy ADDRESS fields from group, NOT phone/website
                    wizardModel.AddressLine1 = groupResponse.Group.AddressLine1 ?? string.Empty;
                    wizardModel.AddressLine2 = groupResponse.Group.AddressLine2 ?? string.Empty;
                    wizardModel.City = groupResponse.Group.City ?? string.Empty;
                    wizardModel.Country = groupResponse.Group.Country ?? string.Empty;
                    wizardModel.PostalCode = groupResponse.Group.PostalCode ?? string.Empty;
                    // Phone and Website are always user-editable, do NOT copy from group
                }
            }
            catch
            {
                // Silent fail
            }
        }
        else
        {
            // Only clear address fields, NOT phone/website
            wizardModel.AddressLine1 = string.Empty;
            wizardModel.AddressLine2 = string.Empty;
            wizardModel.City = string.Empty;
            wizardModel.Country = string.Empty;
            wizardModel.PostalCode = string.Empty;
        }

        // Force complete UI re-render
        await InvokeAsync(StateHasChanged);

        // Don't save on every checkbox change - save only on navigation
    }

    private async Task OnSameAsClientChanged()
    {
        contactNameTouched = false;
        contactEmailTouched = false;
        phoneNumberTouched = false;
        contactEmailAlreadyExists = false;
        showValidation = false;

        if (wizardModel.SetContactSameAsPrimaryContact && wizardModel.GroupId.HasValue)
        {
            try
            {
                var groupResponse = await GroupService.GetGroup(new GetGroupRequest(wizardModel.GroupId.Value, "Address,PrimaryContact,PrimaryContact.ContactInfo"));
                if (groupResponse?.Group != null)
                {
                    wizardModel.ContactName = groupResponse.Group.PrimaryContactName ?? string.Empty;
                    wizardModel.ContactEmail = groupResponse.Group.PrimaryContactEmail ?? string.Empty;
                    // Also load phone number from the group's primary contact
                    wizardModel.PhoneCountryCode = groupResponse.Group.PrimaryContactCountryCode ?? string.Empty;
                    wizardModel.PhoneNumber = SanitizePhoneNumber(groupResponse.Group.PrimaryContactPhoneNumber);

                    if (!string.IsNullOrWhiteSpace(wizardModel.PhoneCountryCode))
                    {
                        var country = CountryMetadataService.GetByCountryCode(wizardModel.PhoneCountryCode);
                        _phoneCountryName = country?.Name;
                    }
                    else
                    {
                        _phoneCountryName = null;
                    }
                }
            }
            catch
            {
                // Silent fail
            }
        }
        else
        {
            wizardModel.ContactName = string.Empty;
            wizardModel.ContactEmail = string.Empty;
            wizardModel.PhoneCountryCode = string.Empty;
            wizardModel.PhoneNumber = string.Empty;
            _phoneCountryName = null;
        }

        await InvokeAsync(StateHasChanged);

        // Don't save on every checkbox change - save only on navigation
    }

    private async Task HandleClose()
    {
        bool hasChangesOrProgress = HasUnsavedChanges() || HasWizardProgress();

        if (!hasChangesOrProgress)
        {
            await CloseAndNavigate();
            return;
        }
        // Show Unsaved Changes modal
        var parameters = new DialogParameters
        {
            { "ShowSaveAndContinue", false }
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.Small,
        };

        var dialog = await DialogService.ShowAsync<UnsavedChangesModal>(
            "Unsaved Changes",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (result == null || result.Canceled)
            return;

        var action = (UnsavedChangesModal.UnsavedChangesResult)result.Data!;

        switch (action)
        {
            case UnsavedChangesModal.UnsavedChangesResult.Discard:
                await CloseAndNavigate();
                break;

            case UnsavedChangesModal.UnsavedChangesResult.Cancel:
                // Do nothing
                break;
        }
    }

    private async Task CloseAndNavigate()
    {
        var groupIdString = await JSRuntime.InvokeAsync<string>(
            "localStorage.getItem",
            "SelectedGroupId"
        );

        if (string.IsNullOrWhiteSpace(groupIdString) ||
            !Guid.TryParse(groupIdString, out var groupId))
        {
            return;
        }

        var storageKey = GetStorageKey();
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", storageKey);
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "CurrentPropertyId");

        NavigationManager.NavigateTo($"/group/view/{groupId}");
    }


    private async Task HandleBack()
    {
        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            "/property/information");
    }

    private async Task HandleNext()
    {
        showValidation = true;

        if (!IsFormValid())
        {
            StateHasChanged();
            return;
        }

        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            "/property/key-selling-points");
    }

    private async Task HandleSave()
    {
        showValidation = true;

        if (!IsFormValid())
        {
            StateHasChanged();
            return;
        }

        await SaveToLocalStorage();
        // In edit mode, "Save" navigates to Review & Save step
        NavigationManager.NavigateTo("/property/review-save");
    }

    private async Task HandleStepClick(int stepIndex)
    {
        if (!wizardModel.IsEditMode) return;

        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            stepRoutes[stepIndex]);
    }

    private string GetCountryFlagUrl(string? countryName)
    {
        if (string.IsNullOrWhiteSpace(countryName))
        {
            // Return a placeholder/default flag (globe icon as SVG)
            return GetPlaceholderFlagSvg();
        }

        var country = CountryMetadataService.GetByName(countryName);
        if (country != null && !string.IsNullOrWhiteSpace(country.ISO2))
        {
            // Use flagcdn.com for country flags based on ISO2 code
            return $"/flags/{country.ISO2.ToLowerInvariant()}.svg";
        }

        return GetPlaceholderFlagSvg();
    }

    private string GetFlagUrlByCountryCode(string? phoneCountryCode, string? fallbackCountryName)
    {
        if (string.IsNullOrWhiteSpace(phoneCountryCode))
        {
            return GetPlaceholderFlagSvg();
        }

        if (!string.IsNullOrWhiteSpace(fallbackCountryName))
        {
            var country = CountryMetadataService.GetByName(fallbackCountryName);
            if (country != null && !string.IsNullOrWhiteSpace(country.ISO2))
            {
                return $"/flags/{country.ISO2.ToLowerInvariant()}.svg";
            }
        }

        var countries = CountryMetadataService.GetAll();
        var countryByCode = countries.FirstOrDefault(c => c.PhoneCountryCode == phoneCountryCode);
        if (countryByCode != null && !string.IsNullOrWhiteSpace(countryByCode.ISO2))
        {
            return $"/flags/{countryByCode.ISO2.ToLowerInvariant()}.svg";
        }

        return GetPlaceholderFlagSvg();
    }

    private string GetPlaceholderFlagSvg()
    {
        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='20' viewBox='0 0 30 20'%3E%3Crect width='30' height='20' fill='%23E0E0E0' rx='2'/%3E%3Ccircle cx='15' cy='10' r='7' fill='none' stroke='%23999' stroke-width='1'/%3E%3Cpath d='M8 10h14M15 3v14M9 5c3 2 6 2 9 0M9 15c3-2 6-2 9 0' fill='none' stroke='%23999' stroke-width='0.8'/%3E%3C/svg%3E";
    }
}

<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    .card-bg-dark {
        background-color: #434343;
        color: white;
    }
    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin: 0;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        background: #FFFFFF;
        border: 1px solid #FF931E;
    }


    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    .wizard-step.active .step-line {
        background: #D9D9D9;
    }

    .wizard-step:last-child .step-line {
        display: none;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */
    .wizard-content {
        flex: 1;
        background: #F6F6F6;
        padding: 48px !important;
        padding-bottom: 140px !important;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
    }

    .content-header {
        margin-bottom: 40px;
    }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin: 0;
    }

    /* Form Styling */
    .address-form {
        max-width: 1000px;
    }

    /* Simple Checkbox - No border, just checkbox + text */
    .checkbox-simple {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
    }

        .checkbox-simple input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #1C1B1F;
            margin: 0;
            border: 1px solid #C3C3C3;
        }

    .checkbox-label-simple {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 19px;
        color: #000000;
        cursor: pointer;
        margin: 0;
    }

    .form-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        display: block;
        margin-bottom: 8px;
    }

    .helper-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 19px;
        color: #737373;
        margin: 0;
    }

    /* Address Row Container - Primary and Secondary side by side */
    .address-row-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        margin-bottom: 32px;
    }

    .address-column-left {
        display: flex;
        flex-direction: column;
        align-content: center
    }

    .address-column-right {
        display: flex;
        flex-direction: column;
        align-content: center;
    }

    /* Label groups to align properly */
    .label-group {
        margin-bottom: 8px;
    }

    .label-group-right {
        height: 27px; /* Match the height of label + helper text on left: 19px (label) + 8px (margin) + 19px (helper) */
        display: flex;
        margin-bottom: 8px;
    }

        .label-group-right .form-label {
            margin-bottom: 0;
        }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    /* Override MudBlazor TextField to match Figma */
    .address-form .form-input input.mud-input-slot,
    .address-form .form-input textarea.mud-input-slot {
        background: #F6F6F6 !important;
        border: 1px solid #C3C3C3 !important;
        border-radius: 6px !important;
        height: 50px !important;
        box-shadow: none !important;
        padding: 0 18px !important;
        margin: 0 !important;
        width: 100% !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        font-weight: 400 !important;
        font-size: 16px !important;
        line-height: 19px !important;
        color: #000000 !important;
    }

    /* Placeholder styles for MudBlazor inputs */
    .address-form .form-input input.mud-input-slot::placeholder,
    .address-form .form-input textarea.mud-input-slot::placeholder,
    .address-form .form-input input::placeholder,
    .address-form .form-input .mud-input-slot::placeholder {
        color: #737373 !important;
        opacity: 1 !important;
        font-weight: 400 !important;
    }

    /* WebKit browsers (Chrome, Safari, Edge) */
    .address-form .form-input input::-webkit-input-placeholder,
    .address-form .form-input .mud-input-slot::-webkit-input-placeholder {
        color: #737373 !important;
        opacity: 1 !important;
    }

    /* Firefox */
    .address-form .form-input input::-moz-placeholder,
    .address-form .form-input .mud-input-slot::-moz-placeholder {
        color: #737373 !important;
        opacity: 1 !important;
    }

    /* IE/Edge */
    .address-form .form-input input:-ms-input-placeholder,
    .address-form .form-input .mud-input-slot:-ms-input-placeholder {
        color: #737373 !important;
        opacity: 1 !important;
    }

    /* Remove MudBlazor underline */
    .address-form .form-input .mud-input-underline::before,
    .address-form .form-input .mud-input-underline::after {
        display: none !important;
    }

    .address-form .form-input .mud-input-line {
        display: none !important;
    }

    /* Three Column Row */
    .form-row-three-col {
        display: grid;
        grid-template-columns: 260px 290px 260px;
        gap: 32px;
        margin-bottom: 32px;
    }

    /* Country Select with Flag */
    .country-select-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 8px;
        width: 290px;
        height: 50px;
        overflow: hidden;
    }

    .country-flag {
        padding: 0 12px;
        display: flex;
        align-items: center;
        border-right: 1px solid #C3C3C3;
        height: 100%;
        flex-shrink: 0;
    }

    .flag-icon {
        width: 30px;
        height: 20px;
        object-fit: contain;
    }

    /* MudAutocomplete outer wrapper */
    .country-select-wrapper > .mud-autocomplete {
        flex: 1;
        min-width: 0;
        height: 100%;
        overflow: hidden;
    }

    .form-select-country {
        flex: 1;
        height: 100%;
        background: transparent;
        border: none;
        padding: 0 40px 0 18px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
    }

        .form-select-country:focus {
            outline: none;
        }

    /* MudSelect styling for country dropdown */
    .country-mud-select {
        height: 100% !important;
        margin: 0 !important;
        width: 100% !important;
    }

        .country-mud-select .mud-input-control-input-container {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            width: 100% !important;
        }

        .country-mud-select .mud-input {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            width: 100% !important;
        }

        .country-mud-select .mud-input-slot,
        .country-mud-select input.mud-input-slot {
            background: transparent !important;
            border: none !important;
            padding: 0 12px !important;
            padding-right: 32px !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            font-size: 16px !important;
            font-weight: 400 !important;
            color: #000000 !important;
            height: 48px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            text-overflow: ellipsis !important;
            overflow: hidden !important;
            white-space: nowrap !important;
        }

        .country-mud-select .mud-input-underline::before,
        .country-mud-select .mud-input-underline::after {
            display: none !important;
        }

        .country-mud-select .mud-input-adornment {
            color: #000000 !important;
            position: absolute !important;
            right: 8px !important;
        }

        /* Placeholder text styling */
        .country-mud-select input.mud-input-slot::placeholder {
            color: #737373 !important;
            opacity: 1 !important;
        }

    /* Custom Two Column Row for Phone and Website */
    .form-row-two-col-custom {
        display: grid;
        grid-template-columns: 310px 1fr;
        gap: 32px;
        margin-bottom: 40px;
    }

    /* Phone Input with Flag */
    .phone-input-wrapper {
        display: flex;
        align-items: center;
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        height: 50px;
        overflow: hidden;
    }

    .phone-country-flag {
        padding: 0 12px;
        display: flex;
        align-items: center;
    }

    .flag-icon-small {
        width: 30px;
        height: 20px;
        object-fit: contain;
    }

    .phone-divider {
        width: 1px;
        height: 48px;
        background: #C3C3C3;
    }

    .phone-country-code-select {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        padding: 0 4px 0 8px;
        white-space: nowrap;
        border: none;
        background: transparent;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        min-width: 65px;
        height: 100%;
    }

        .phone-country-code-select:focus {
            outline: none;
        }

    .phone-number-input {
        flex: 1;
        min-width: 0;
        height: 100%;
        border: none;
        background: transparent;
        padding: 0 18px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        overflow: hidden;
        text-overflow: ellipsis;
    }

        .phone-number-input:focus {
            outline: none;
        }

        /* Phone number placeholder - light grey */
        .phone-number-input::placeholder {
            color: #737373 !important;
            opacity: 1 !important;
            font-weight: 400 !important;
        }

        .phone-number-input::-webkit-input-placeholder {
            color: #737373 !important;
            opacity: 1 !important;
        }

        .phone-number-input::-moz-placeholder {
            color: #737373 !important;
            opacity: 1 !important;
        }

        .phone-number-input:-ms-input-placeholder {
            color: #737373 !important;
            opacity: 1 !important;
        }

    /* Section Divider */
    .section-divider {
        height: 60px;
    }

    .section-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin: 0 0 32px 0;
    }

    /* Role Display Field */
    .role-display-wrapper {
        display: flex;
        flex-direction: column;
    }

    .role-display {
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 18px;
    }

    .role-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #707070;
    }

    .role-icon {
        opacity: 0.8;
    }

    .role-helper-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 400;
        line-height: 17px;
        color: #707070;
        margin: 8px 0 0 0;
    }

    /* Validation Error Styles */
    .input-error input.mud-input-slot,
    .input-error textarea.mud-input-slot {
        border: 2px solid #d32f2f !important;
        background-color: #fff8f8 !important;
    }

    .input-error-border {
        border: 2px solid #d32f2f !important;
        background-color: #fff8f8 !important;
    }

    .validation-error-text {
        color: #d32f2f;
        font-size: 12px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin-top: 4px;
    }

    /* Override MudBlazor error text color */
    .mud-input-error .mud-input-helper-text {
        color: #d32f2f !important;
    }

    /* Mobile Responsive Styles */
    @@media (max-width: 768px) {
        .wizard-content {
            padding: 24px !important;
            padding-bottom: 140px !important;
        }

        .address-row-container {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .form-row-three-col {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .form-row-two-col-custom {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .country-select-wrapper {
            width: 100%;
        }

        .phone-input-wrapper {
            width: 100%;
        }

        .website-input {
            width: 100% !important;
            max-width: 100% !important;
        }
    }

    @@media (max-width: 480px) {
        .wizard-content {
            padding: 16px !important;
            padding-bottom: 150px !important;
        }

        .address-row-container {
            gap: 12px;
            margin-bottom: 20px;
        }

        .form-row-three-col {
            gap: 12px;
            margin-bottom: 20px;
        }

        .form-row-two-col-custom {
            gap: 12px;
            margin-bottom: 24px;
        }

        .form-label {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .content-title {
            font-size: 18px;
        }

        .step-label {
            font-size: 12px;
        }

        .checkbox-label-simple {
            font-size: 14px;
        }

        .phone-input-wrapper {
            height: 44px;
        }

        .phone-country-code-select {
            font-size: 13px;
            min-width: 60px;
        }

        .phone-number-input {
            font-size: 14px;
        }
    }

</style>