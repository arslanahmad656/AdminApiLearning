@page "/property/address-contact"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using Aro.UI.Application.DTOs
@using Aro.UI.Infrastructure.Services
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IGroupService GroupService
@inject ICountryMetadataService CountryMetadataService

<div class="property-wizard-container">
    <!-- Header Bar -->
    <div class="wizard-header">
        <h1 class="header-title">Create New Property</h1>
        <div class="close-icon" @onclick="HandleClose">
            <svg width="17" height="17" viewBox="0 0 17 17" fill="none">
                <line x1="1" y1="1" x2="16" y2="16" stroke="white" stroke-width="2" />
                <line x1="16" y1="1" x2="1" y2="16" stroke="white" stroke-width="2" />
            </svg>
        </div>
    </div>

    <div class="wizard-body">
        <!-- Left Sidebar with Steps -->
        <div class="wizard-sidebar">
            <div class="wizard-steps">
                <div class="wizard-step completed">
                    <div class="step-indicator">
                        <div class="step-number completed-check">
                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                <path d="M1 5L6 10L15 1" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="step-line completed"></div>
                    </div>
                    <div class="step-title">Property Information</div>
                </div>
                <div class="wizard-step active">
                    <div class="step-indicator">
                        <div class="step-number">2</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-title">Address & Primary Contact</div>
                </div>
                <div class="wizard-step">
                    <div class="step-indicator">
                        <div class="step-number">3</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-title">Key Selling Points</div>
                </div>
                <div class="wizard-step">
                    <div class="step-indicator">
                        <div class="step-number">4</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-title">Media Files</div>
                </div>
                <div class="wizard-step">
                    <div class="step-indicator">
                        <div class="step-number">5</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-title">Marketing & SEO</div>
                </div>
                <div class="wizard-step">
                    <div class="step-indicator">
                        <div class="step-number">6</div>
                    </div>
                    <div class="step-title">Review & Save</div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="wizard-content">
            <div class="content-header">
                <p class="step-label">Step 2</p>
                <h2 class="content-title">Property Address</h2>
            </div>

            <MudForm @ref="form" Class="address-form">
                <!-- Set the same as Primary Checkbox - Simple inline -->
                <div class="checkbox-simple">
                    <input type="checkbox" id="sameAsPrimary" @bind="wizardModel.SetAddressSameAsGroupAddress" @bind:after="OnSameAsPrimaryChanged" />
                    <label for="sameAsPrimary" class="checkbox-label-simple">Set the same as the group address</label>
                </div>

                <!-- Primary Address and Secondary Address Row -->
                <div class="address-row-container">
                    <div class="address-column-left">
                        <div class="label-group">
                            <label class="form-label">Address Line 1 *</label>
                        </div>
                        <MudTextField T="string"
                                      Value="wizardModel.AddressLine1"
                                      ValueChanged="OnAddressLine1Changed"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsAddressLine1Invalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsAddressLine1Invalid"
                                      ErrorText="Address Line 1 is required"
                                      Placeholder="Enter address line 1"
                                      DisableUnderLine="true"
                                      @onfocus="OnAddressLine1Focus"
                                      @onblur="OnAddressLine1Blur" />
                    </div>
                    <div class="address-column-right">
                        <div class="label-group-right">
                            <label class="form-label">Address Line 2</label>
                        </div>
                        <MudTextField @bind-Value="wizardModel.AddressLine2"
                                      Variant="Variant.Text"
                                      Class="form-input secondary-input"
                                      HelperText=""
                                      HelperTextOnFocus="false"
                                      Immediate="true"
                                      Placeholder="Enter address line 2"
                                      DisableUnderLine="true" />
                    </div>
                </div>

                <!-- City, Country, Postal Code Row -->
                <div class="form-row-three-col">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.City"
                                      ValueChanged="OnCityChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsCityInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsCityInvalid"
                                      ErrorText="City is required"
                                      Placeholder="Enter city"
                                      DisableUnderLine="true"
                                      @onfocus="OnCityFocus"
                                      @onblur="OnCityBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <div class="@($"country-select-wrapper {(IsCountryInvalid ? "input-error-border" : "")}")" @onfocusin="OnCountryFocus" @onfocusout="OnCountryBlur">
                            <div class="country-flag">
                                <img src="@GetCountryFlagUrl(wizardModel.Country)" alt="Country Flag" class="flag-icon" />
                            </div>
                            <MudSelect T="string"
                                       Value="wizardModel.Country"
                                       ValueChanged="OnCountryChanged"
                                       Placeholder="Select country"
                                       Variant="Variant.Text"
                                       Class="country-mud-select"
                                       DisableUnderLine="true"
                                       Dense="true">
                                @if (countryNames != null)
                                {
                                    @foreach (var country in countryNames)
                                    {
                                        <MudSelectItem Value="@country">@country</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </div>
                        @if (IsCountryInvalid)
                        {
                            <div class="validation-error-text">Country is required</div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postal Code *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.PostalCode"
                                      ValueChanged="OnPostalCodeChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsPostalCodeInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsPostalCodeInvalid"
                                      ErrorText="Postal Code is required"
                                      Placeholder="Enter postal code"
                                      DisableUnderLine="true"
                                      @onfocus="OnPostalCodeFocus"
                                      @onblur="OnPostalCodeBlur" />
                    </div>
                </div>

                <!-- Phone Number and Website URL Row -->
                <div class="form-row-two-col-custom">
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <div class="@($"phone-input-wrapper {(IsPhoneNumberInvalid ? "input-error-border" : "")}")" @onfocusin="OnPhoneNumberFocus" @onfocusout="OnPhoneNumberBlur">
                            <div class="phone-country-flag">
                                <img src="@GetFlagUrlByCountryCode(wizardModel.PhoneCountryCode, wizardModel.Country)" alt="Country Flag" class="flag-icon-small" />
                            </div>
                            <select class="phone-country-code-select" @bind="wizardModel.PhoneCountryCode">
                                <option value="">--</option>
                                @if (countryCodes != null)
                                {
                                    @foreach (var countryCode in countryCodes)
                                    {
                                        <option value="@countryCode">+@countryCode</option>
                                    }
                                }
                            </select>
                            <div class="phone-divider"></div>
                            <input type="tel"
                                   class="phone-number-input"
                                   @bind="wizardModel.PhoneNumber"
                                   @bind:event="oninput"
                                   @bind:after="OnPhoneNumberChanged"
                                   onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 0"
                                   placeholder="Enter phone number"
                                   pattern="[0-9]*"
                                   inputmode="numeric"
                                   maxlength="15" />
                        </div>
                        @if (IsPhoneNumberInvalid)
                        {
                            <div class="validation-error-text">@GetPhoneNumberErrorMessage()</div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website URL *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.Website"
                                      ValueChanged="OnWebsiteChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsWebsiteInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsWebsiteInvalid"
                                      ErrorText="@GetWebsiteErrorMessage()"
                                      Placeholder="https://example.com"
                                      DisableUnderLine="true"
                                      @onfocus="OnWebsiteFocus"
                                      @onblur="OnWebsiteBlur" />
                    </div>
                </div>

                <!-- Primary Contact Section -->
                <div class="section-divider"></div>

                <h2 class="section-title">Primary contact</h2>

                <!-- Set the same as client primary contact Checkbox - Simple inline -->
                <div class="checkbox-simple">
                    <input type="checkbox" id="sameAsClient" @bind="wizardModel.SetContactSameAsPrimaryContact" @bind:after="OnSameAsClientChanged" />
                    <label for="sameAsClient" class="checkbox-label-simple">Set the same as the group primary contact</label>
                </div>

                <!-- Primary Contact Name, Email, Role Row -->
                <div class="form-row-three-col">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.ContactName"
                                      ValueChanged="OnContactNameChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsContactNameInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsContactNameInvalid"
                                      ErrorText="Name is required"
                                      Placeholder="Enter contact name"
                                      DisableUnderLine="true"
                                      @onfocus="OnContactNameFocus"
                                      @onblur="OnContactNameBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <MudTextField T="string"
                                      Value="wizardModel.ContactEmail"
                                      ValueChanged="OnContactEmailChanged"
                                      Variant="Variant.Text"
                                      Class="@($"form-input {(IsContactEmailInvalid ? "input-error" : "")}")"
                                      Immediate="true"
                                      Error="@IsContactEmailInvalid"
                                      ErrorText="@GetEmailErrorMessage()"
                                      Placeholder="example@domain.com"
                                      DisableUnderLine="true"
                                      @onfocus="OnContactEmailFocus"
                                      @onblur="OnContactEmailBlur" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <div class="role-display-wrapper">
                            <div class="role-display">
                                <span class="role-text">Property Manager</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" class="role-icon">
                                    <path d="M1 1L6 6L11 1" stroke="#707070" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <p class="role-helper-text">Allocated by default, can't be changed.</p>
                        </div>
                    </div>
                </div>
            </MudForm>
            <!-- Footer with Buttons -->
            <WizardFooter OnBack="HandleBack"
                          OnNext="HandleNext"
                          BackDisabled="false"
                          NextDisabled="@(!IsFormValid())" />
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private PropertyWizardModel wizardModel = new();
    private bool showValidation = false;
    private IEnumerable<string>? countryNames;
    private IEnumerable<string>? countryCodes;
    private Guid? _currentGroupId = null;

    // Track if field has been interacted with (focused then blurred)
    private bool addressLine1Touched = false;
    private bool cityTouched = false;
    private bool countryTouched = false;
    private bool postalCodeTouched = false;
    private bool phoneNumberTouched = false;
    private bool websiteTouched = false;
    private bool contactNameTouched = false;
    private bool contactEmailTouched = false;

    // Track if field is currently focused (to hide error while editing)
    private bool addressLine1Focused = false;
    private bool cityFocused = false;
    private bool countryFocused = false;
    private bool postalCodeFocused = false;
    private bool phoneNumberFocused = false;
    private bool websiteFocused = false;
    private bool contactNameFocused = false;
    private bool contactEmailFocused = false;

    // Focus handlers - hide error while editing
    private void OnAddressLine1Focus() { addressLine1Focused = true; StateHasChanged(); }
    private void OnCityFocus() { cityFocused = true; StateHasChanged(); }
    private void OnCountryFocus() { countryFocused = true; StateHasChanged(); }
    private void OnPostalCodeFocus() { postalCodeFocused = true; StateHasChanged(); }
    private void OnPhoneNumberFocus() { phoneNumberFocused = true; StateHasChanged(); }
    private void OnWebsiteFocus() { websiteFocused = true; StateHasChanged(); }
    private void OnContactNameFocus() { contactNameFocused = true; StateHasChanged(); }
    private void OnContactEmailFocus() { contactEmailFocused = true; StateHasChanged(); }

    // Blur handlers - mark as touched and show error when leaving field empty
    private void OnAddressLine1Blur() { addressLine1Focused = false; addressLine1Touched = true; StateHasChanged(); }
    private void OnCityBlur() { cityFocused = false; cityTouched = true; StateHasChanged(); }
    private void OnCountryBlur() { countryFocused = false; countryTouched = true; StateHasChanged(); }
    private void OnPostalCodeBlur() { postalCodeFocused = false; postalCodeTouched = true; StateHasChanged(); }
    private void OnPhoneNumberBlur() { phoneNumberFocused = false; phoneNumberTouched = true; StateHasChanged(); }
    private void OnWebsiteBlur() { websiteFocused = false; websiteTouched = true; StateHasChanged(); }
    private void OnContactNameBlur() { contactNameFocused = false; contactNameTouched = true; StateHasChanged(); }
    private void OnContactEmailBlur() { contactEmailFocused = false; contactEmailTouched = true; StateHasChanged(); }

    // Value change handlers
    private void OnAddressLine1Changed(string? newValue) { wizardModel.AddressLine1 = newValue; }
    private void OnCityChanged(string? newValue) { wizardModel.City = newValue; }
    private void OnPostalCodeChanged(string? newValue) { wizardModel.PostalCode = newValue; }
    private void OnWebsiteChanged(string? newValue) { wizardModel.Website = newValue; }
    private void OnContactNameChanged(string? newValue) { wizardModel.ContactName = newValue; }
    private void OnContactEmailChanged(string? newValue) { wizardModel.ContactEmail = newValue; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load country names and codes from service
            await CountryMetadataService.InitializeAsync();
            countryNames = CountryMetadataService.GetAllCountryNames();
            countryCodes = CountryMetadataService.GetAllCountryCodes();

            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private string GetStorageKey() => PropertyWizardModel.GetLocalStorageKey(_currentGroupId);

    private async Task LoadFromLocalStorage()
    {
        try
        {
            // FIRST: Always try to get GroupId from SelectedGroupId in localStorage
            var groupIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "SelectedGroupId");
            if (!string.IsNullOrEmpty(groupIdStr) && Guid.TryParse(groupIdStr, out var parsedGroupId))
            {
                _currentGroupId = parsedGroupId;
            }

            // Now load the wizard data with the correct storage key
            var storageKey = GetStorageKey();
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;

                    // Sync _currentGroupId from wizardModel if still not set
                    if (!_currentGroupId.HasValue && wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
                    {
                        _currentGroupId = wizardModel.GroupId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", _currentGroupId.Value.ToString());
                    }
                }
            }

            // Ensure wizardModel.GroupId is set
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Note: Touched flags are not restored from localStorage - they reset on page load
            // This ensures validation only triggers after user interacts with fields
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private async Task SaveToLocalStorage()
    {
        try
        {
            // Ensure GroupId is preserved
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Always ensure SelectedGroupId is saved for subsequent pages
            if (wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", wizardModel.GroupId.Value.ToString());
                _currentGroupId = wizardModel.GroupId;
            }

            wizardModel.CurrentStep = 2;
            var storageKey = GetStorageKey();
            var json = JsonSerializer.Serialize(wizardModel);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, json);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    // Regex patterns for validation
    private static readonly Regex PhoneNumberRegex = new Regex(@"^\d+$", RegexOptions.Compiled);
    private static readonly Regex EmailRegex = new Regex(@"^[^@\s]+@[^@\s]+\.[^@\s]+$", RegexOptions.Compiled | RegexOptions.IgnoreCase);
    private static readonly Regex UrlRegex = new Regex(@"^(https?:\/\/)?([\w\-]+\.)+[\w\-]+(\/[\w\-._~:/?#\[\]@!$&'()*+,;=]*)?$", RegexOptions.Compiled | RegexOptions.IgnoreCase);

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.AddressLine1) &&
               !string.IsNullOrWhiteSpace(wizardModel.City) &&
               !string.IsNullOrWhiteSpace(wizardModel.Country) &&
               !string.IsNullOrWhiteSpace(wizardModel.PostalCode) &&
               !string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) &&
               IsValidPhoneNumber(wizardModel.PhoneNumber) &&
               !string.IsNullOrWhiteSpace(wizardModel.Website) &&
               IsValidUrl(wizardModel.Website) &&
               !string.IsNullOrWhiteSpace(wizardModel.ContactName) &&
               !string.IsNullOrWhiteSpace(wizardModel.ContactEmail) &&
               IsValidEmail(wizardModel.ContactEmail);
    }

    // Format validation methods
    private bool IsValidPhoneNumber(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
            return false;
        if (!PhoneNumberRegex.IsMatch(phone))
            return false;
        // Phone number must be between 7-15 digits
        return phone.Length >= 7 && phone.Length <= 15;
    }
    private bool IsValidEmail(string? email) => !string.IsNullOrWhiteSpace(email) && EmailRegex.IsMatch(email);
    private bool IsValidUrl(string? url) => !string.IsNullOrWhiteSpace(url) && UrlRegex.IsMatch(url);

    // Validation helper methods - show error when:
    // 1. Field is NOT currently focused (hide error while editing), AND
    // 2. Field is empty/invalid, AND
    // 3. Field was touched (focused then blurred) OR user clicked Next (showValidation)
    private bool IsAddressLine1Invalid => !addressLine1Focused && string.IsNullOrWhiteSpace(wizardModel.AddressLine1) && (showValidation || addressLine1Touched);
    private bool IsCityInvalid => !cityFocused && string.IsNullOrWhiteSpace(wizardModel.City) && (showValidation || cityTouched);
    private bool IsCountryInvalid => !countryFocused && string.IsNullOrWhiteSpace(wizardModel.Country) && (showValidation || countryTouched);
    private bool IsPostalCodeInvalid => !postalCodeFocused && string.IsNullOrWhiteSpace(wizardModel.PostalCode) && (showValidation || postalCodeTouched);
    private bool IsPhoneNumberInvalid => !phoneNumberFocused && (string.IsNullOrWhiteSpace(wizardModel.PhoneNumber) || !IsValidPhoneNumber(wizardModel.PhoneNumber)) && (showValidation || phoneNumberTouched);
    private bool IsWebsiteInvalid => !websiteFocused && (string.IsNullOrWhiteSpace(wizardModel.Website) || !IsValidUrl(wizardModel.Website)) && (showValidation || websiteTouched);
    private bool IsContactNameInvalid => !contactNameFocused && string.IsNullOrWhiteSpace(wizardModel.ContactName) && (showValidation || contactNameTouched);
    private bool IsContactEmailInvalid => !contactEmailFocused && (string.IsNullOrWhiteSpace(wizardModel.ContactEmail) || !IsValidEmail(wizardModel.ContactEmail)) && (showValidation || contactEmailTouched);

    // Error message methods
    private string GetPhoneNumberErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.PhoneNumber))
            return "Phone Number is required";
        if (!PhoneNumberRegex.IsMatch(wizardModel.PhoneNumber))
            return "Phone Number must contain only numeric values";
        if (wizardModel.PhoneNumber.Length < 7)
            return "Phone Number must be at least 7 digits";
        if (wizardModel.PhoneNumber.Length > 15)
            return "Phone Number must not exceed 15 digits";
        return string.Empty;
    }

    private string GetWebsiteErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.Website))
            return "Website URL is required";
        if (!IsValidUrl(wizardModel.Website))
            return "Please enter a valid URL (e.g., https://example.com)";
        return string.Empty;
    }

    private string GetEmailErrorMessage()
    {
        if (string.IsNullOrWhiteSpace(wizardModel.ContactEmail))
            return "Email is required";
        if (!IsValidEmail(wizardModel.ContactEmail))
            return "Please enter a valid email address";
        return string.Empty;
    }

    // Phone number change handler - strips non-numeric characters after binding (handles paste)
    private void OnPhoneNumberChanged()
    {
        if (!string.IsNullOrEmpty(wizardModel.PhoneNumber))
        {
            // Remove all non-numeric characters
            var numericOnly = new string(wizardModel.PhoneNumber.Where(char.IsDigit).ToArray());
            if (numericOnly != wizardModel.PhoneNumber)
            {
                wizardModel.PhoneNumber = numericOnly;
            }
        }
    }

    private void OnCountryChanged(string newCountry)
    {
        wizardModel.Country = newCountry;

        // Auto-update phone country code based on selected country
        if (!string.IsNullOrWhiteSpace(newCountry))
        {
            var country = CountryMetadataService.GetByName(newCountry);
            if (country != null && !string.IsNullOrWhiteSpace(country.PhoneCountryCode))
            {
                wizardModel.PhoneCountryCode = country.PhoneCountryCode;
            }
        }

        StateHasChanged();
    }

    private async Task OnSameAsPrimaryChanged()
    {
        // Reset validation states FIRST before any async operations
        addressLine1Touched = false;
        cityTouched = false;
        countryTouched = false;
        postalCodeTouched = false;
        showValidation = false;

        if (wizardModel.SetAddressSameAsGroupAddress && wizardModel.GroupId.HasValue)
        {
            try
            {
                // Include Address, PrimaryContact, and PrimaryContact.ContactInfo to get all data
                var groupResponse = await GroupService.GetGroup(new GetGroupRequest(wizardModel.GroupId.Value, "Address,PrimaryContact,PrimaryContact.ContactInfo"));
                if (groupResponse?.Group != null)
                {
                    wizardModel.AddressLine1 = groupResponse.Group.AddressLine1 ?? string.Empty;
                    wizardModel.AddressLine2 = groupResponse.Group.AddressLine2 ?? string.Empty;
                    wizardModel.City = groupResponse.Group.City ?? string.Empty;
                    wizardModel.Country = groupResponse.Group.Country ?? string.Empty;
                    wizardModel.PostalCode = groupResponse.Group.PostalCode ?? string.Empty;
                }
            }
            catch
            {
                // Silent fail
            }
        }
        else
        {
            // Checkbox unchecked - clear the fields
            wizardModel.AddressLine1 = string.Empty;
            wizardModel.AddressLine2 = string.Empty;
            wizardModel.City = string.Empty;
            wizardModel.Country = string.Empty;
            wizardModel.PostalCode = string.Empty;
        }

        // Force complete UI re-render
        await InvokeAsync(StateHasChanged);

        // Don't save on every checkbox change - save only on navigation
    }

    private async Task OnSameAsClientChanged()
    {
        // Reset validation states FIRST before any async operations
        contactNameTouched = false;
        contactEmailTouched = false;
        phoneNumberTouched = false;
        websiteTouched = false;
        showValidation = false;

        if (wizardModel.SetContactSameAsPrimaryContact && wizardModel.GroupId.HasValue)
        {
            try
            {
                // Include Address, PrimaryContact, and PrimaryContact.ContactInfo to get phone data
                var groupResponse = await GroupService.GetGroup(new GetGroupRequest(wizardModel.GroupId.Value, "Address,PrimaryContact,PrimaryContact.ContactInfo"));
                if (groupResponse?.Group != null)
                {
                    wizardModel.ContactName = groupResponse.Group.PrimaryContactName ?? string.Empty;
                    wizardModel.ContactEmail = groupResponse.Group.PrimaryContactEmail ?? string.Empty;
                    wizardModel.PhoneCountryCode = groupResponse.Group.PrimaryContactCountryCode ?? string.Empty;
                    wizardModel.PhoneNumber = groupResponse.Group.PrimaryContactPhoneNumber ?? string.Empty;
                }
            }
            catch
            {
                // Silent fail
            }
        }
        else
        {
            // Checkbox unchecked - clear the fields
            wizardModel.ContactName = string.Empty;
            wizardModel.ContactEmail = string.Empty;
            wizardModel.PhoneCountryCode = string.Empty;
            wizardModel.PhoneNumber = string.Empty;
        }

        // Force complete UI re-render
        await InvokeAsync(StateHasChanged);

        // Don't save on every checkbox change - save only on navigation
    }

    private void HandleClose()
    {
        // Don't save on close - user is canceling
        NavigationManager.NavigateTo("/");
    }

    private async Task HandleBack()
    {
        await SaveToLocalStorage();
        NavigationManager.NavigateTo("/property/information");
    }

    private async Task HandleNext()
    {
        showValidation = true;

        if (!IsFormValid())
        {
            StateHasChanged();
            return;
        }

        await SaveToLocalStorage();
        NavigationManager.NavigateTo("/property/key-selling-points");
    }

    private string GetCountryFlagUrl(string? countryName)
    {
        if (string.IsNullOrWhiteSpace(countryName))
        {
            // Return a placeholder/default flag (globe icon as SVG)
            return GetPlaceholderFlagSvg();
        }

        var country = CountryMetadataService.GetByName(countryName);
        if (country != null && !string.IsNullOrWhiteSpace(country.ISO2))
        {
            // Use flagcdn.com for country flags based on ISO2 code
            return $"https://flagcdn.com/w40/{country.ISO2.ToLowerInvariant()}.png";
        }

        // Fallback placeholder
        return GetPlaceholderFlagSvg();
    }

    private string GetFlagUrlByCountryCode(string? phoneCountryCode, string? fallbackCountryName)
    {
        // First try to get flag by phone country code
        if (!string.IsNullOrWhiteSpace(phoneCountryCode))
        {
            var countries = CountryMetadataService.GetAll();
            var country = countries.FirstOrDefault(c => c.PhoneCountryCode == phoneCountryCode);
            if (country != null && !string.IsNullOrWhiteSpace(country.ISO2))
            {
                return $"https://flagcdn.com/w40/{country.ISO2.ToLowerInvariant()}.png";
            }
        }

        // Fallback to country name
        return GetCountryFlagUrl(fallbackCountryName);
    }

    private string GetPlaceholderFlagSvg()
    {
        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='20' viewBox='0 0 30 20'%3E%3Crect width='30' height='20' fill='%23E0E0E0' rx='2'/%3E%3Ccircle cx='15' cy='10' r='7' fill='none' stroke='%23999' stroke-width='1'/%3E%3Cpath d='M8 10h14M15 3v14M9 5c3 2 6 2 9 0M9 15c3-2 6-2 9 0' fill='none' stroke='%23999' stroke-width='0.8'/%3E%3C/svg%3E";
    }
}

<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin: 0;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        background: #FFFFFF;
        border: 1px solid #FF931E;
    }


    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    .wizard-step.active .step-line {
        background: #D9D9D9;
    }

    .wizard-step:last-child .step-line {
        display: none;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */
    .wizard-content {
        flex: 1;
        background: #F6F6F6;
        padding: 60px 80px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .content-header {
        margin-bottom: 40px;
    }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin: 0;
    }

    /* Form Styling */
    .address-form {
        max-width: 1000px;
    }

    /* Simple Checkbox - No border, just checkbox + text */
    .checkbox-simple {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
    }

        .checkbox-simple input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #1C1B1F;
            margin: 0;
            border: 1px solid #C3C3C3;
        }

    .checkbox-label-simple {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 19px;
        color: #000000;
        cursor: pointer;
        margin: 0;
    }

    .form-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        display: block;
        margin-bottom: 8px;
    }

    .helper-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 19px;
        color: #737373;
        margin: 0;
    }

    /* Address Row Container - Primary and Secondary side by side */
    .address-row-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        margin-bottom: 32px;
    }

    .address-column-left {
        display: flex;
        flex-direction: column;
        align-content: center
    }

    .address-column-right {
        display: flex;
        flex-direction: column;
        align-content: center;
    }

    /* Label groups to align properly */
    .label-group {
        margin-bottom: 8px;
    }

    .label-group-right {
        height: 27px; /* Match the height of label + helper text on left: 19px (label) + 8px (margin) + 19px (helper) */
        display: flex;
        margin-bottom: 8px;
    }

        .label-group-right .form-label {
            margin-bottom: 0;
        }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    /* Override MudBlazor TextField to match Figma */
    .address-form .form-input input.mud-input-slot,
    .address-form .form-input textarea.mud-input-slot {
        background: #F6F6F6 !important;
        border: 1px solid #C3C3C3 !important;
        border-radius: 6px !important;
        height: 50px !important;
        box-shadow: none !important;
        padding: 0 18px !important;
        margin: 0 !important;
        width: 100% !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        font-weight: 400 !important;
        font-size: 16px !important;
        line-height: 19px !important;
        color: #000000 !important;
    }

    .address-form .form-input.secondary-input input.mud-input-slot {
        color: #737373 !important;
    }

    .address-form .form-input input.mud-input-slot::placeholder,
    .address-form .form-input textarea.mud-input-slot::placeholder {
        color: #737373 !important;
        opacity: 1 !important;
    }

    /* Remove MudBlazor underline */
    .address-form .form-input .mud-input-underline::before,
    .address-form .form-input .mud-input-underline::after {
        display: none !important;
    }

    .address-form .form-input .mud-input-line {
        display: none !important;
    }

    /* Three Column Row */
    .form-row-three-col {
        display: grid;
        grid-template-columns: 260px 340px 260px;
        gap: 32px;
        margin-bottom: 32px;
    }

    /* Country Select with Flag */
    .country-select-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        height: 50px;
    }

    .country-flag {
        padding: 0 12px;
        display: flex;
        align-items: center;
        border-right: 1px solid #C3C3C3;
        height: 100%;
    }

    .flag-icon {
        width: 30px;
        height: 20px;
        object-fit: contain;
    }

    .form-select-country {
        flex: 1;
        height: 100%;
        background: transparent;
        border: none;
        padding: 0 40px 0 18px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
    }

        .form-select-country:focus {
            outline: none;
        }

    /* MudSelect styling for country dropdown */
    .country-mud-select {
        flex: 1;
        height: 100%;
        margin: 0 !important;
    }

        .country-mud-select .mud-input-control {
            margin: 0 !important;
            height: 100% !important;
        }

        .country-mud-select .mud-input {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
        }

        .country-mud-select .mud-input-slot {
            background: transparent !important;
            border: none !important;
            padding: 0 12px !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            font-size: 16px !important;
            font-weight: 400 !important;
            color: #000000 !important;
            height: 48px !important;
            min-height: 48px !important;
            display: flex !important;
            align-items: center !important;
        }

        .country-mud-select .mud-select-input {
            padding: 0 12px !important;
            min-height: 48px !important;
            height: 48px !important;
            display: flex !important;
            align-items: center !important;
        }

        .country-mud-select .mud-input-control-input-container {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
        }

        .country-mud-select .mud-input-underline::before,
        .country-mud-select .mud-input-underline::after {
            display: none !important;
        }

        .country-mud-select .mud-input-adornment {
            color: #000000 !important;
        }

        .country-mud-select .mud-select {
            height: 100% !important;
        }

        .country-mud-select .mud-select .mud-input-control {
            height: 100% !important;
        }

        .country-mud-select .mud-input-text {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

    /* Custom Two Column Row for Phone and Website */
    .form-row-two-col-custom {
        display: grid;
        grid-template-columns: 310px 1fr;
        gap: 32px;
        margin-bottom: 40px;
    }

    /* Phone Input with Flag */
    .phone-input-wrapper {
        display: flex;
        align-items: center;
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        height: 50px;
    }

    .phone-country-flag {
        padding: 0 12px;
        display: flex;
        align-items: center;
    }

    .flag-icon-small {
        width: 30px;
        height: 20px;
        object-fit: contain;
    }

    .phone-divider {
        width: 1px;
        height: 48px;
        background: #C3C3C3;
    }

    .phone-country-code-select {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
        padding: 0 4px 0 8px;
        white-space: nowrap;
        border: none;
        background: transparent;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        min-width: 65px;
        height: 100%;
    }

        .phone-country-code-select:focus {
            outline: none;
        }

    .phone-number-input {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        padding: 0 18px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #000000;
    }

        .phone-number-input:focus {
            outline: none;
        }

        .phone-number-input::placeholder {
            color: #737373;
            opacity: 1;
        }

    /* Section Divider */
    .section-divider {
        height: 60px;
    }

    .section-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin: 0 0 32px 0;
    }

    /* Role Display Field */
    .role-display-wrapper {
        display: flex;
        flex-direction: column;
    }

    .role-display {
        background: #F6F6F6;
        border: 1px solid #C3C3C3;
        border-radius: 6px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 18px;
    }

    .role-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: #707070;
    }

    .role-icon {
        opacity: 0.8;
    }

    .role-helper-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 400;
        line-height: 17px;
        color: #707070;
        margin: 8px 0 0 0;
    }

    /* Validation Error Styles */
    .input-error input.mud-input-slot,
    .input-error textarea.mud-input-slot {
        border: 2px solid #d32f2f !important;
        background-color: #fff8f8 !important;
    }

    .input-error-border {
        border: 2px solid #d32f2f !important;
        background-color: #fff8f8 !important;
    }

    .validation-error-text {
        color: #d32f2f;
        font-size: 12px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin-top: 4px;
    }

    /* Override MudBlazor error text color */
    .mud-input-error .mud-input-helper-text {
        color: #d32f2f !important;
    }

</style>