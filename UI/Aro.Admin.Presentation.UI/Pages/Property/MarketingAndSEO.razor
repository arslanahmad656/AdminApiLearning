@page "/property/marketing-seo"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Aro.UI.Application.DTOs
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="property-wizard-container">
    <!-- Header Bar -->
    <div class="wizard-header">
        <h1 class="header-title">Create New Property</h1>
        <div class="close-icon" @onclick="HandleClose">
            <svg width="17" height="17" viewBox="0 0 17 17" fill="none">
                <line x1="1" y1="1" x2="16" y2="16" stroke="white" stroke-width="2" />
                <line x1="16" y1="1" x2="1" y2="16" stroke="white" stroke-width="2" />
            </svg>
        </div>
    </div>
    <div class="wizard-body">
        <!-- Sidebar Navigation -->
        <div class="wizard-sidebar">
            <div class="wizard-steps">
                <div class="wizard-step completed">
                    <div class="step-indicator">
                        <div class="step-number completed-check">
                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                <path d="M1 5L6 10L15 1" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="step-line completed"></div>
                    </div>
                    <div class="step-title">Property Information</div>
                </div>
                <div class="wizard-step completed">
                    <div class="step-indicator">
                        <div class="step-number completed-check">
                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                <path d="M1 5L6 10L15 1" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="step-line completed"></div>
                    </div>
                    <div class="step-title">Address & Primary Contact</div>
                </div>
                <div class="wizard-step completed">
                    <div class="step-indicator">
                        <div class="step-number completed-check">
                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                <path d="M1 5L6 10L15 1" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="step-line completed"></div>
                    </div>
                    <div class="step-title">Key Selling Points</div>
                </div>
                <div class="wizard-step completed">
                    <div class="step-indicator">
                        <div class="step-number completed-check">
                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                <path d="M1 5L6 10L15 1" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="step-line completed"></div>
                    </div>
                    <div class="step-title">Media Files</div>
                </div>
                <div class="wizard-step active">
                    <div class="step-indicator">
                        <div class="step-number">5</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-title">Marketing and SEO</div>
                </div>
                <div class="wizard-step">
                    <div class="step-indicator">
                        <div class="step-number">6</div>
                    </div>
                    <div class="step-title">Review & Save</div>
                </div>

            </div>
        </div>

        <!-- Main Content Area -->
        <div class="wizard-content">
            <div class="content-header">
                <p class="step-label">Step 5</p>
                <h2 class="content-title">Meta Title & Description</h2>
            </div>


            <!-- Marketing Form Fields -->
            <EditForm Model="@wizardModel" OnValidSubmit="@HandleNext">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <!-- Meta Title Input -->
                <div class="form-group">
                    <label for="metaTitle">Meta Title</label>
                    <div class="input-wrapper">
                        <input type="text" id="metaTitle" class="form-control form-control-with-icon" maxlength="@MaxTitleLength" placeholder="Enter meta title" @bind="wizardModel.MarketingTitle" @bind:event="oninput" @onfocus="() => isTitleFocused = true" @onblur="() => OnTitleBlur()" />
                        <span class="input-info-icon" title="This title appears on the browser tab and in search engine results. Keep it short and descriptive.">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.88201 0C3.5292 0 0 3.58332 0 8C0 12.4193 3.5292 16 7.88201 16C12.2348 16 15.764 12.4193 15.764 8C15.764 3.58332 12.2348 0 7.88201 0ZM7.88201 3.54839C8.61923 3.54839 9.21686 4.15497 9.21686 4.90323C9.21686 5.65148 8.61923 6.25806 7.88201 6.25806C7.14478 6.25806 6.54715 5.65148 6.54715 4.90323C6.54715 4.15497 7.14478 3.54839 7.88201 3.54839ZM9.66181 11.7419C9.66181 11.9557 9.49105 12.129 9.28043 12.129H6.48359C6.27296 12.129 6.1022 11.9557 6.1022 11.7419V10.9677C6.1022 10.754 6.27296 10.5806 6.48359 10.5806H6.86497V8.51613H6.48359C6.27296 8.51613 6.1022 8.34281 6.1022 8.12903V7.35484C6.1022 7.14106 6.27296 6.96774 6.48359 6.96774H8.51765C8.72827 6.96774 8.89904 7.14106 8.89904 7.35484V10.5806H9.28043C9.49105 10.5806 9.66181 10.754 9.66181 10.9677V11.7419Z" fill="#434343" fill-opacity="0.75"/>
                            </svg>
                        </span>
                    </div>
                    @if (string.IsNullOrEmpty(wizardModel.MarketingTitle))
                    {
                        <span class="char-count-helper">Max @MaxTitleLength characters.</span>
                    }
                    else
                    {
                        <span class="char-count-helper">@GetTitleRemainingChars() characters remaining</span>
                    }
                </div>

                <!-- Meta Description -->
                <div class="form-group mt-3">
                    <label for="meta">Meta description</label>
                    <div class="input-wrapper">
                        <textarea id="meta" class="form-control form-control-textarea" maxlength="@MaxDescriptionLength" rows="8" placeholder="Enter meta description" @bind="wizardModel.MarketingDescription" @bind:event="oninput" @onfocus="() => isDescriptionFocused = true" @onblur="() => OnDescriptionBlur()"></textarea>
                        <span class="input-info-icon textarea-icon" title="This short description may appear in Google search results to summarise your property.">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.88201 0C3.5292 0 0 3.58332 0 8C0 12.4193 3.5292 16 7.88201 16C12.2348 16 15.764 12.4193 15.764 8C15.764 3.58332 12.2348 0 7.88201 0ZM7.88201 3.54839C8.61923 3.54839 9.21686 4.15497 9.21686 4.90323C9.21686 5.65148 8.61923 6.25806 7.88201 6.25806C7.14478 6.25806 6.54715 5.65148 6.54715 4.90323C6.54715 4.15497 7.14478 3.54839 7.88201 3.54839ZM9.66181 11.7419C9.66181 11.9557 9.49105 12.129 9.28043 12.129H6.48359C6.27296 12.129 6.1022 11.9557 6.1022 11.7419V10.9677C6.1022 10.754 6.27296 10.5806 6.48359 10.5806H6.86497V8.51613H6.48359C6.27296 8.51613 6.1022 8.34281 6.1022 8.12903V7.35484C6.1022 7.14106 6.27296 6.96774 6.48359 6.96774H8.51765C8.72827 6.96774 8.89904 7.14106 8.89904 7.35484V10.5806H9.28043C9.49105 10.5806 9.66181 10.754 9.66181 10.9677V11.7419Z" fill="#434343" fill-opacity="0.75"/>
                            </svg>
                        </span>
                    </div>
                    @if (string.IsNullOrEmpty(wizardModel.MarketingDescription))
                    {
                        <span class="char-count-helper">Max @MaxDescriptionLength characters.</span>
                    }
                    else
                    {
                        <span class="char-count-helper">@GetDescriptionRemainingChars() characters remaining</span>
                    }
                </div>
            </EditForm>

            <!-- Footer Buttons (separated) -->
            <WizardFooter OnBack="HandleBack"
                          OnNext="HandleNext"
                          BackDisabled="false"
                          NextDisabled="false" />
        </div>
    </div>

</div>
@code {
    private const int MaxTitleLength = 60;
    private const int MaxDescriptionLength = 160;
    private PropertyWizardModel wizardModel = new();
    private bool isTitleFocused = false;
    private bool isDescriptionFocused = false;
    private Guid? _currentGroupId = null;

    private int GetTitleRemainingChars() => MaxTitleLength - (wizardModel.MarketingTitle?.Length ?? 0);
    private int GetDescriptionRemainingChars() => MaxDescriptionLength - (wizardModel.MarketingDescription?.Length ?? 0);

    private void OnTitleBlur()
    {
        isTitleFocused = false;
        // Don't save on every blur - save only on navigation
    }

    private void OnDescriptionBlur()
    {
        isDescriptionFocused = false;
        // Don't save on every blur - save only on navigation
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private string GetStorageKey() => PropertyWizardModel.GetLocalStorageKey(_currentGroupId);

    private async Task LoadFromLocalStorage()
    {
        try
        {
            // FIRST: Always try to get GroupId from SelectedGroupId in localStorage
            var groupIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "SelectedGroupId");
            if (!string.IsNullOrEmpty(groupIdStr) && Guid.TryParse(groupIdStr, out var parsedGroupId))
            {
                _currentGroupId = parsedGroupId;
            }

            // Now load the wizard data with the correct storage key
            var storageKey = GetStorageKey();
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;

                    // Sync _currentGroupId from wizardModel if still not set
                    if (!_currentGroupId.HasValue && wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
                    {
                        _currentGroupId = wizardModel.GroupId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", _currentGroupId.Value.ToString());
                    }
                }
            }

            // Ensure wizardModel.GroupId is set
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private async Task SaveToLocalStorage()
    {
        try
        {
            // Ensure GroupId is preserved
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Always ensure SelectedGroupId is saved for subsequent pages
            if (wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", wizardModel.GroupId.Value.ToString());
                _currentGroupId = wizardModel.GroupId;
            }

            wizardModel.CurrentStep = 5;
            var storageKey = GetStorageKey();
            var json = JsonSerializer.Serialize(wizardModel);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, json);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    private async Task HandleClose()
    {
        var groupIdString = await JSRuntime.InvokeAsync<string>(
            "localStorage.getItem",
            "SelectedGroupId"
        );

        if (string.IsNullOrWhiteSpace(groupIdString) ||
            !Guid.TryParse(groupIdString, out var groupId))
        {
            return;
        }
        NavigationManager.NavigateTo($"/group/view/{groupId}");
    }

    // Validation - requires both meta title and description
    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.MarketingTitle) &&
               !string.IsNullOrWhiteSpace(wizardModel.MarketingDescription);
    }

    private async Task HandleBack()
    {
        await SaveToLocalStorage();
        NavigationManager.NavigateTo("/property/media-files");
    }

    private async Task HandleNext()
    {
        await SaveToLocalStorage();
        NavigationManager.NavigateTo("/property/review-save");
    }
}
<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin: 0;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        background: #FFFFFF;
        border: 1px solid #FF931E;
    }

    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    /*   .wizard-step.active .step-line {
                background: #D9D9D9;
            }  */

    .wizard-step:last-child .step-line {
        background: #FFFF;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */

    .wizard-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #F6F6F6;
        padding: 60px 80px;
        overflow-y: auto;
    }

    /* Matches styling in other steps */
    .instruction-text {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #737373;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 24px;
        width: 50%;
    }

        .form-group label {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin-bottom: 8px;
        }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .form-control {
        font-size: 16px;
        padding: 12px 18px;
        border: 1px solid #C3C3C3;
        border-radius: 8px;
        background-color: #F6F6F6;
        resize: none;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        line-height: 19px;
        color: #000000;
    }

    /* Placeholder styling */
    .form-control::placeholder {
        color: #737373;
        opacity: 1;
    }

    .form-control::-webkit-input-placeholder {
        color: #737373;
    }

    .form-control::-moz-placeholder {
        color: #737373;
    }

    .form-control:-ms-input-placeholder {
        color: #737373;
    }

    .form-control-with-icon {
        padding-right: 48px;
        height: 50px;
    }

    .form-control-textarea {
        padding-right: 48px;
        min-height: 230px;
        line-height: 25px;
    }

    .form-control:focus {
        border-color: #C3C3C3;
        outline: none;
        background-color: #F6F6F6;
        box-shadow: none;
    }

    /* Override validation styling - no green border */
    .form-control:valid,
    .form-control.valid,
    .form-control.modified.valid {
        border-color: #C3C3C3;
        background-image: none;
        box-shadow: none;
    }

    .form-control:invalid,
    .form-control.invalid,
    .form-control.modified.invalid {
        border-color: #C3C3C3;
        background-image: none;
        box-shadow: none;
    }

    .form-group p {
        font-size: 12px;
        color: #737373;
        margin: 4px 0 8px 0;
        text-align: left;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin-bottom: 20px;
    }

    /* Input wrapper for icon positioning */
    .input-wrapper {
        position: relative;
        width: 100%;
    }

    /* Info icon inside input */
    .input-info-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .input-info-icon.textarea-icon {
        top: 18px;
        transform: none;
    }

    /* Character count helper text below input */
    .char-count-helper {
        display: block;
        text-align: right;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 400;
        color: #5C5C5C;
        margin-top: 8px;
    }

    /* Responsive Fix */
    @@media (max-width: 768px) {
        .wizard-content {
            padding: 40px 20px;
        }

        .form-control {
            font-size: 14px;
        }

        .form-group label {
            font-size: 14px;
        }
    }
</style>

