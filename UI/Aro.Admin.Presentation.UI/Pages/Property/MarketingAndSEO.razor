@page "/property/marketing-seo"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using MudBlazor
@using Aro.UI.Application.DTOs
@using Aro.Admin.Presentation.UI.Services
@using Aro.Admin.Presentation.UI.Shared
@layout WizardLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject IWizardNavigationService WizardNavigationService

<div class="property-wizard-container">
    <!-- Header Bar -->
    <div class="col-12 card-bg-dark">
        <WizardHeader HeaderTitle="@Title"
                      OnClose="HandleClose" />
    </div>
    <div class="wizard-body">
        <!-- Sidebar Navigation -->
        <div class="d-none d-md-block col-xl-2  border-end bg-white">
            <WizardSteps StepTitles="@stepTitles"
                         ActiveStepIndex="4"
                         IsEditMode="@wizardModel.IsEditMode"
                         OnStepClick="HandleStepClick" />
        </div>

        <!-- Main Content Area -->
        <div class="wizard-content">
            <div class="content-header">
                <p class="step-label">Step 5</p>
                <h2 class="content-title">Meta Title & Description</h2>
            </div>


            <!-- Marketing Form Fields -->
            <EditForm Model="@wizardModel" OnValidSubmit="@HandleNext">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <!-- Meta Title Input -->
                <div class="form-group">
                    <label for="metaTitle">Meta Title</label>
                    <div class="input-wrapper">
                        <input type="text" id="metaTitle" class="form-control form-control-with-icon" maxlength="@MaxTitleLength" placeholder="Enter meta title" @bind="wizardModel.MarketingTitle" @bind:event="oninput" @onfocus="() => isTitleFocused = true" @onblur="() => OnTitleBlur()" />
                        <span class="input-info-icon" title="This title appears on the browser tab and in search engine results. Keep it short and descriptive.">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.88201 0C3.5292 0 0 3.58332 0 8C0 12.4193 3.5292 16 7.88201 16C12.2348 16 15.764 12.4193 15.764 8C15.764 3.58332 12.2348 0 7.88201 0ZM7.88201 3.54839C8.61923 3.54839 9.21686 4.15497 9.21686 4.90323C9.21686 5.65148 8.61923 6.25806 7.88201 6.25806C7.14478 6.25806 6.54715 5.65148 6.54715 4.90323C6.54715 4.15497 7.14478 3.54839 7.88201 3.54839ZM9.66181 11.7419C9.66181 11.9557 9.49105 12.129 9.28043 12.129H6.48359C6.27296 12.129 6.1022 11.9557 6.1022 11.7419V10.9677C6.1022 10.754 6.27296 10.5806 6.48359 10.5806H6.86497V8.51613H6.48359C6.27296 8.51613 6.1022 8.34281 6.1022 8.12903V7.35484C6.1022 7.14106 6.27296 6.96774 6.48359 6.96774H8.51765C8.72827 6.96774 8.89904 7.14106 8.89904 7.35484V10.5806H9.28043C9.49105 10.5806 9.66181 10.754 9.66181 10.9677V11.7419Z" fill="#434343" fill-opacity="0.75"/>
                            </svg>
                        </span>
                    </div>
                    @if (string.IsNullOrEmpty(wizardModel.MarketingTitle))
                    {
                        <span class="char-count-helper">Max @MaxTitleLength characters.</span>
                    }
                    else
                    {
                        <span class="char-count-helper">@GetTitleRemainingChars() characters remaining</span>
                    }
                </div>

                <!-- Meta Description -->
                <div class="form-group mt-3">
                    <label for="meta">Meta description</label>
                    <div class="input-wrapper">
                        <textarea id="meta" class="form-control form-control-textarea" maxlength="@MaxDescriptionLength" rows="8" placeholder="Enter meta description" @bind="wizardModel.MarketingDescription" @bind:event="oninput" @onfocus="() => isDescriptionFocused = true" @onblur="() => OnDescriptionBlur()"></textarea>
                        <span class="input-info-icon textarea-icon" title="This short description may appear in Google search results to summarise your property.">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.88201 0C3.5292 0 0 3.58332 0 8C0 12.4193 3.5292 16 7.88201 16C12.2348 16 15.764 12.4193 15.764 8C15.764 3.58332 12.2348 0 7.88201 0ZM7.88201 3.54839C8.61923 3.54839 9.21686 4.15497 9.21686 4.90323C9.21686 5.65148 8.61923 6.25806 7.88201 6.25806C7.14478 6.25806 6.54715 5.65148 6.54715 4.90323C6.54715 4.15497 7.14478 3.54839 7.88201 3.54839ZM9.66181 11.7419C9.66181 11.9557 9.49105 12.129 9.28043 12.129H6.48359C6.27296 12.129 6.1022 11.9557 6.1022 11.7419V10.9677C6.1022 10.754 6.27296 10.5806 6.48359 10.5806H6.86497V8.51613H6.48359C6.27296 8.51613 6.1022 8.34281 6.1022 8.12903V7.35484C6.1022 7.14106 6.27296 6.96774 6.48359 6.96774H8.51765C8.72827 6.96774 8.89904 7.14106 8.89904 7.35484V10.5806H9.28043C9.49105 10.5806 9.66181 10.754 9.66181 10.9677V11.7419Z" fill="#434343" fill-opacity="0.75"/>
                            </svg>
                        </span>
                    </div>
                    @if (string.IsNullOrEmpty(wizardModel.MarketingDescription))
                    {
                        <span class="char-count-helper">Max @MaxDescriptionLength characters.</span>
                    }
                    else
                    {
                        <span class="char-count-helper">@GetDescriptionRemainingChars() characters remaining</span>
                    }
                </div>
            </EditForm>

            <!-- Footer Buttons (separated) -->
            <WizardFooter OnBack="HandleBack"
                          OnNext="HandleNext"
                          OnSave="HandleSave"
                          BackDisabled="false"
                          NextDisabled="false"
                          SaveDisabled="false"
                          ShowSave="@wizardModel.IsEditMode" />
        </div>
    </div>

</div>
@code {
    private const int MaxTitleLength = 60;
    private const int MaxDescriptionLength = 160;
    private PropertyWizardModel wizardModel = new();
    private bool isTitleFocused = false;
    private bool isDescriptionFocused = false;
    private Guid? _currentGroupId = null;
    private Guid? _currentPropertyId = null;
    private string _originalStateHash = string.Empty;
    private string Title => $"{(wizardModel.IsEditMode ? "Edit" : "Add New")} Property";

    private readonly List<string> stepTitles = new()
    {
        "Property Information",
        "Address & Primary Contact",
        "Key Selling Points",
        "Media Files",
        "Marketing & SEO",
        "Review & Save"
    };

    private readonly string[] stepRoutes = new[]
    {
        "/property/information",
        "/property/address-contact",
        "/property/key-selling-points",
        "/property/media-files",
        "/property/marketing-seo",
        "/property/review-save"
    };

    private int GetTitleRemainingChars() => MaxTitleLength - (wizardModel.MarketingTitle?.Length ?? 0);
    private int GetDescriptionRemainingChars() => MaxDescriptionLength - (wizardModel.MarketingDescription?.Length ?? 0);

    private void OnTitleBlur()
    {
        isTitleFocused = false;
        // Don't save on every blur - save only on navigation
    }

    private void OnDescriptionBlur()
    {
        isDescriptionFocused = false;
        // Don't save on every blur - save only on navigation
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromLocalStorage();
            StateHasChanged();
        }
    }

    private string GetStorageKey() => PropertyWizardModel.GetLocalStorageKey(_currentGroupId, _currentPropertyId);

    private string ComputeCurrentStateHash()
    {
        return $"{wizardModel.MarketingTitle}|{wizardModel.MarketingDescription}";
    }

    private bool HasUnsavedChanges() => _originalStateHash != ComputeCurrentStateHash();

    private bool HasWizardProgress()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.PropertyName) ||
               !string.IsNullOrWhiteSpace(wizardModel.AddressLine1) ||
               !string.IsNullOrWhiteSpace(wizardModel.MarketingTitle) ||
               !string.IsNullOrWhiteSpace(wizardModel.MarketingDescription);
    }

    private async Task LoadFromLocalStorage()
    {
        try
        {
            // FIRST: Always try to get GroupId from SelectedGroupId in localStorage
            var groupIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "SelectedGroupId");
            if (!string.IsNullOrEmpty(groupIdStr) && Guid.TryParse(groupIdStr, out var parsedGroupId))
            {
                _currentGroupId = parsedGroupId;
            }

            // Get CurrentPropertyId for edit mode
            var propertyIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "CurrentPropertyId");
            if (!string.IsNullOrEmpty(propertyIdStr) && Guid.TryParse(propertyIdStr, out var parsedPropertyId))
            {
                _currentPropertyId = parsedPropertyId;
            }

            // Now load the wizard data with the correct storage key
            var storageKey = GetStorageKey();
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var savedModel = JsonSerializer.Deserialize<PropertyWizardModel>(json);
                if (savedModel != null)
                {
                    wizardModel = savedModel;

                    // Sync _currentGroupId from wizardModel if still not set
                    if (!_currentGroupId.HasValue && wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
                    {
                        _currentGroupId = wizardModel.GroupId;
                        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", _currentGroupId.Value.ToString());
                    }
                }
            }

            // Ensure wizardModel.GroupId is set
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            _originalStateHash = ComputeCurrentStateHash();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private async Task SaveToLocalStorage()
    {
        try
        {
            // Ensure GroupId is preserved
            if (_currentGroupId.HasValue && _currentGroupId.Value != Guid.Empty)
            {
                wizardModel.GroupId = _currentGroupId;
            }

            // Always ensure SelectedGroupId is saved for subsequent pages
            if (wizardModel.GroupId.HasValue && wizardModel.GroupId.Value != Guid.Empty)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "SelectedGroupId", wizardModel.GroupId.Value.ToString());
                _currentGroupId = wizardModel.GroupId;
            }

            wizardModel.CurrentStep = 5;
            var storageKey = GetStorageKey();
            var json = JsonSerializer.Serialize(wizardModel);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, json);
            _originalStateHash = ComputeCurrentStateHash();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    private async Task HandleClose()
    {
        bool hasChangesOrProgress = HasUnsavedChanges() || HasWizardProgress();

        if (!hasChangesOrProgress)
        {
            await CloseAndNavigate();
            return;
        }

        // Show Unsaved Changes modal
        var parameters = new DialogParameters
        {
            { "ShowSaveAndContinue", false }
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            MaxWidth = MaxWidth.Small,
        };

        var dialog = await DialogService.ShowAsync<UnsavedChangesModal>(
            "Unsaved Changes",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (result == null || result.Canceled)
            return;

        var action = (UnsavedChangesModal.UnsavedChangesResult)result.Data!;

        switch (action)
        {
            case UnsavedChangesModal.UnsavedChangesResult.Discard:
                await CloseAndNavigate();
                break;

            case UnsavedChangesModal.UnsavedChangesResult.Cancel:
                // Do nothing
                break;
        }
    }

    private async Task CloseAndNavigate()
    {
        var groupIdString = await JSRuntime.InvokeAsync<string>(
            "localStorage.getItem",
            "SelectedGroupId"
        );

        if (string.IsNullOrWhiteSpace(groupIdString) ||
            !Guid.TryParse(groupIdString, out var groupId))
        {
            return;
        }

        var storageKey = GetStorageKey();
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", storageKey);
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "CurrentPropertyId");

        NavigationManager.NavigateTo($"/group/view/{groupId}");
    }
    // Validation - requires both meta title and description
    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(wizardModel.MarketingTitle) &&
               !string.IsNullOrWhiteSpace(wizardModel.MarketingDescription);
    }

    private async Task HandleBack()
    {
        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            "/property/media-files");
    }

    private async Task HandleNext()
    {
        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            "/property/review-save");
    }

    private async Task HandleSave()
    {
        await SaveToLocalStorage();
        NavigationManager.NavigateTo("/property/review-save");
    }

    private async Task HandleStepClick(int stepIndex)
    {
        if (!wizardModel.IsEditMode) return;

        await WizardNavigationService.NavigateWithUnsavedChangesCheckAsync(
            wizardModel.IsEditMode,
            HasUnsavedChanges(),
            SaveToLocalStorage,
            stepRoutes[stepIndex]);
    }
}
<style>
    /* Main Container */
    .property-wizard-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #FFFFFF;
    }

    /* Header Bar - Dark Gray */
    .wizard-header {
        background: #434343;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
    }

    .card-bg-dark {
        background-color: #434343;
        color: white;
    }
    .header-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #FFFFFF;
        margin: 0;
    }

    .close-icon {
        cursor: pointer;
        padding: 8px;
    }

    /* Body Container */
    .wizard-body {
        display: flex;
        flex: 1;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Left Sidebar - Light Gray */
    .wizard-sidebar {
        width: 246px;
        background: #FFFF;
        padding: 40px 20px;
        border-right: 1px solid #B3B3B3;
    }

    .wizard-steps {
        display: flex;
        flex-direction: column;
    }

    .wizard-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 32px;
        position: relative;
    }

        .wizard-step:last-child {
            margin-bottom: 0;
        }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-right: 16px;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #D9D9D9;
        border: 1px solid rgba(0, 0, 0, 0.47);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        color: #000000;
        z-index: 2;
    }

    .wizard-step.completed .step-number {
        background: #FF931E;
        border: none;
    }

    .step-number.completed-check {
        background: #FF931E;
        border: none;
    }

    .wizard-step.active .step-number {
        background: #FFFFFF;
        border: 1px solid #FF931E;
    }

    .step-line {
        width: 2px;
        height: 60px;
        background: #D9D9D9;
        position: absolute;
        top: 50px;
        left: 24px;
        z-index: 1;
    }

        .step-line.completed {
            background: #737373;
            border: 1px solid #737373;
        }

    /*   .wizard-step.active .step-line {
                background: #D9D9D9;
            }  */

    .wizard-step:last-child .step-line {
        background: #FFFF;
    }

    .step-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 26px;
        color: #000000;
        padding-top: 12px;
    }

    .wizard-step.active .step-title {
        font-weight: 600;
    }

    /* Main Content Area */

    .wizard-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #F6F6F6;
        padding: 48px !important;
                overflow-x:hidden;

        overflow-y: auto;
    }

    /* Matches styling in other steps */
    .instruction-text {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #737373;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 24px;
        width: 50%;
    }

        .form-group label {
            font-size: 16px;
            font-weight: 400;
            color: #000;
            margin-bottom: 8px;
        }

    .step-label {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 19px;
        color: #000000;
        margin: 0 0 8px 0;
    }

    .form-control {
        font-size: 16px;
        padding: 12px 18px;
        border: 1px solid #C3C3C3;
        border-radius: 8px;
        background-color: #F6F6F6;
        resize: none;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        line-height: 19px;
        color: #000000;
    }

    /* Placeholder styling */
    .form-control::placeholder {
        color: #737373;
        opacity: 1;
    }

    .form-control::-webkit-input-placeholder {
        color: #737373;
    }

    .form-control::-moz-placeholder {
        color: #737373;
    }

    .form-control:-ms-input-placeholder {
        color: #737373;
    }

    .form-control-with-icon {
        padding-right: 48px;
        height: 50px;
    }

    .form-control-textarea {
        padding-right: 48px;
        min-height: 230px;
        line-height: 25px;
    }

    .form-control:focus {
        border-color: #C3C3C3;
        outline: none;
        background-color: #F6F6F6;
        box-shadow: none;
    }

    /* Override validation styling - no green border */
    .form-control:valid,
    .form-control.valid,
    .form-control.modified.valid {
        border-color: #C3C3C3;
        background-image: none;
        box-shadow: none;
    }

    .form-control:invalid,
    .form-control.invalid,
    .form-control.modified.invalid {
        border-color: #C3C3C3;
        background-image: none;
        box-shadow: none;
    }

    .form-group p {
        font-size: 12px;
        color: #737373;
        margin: 4px 0 8px 0;
        text-align: left;
    }

    .content-title {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 29px;
        color: #000000;
        margin-bottom: 20px;
    }

    /* Input wrapper for icon positioning */
    .input-wrapper {
        position: relative;
        width: 100%;
    }

    /* Info icon inside input */
    .input-info-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .input-info-icon.textarea-icon {
        top: 18px;
        transform: none;
    }

    /* Character count helper text below input */
    .char-count-helper {
        display: block;
        text-align: right;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 400;
        color: #5C5C5C;
        margin-top: 8px;
    }

    /* Mobile Responsive Styles */
    @@media (max-width: 768px) {
        .wizard-content {
            padding: 24px !important;
            padding-bottom: 140px !important;
        }

        .content-title {
            font-size: 20px;
            line-height: 24px;
        }

        .step-label {
            font-size: 14px;
        }

        .form-group {
            width: 100%;
        }

        .form-control {
            font-size: 14px;
        }

        .form-group label {
            font-size: 14px;
        }

        .char-count-helper {
            font-size: 13px;
        }
    }

    @@media (max-width: 480px) {
        .wizard-content {
            padding: 16px !important;
            padding-bottom: 140px !important;
        }

        .content-title {
            font-size: 18px;
            line-height: 22px;
            margin-bottom: 16px;
        }

        .step-label {
            font-size: 13px;
        }

        .form-group {
            width: 100%;
            margin-bottom: 16px;
        }

        .form-group label {
            font-size: 13px;
            margin-bottom: 6px;
        }

        .form-control {
            font-size: 13px;
            padding: 10px 14px;
        }

        .form-control-with-icon {
            padding-right: 40px;
            height: 44px;
        }

        .form-control-textarea {
            padding-right: 40px;
            min-height: 180px;
            line-height: 22px;
        }

        .input-info-icon {
            right: 12px;
        }

        .input-info-icon svg {
            width: 14px;
            height: 14px;
        }

        .char-count-helper {
            font-size: 12px;
            margin-top: 6px;
        }
    }

    @@media (max-width: 390px) {
        .wizard-content {
            padding: 12px !important;
            padding-bottom: 140px !important;
        }

        .content-header {
            margin-bottom: 12px;
        }

        .content-title {
            font-size: 16px;
            line-height: 20px;
            margin-bottom: 12px;
        }

        .step-label {
            font-size: 12px;
        }

        .form-group label {
            font-size: 12px;
        }

        .form-control {
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .form-control-with-icon {
            padding-right: 36px;
            height: 40px;
        }

        .form-control-textarea {
            padding-right: 36px;
            min-height: 150px;
            line-height: 20px;
        }

        .input-info-icon {
            right: 10px;
        }

        .input-info-icon svg {
            width: 12px;
            height: 12px;
        }

        .char-count-helper {
            font-size: 11px;
        }
    }
</style>

