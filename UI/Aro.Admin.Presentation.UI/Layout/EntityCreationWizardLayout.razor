@typeparam TEntity
@inherits LayoutComponentBase
@using System.Text.Json
@using Aro.Admin.Presentation.UI.Shared
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<CascadingValue Value="Wizard">
<div class="full-screen-overlay">
    <div class="row g-0 h-100">
        <!-- Wizard Header -->
        <div class="col-12 card-bg-dark">
            <WizardHeader 
                HeaderTitle="@Title"
                              OnClose="@HandleClose" />
        </div>
        <!-- Wizard Steps (Sidebar) -->
        <div class="d-none d-md-block col-xl-2  border-end bg-white">
            <WizardSteps StepTitles="Wizard.StepTitles"
                            ActiveStepIndex="Wizard.ActiveStepIndex"
                            AllStepsCompleted="Wizard.EntityCreationComplete" />
        </div>

        <!-- Child content -->
        <div class="col-xl-10 h-100 overflow-y-auto">
            <div class="wizard-content p-5">
                @ChildContent
            </div>
        </div>

    </div>
</div>

</CascadingValue>

<style>
    .full-screen-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #F6F6F6;
        overflow: hidden
    }

    .card-bg-dark {
        background-color: #434343;
        color: white;
    }

    .wizard-content {
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        padding-bottom: 120px;
    }

    .step-title-container {
        margin-bottom: 40px !important;
    }

    .mud-input > input.mud-input-root-outlined.mud-input-root-margin-dense, div.mud-input-slot.mud-input-root-outlined.mud-input-root-margin-dense {
        padding-top: 12.9px;
        padding-bottom: 12.9px;
        padding-left: 18px !important;
        padding-right: 18px !important;
    }

    .form-group {
        margin-bottom: 24px;
    }

</style>

@code {
    [Parameter] public EntityWizardContext<TEntity> Wizard { get; set; } = default!;

    [Parameter] public RenderFragment? ChildContent { get; set; }

    private string Title => $"{(Wizard.IsCreateMode && !Wizard.IsDuplicateMode ? "Add New" : (Wizard.IsDuplicateMode ? "Duplicate" : "Edit"))} {Wizard.Title}";

    private bool HasUnsavedChanges()
    {
        if (Wizard.Entity == null || Wizard.PrevEntity == null)
            return false;

        try
        {
            var currentJson = JsonSerializer.Serialize(Wizard.Entity);
            var previousJson = JsonSerializer.Serialize(Wizard.PrevEntity);
            return currentJson != previousJson;
        }
        catch
        {
            return false;
        }
    }

    private bool HasWizardProgress()
    {
        if (Wizard.Entity == null)
            return false;

        try
        {
            var currentJson = JsonSerializer.Serialize(Wizard.Entity);
            var emptyEntityJson = "{}";

            if (currentJson == emptyEntityJson || currentJson == "null")
                return false;

            var defaultEntity = Activator.CreateInstance<TEntity>();
            var defaultJson = JsonSerializer.Serialize(defaultEntity);

            return currentJson != defaultJson;
        }
        catch
        {
            return false;
        }
    }

    private async Task HandleClose()
    {
        bool hasChangesOrProgress = HasUnsavedChanges() || HasWizardProgress();

        if (hasChangesOrProgress)
        {
            var parameters = new DialogParameters
            {
                { "ShowSaveAndContinue", false }
            };

            var options = new DialogOptions
            {
                CloseButton = false,
                MaxWidth = MaxWidth.Small,
            };

            var dialog = await DialogService.ShowAsync<UnsavedChangesModal>(
                "Unsaved Changes",
                parameters,
                options
            );

            var result = await dialog.Result;

            if (result == null || result.Canceled)
                return;

            var action = (UnsavedChangesModal.UnsavedChangesResult)result.Data!;

            switch (action)
            {
                case UnsavedChangesModal.UnsavedChangesResult.Discard:
                    NavigateAway();
                    break;
                case UnsavedChangesModal.UnsavedChangesResult.Cancel:
                    break;
            }
        }
        else
        {
            NavigateAway();
        }
    }

    private void NavigateAway()
    {
        if (Wizard.Title.Contains("Group"))
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            NavigationManager.NavigateTo(Wizard.NavigateTo);
        }
    }
}
