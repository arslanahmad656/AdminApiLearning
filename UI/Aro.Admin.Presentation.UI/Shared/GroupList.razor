@using Aro.UI.Application.DTOs.Group
@inject IGroupService GroupService
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<div class="h-100 card bg-white shadow">
    <div class="card-body d-flex flex-column gap-3 h-100">

        <!-- Header -->
        <div class="hstack p-3">
            <div><h1>Group List</h1></div>
            <div class="ms-auto">
                <button class="aro-button aro-button-primary"
                        @onclick="HandleAddGroup">
                    Add Client +
                </button>
            </div>
        </div>


        <!-- Alphabet filter -->
        <div class="h-stack">
            @foreach (char letter in alpha)
            {
                var letterString = letter.ToString();
                var isActive = selectedLetter == letterString;

                <MudButton Variant="Variant.Text"
                           Class="@(isActive ? "border" : "")"
                           Style="min-width: calc(100% / 26)"
                           @onclick="() => SetOption(letterString)">
                    @letter
                </MudButton>
            }
        </div>

        <!-- Activity toggle -->
        <div class="d-flex ps-5">
            <MudToggleGroup T="string"
                            Value="ActivityFilter"
                            ValueChanged="OnActivityFilterChanged"
                            Color="Color.Dark"
                            Size="Size.Small">
                <MudToggleItem Value="@("All")" UnselectedIcon="@Icons.Material.Filled.CheckBoxOutlineBlank" SelectedIcon="@Icons.Material.Filled.CheckBox"><MudText>All</MudText></MudToggleItem>
                <MudToggleItem Value="@("Active")" UnselectedIcon="@Icons.Material.Filled.CheckBoxOutlineBlank" SelectedIcon="@Icons.Material.Filled.CheckBox"><MudText>Active</MudText></MudToggleItem>
                <MudToggleItem Value="@("Inactive")" UnselectedIcon="@Icons.Material.Filled.CheckBoxOutlineBlank" SelectedIcon="@Icons.Material.Filled.CheckBox"><MudText>Inactive</MudText></MudToggleItem>

            </MudToggleGroup>
        </div>


        @if (tableRows.Count() > 0)
        {
            <MudTable Items="@tableRows"
                      Hover
                      @bind-SelectedItem="selectedRow"
                      Class="shadow-none h-100"
                      LoadingContent="@(isLoading? loadingContent : null)"
                      LoadingContentBody="@(isLoading? loadingContentBody : null)"
                      LoadingProgressColor="Color.Info">
                @* <ToolBarContent>

                <MudText Typo="Typo.h6">GroupList</MudText>
                <MudSpacer /> 

                <MudTextField 
                @bind-Value="searchString1" 
                Placeholder="Search" 
                Adornment="Adornment.Start" 
                AdornmentIcon="@Icons.Material.Filled.Search" 
                IconSize="Size.Medium" 
                Class="mt-0"></MudTextField>

                </ToolBarContent> *@
                <ColGroup>
                    <col />
                    <col />
                    <col style="width: 30%" />
                    <col />
                    <col />
                </ColGroup>
                <HeaderContent>
                    <MudTh><MudTableSortLabel Enabled="true" SortBy="new Func<GroupTableRow, object>(x => x.GroupName)">Client Name</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel Enabled="true" SortBy="new Func<GroupTableRow, object>(x => x.PrimaryContactName)">Contact</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel Enabled="true" SortBy="new Func<GroupTableRow, object>(x => x.PrimaryContactEmail)">Email</MudTableSortLabel></MudTh>
                    <MudTh>Website</MudTh>
                    <MudTh><MudTableSortLabel Enabled="true" SortBy="new Func<GroupTableRow, object>(x => x.IsActive)">Status</MudTableSortLabel></MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Client Name">
                        <div class="hstack align-items-center gap-3">

                            <Logo LogoUrl="@context.LogoUrl" Name="@context.GroupName" />

                            <MudButton Variant="Variant.Text"
                                       OnClick="@(e => GoToGroupView(context.Id))"
                                       Class="pagination-button">
                                @context.GroupName
                            </MudButton>
                        </div>


                    </MudTd>

                    <MudTd DataLabel="Contact">@context.PrimaryContactName</MudTd>
                    <MudTd DataLabel="Email">@context.PrimaryContactEmail</MudTd>
                    <MudTd DataLabel="Website">

                        @* @context.WebsiteURL *@

                        <button @onclick="@(e => GoToWebsite(context.Id))">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <mask id="mask0_1022_2354" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                                    <rect width="24" height="24" fill="#D9D9D9" />
                                </mask>
                                <g mask="url(#mask0_1022_2354)">
                                    <path d="M20.95 22.375L18 19.425V21.65H16V16H21.65V18H19.4L22.35 20.95L20.95 22.375ZM12 22C10.6167 22 9.31667 21.7375 8.1 21.2125C6.88333 20.6875 5.825 19.975 4.925 19.075C4.025 18.175 3.3125 17.1167 2.7875 15.9C2.2625 14.6833 2 13.3833 2 12C2 10.6167 2.2625 9.31667 2.7875 8.1C3.3125 6.88333 4.025 5.825 4.925 4.925C5.825 4.025 6.88333 3.3125 8.1 2.7875C9.31667 2.2625 10.6167 2 12 2C13.3833 2 14.6833 2.2625 15.9 2.7875C17.1167 3.3125 18.175 4.025 19.075 4.925C19.975 5.825 20.6875 6.88333 21.2125 8.1C21.7375 9.31667 22 10.6167 22 12C22 12.3333 21.9833 12.6667 21.95 13C21.9167 13.3333 21.8667 13.6667 21.8 14H19.75C19.8333 13.6667 19.8958 13.3333 19.9375 13C19.9792 12.6667 20 12.3333 20 12C20 11.6667 19.9792 11.3333 19.9375 11C19.8958 10.6667 19.8333 10.3333 19.75 10H16.35C16.4 10.3333 16.4375 10.6667 16.4625 11C16.4875 11.3333 16.5 11.6667 16.5 12C16.5 12.3333 16.4875 12.6667 16.4625 13C16.4375 13.3333 16.4 13.6667 16.35 14H14.35C14.4 13.6667 14.4375 13.3333 14.4625 13C14.4875 12.6667 14.5 12.3333 14.5 12C14.5 11.6667 14.4875 11.3333 14.4625 11C14.4375 10.6667 14.4 10.3333 14.35 10H9.65C9.6 10.3333 9.5625 10.6667 9.5375 11C9.5125 11.3333 9.5 11.6667 9.5 12C9.5 12.3333 9.5125 12.6667 9.5375 13C9.5625 13.3333 9.6 13.6667 9.65 14H13V16H10.1C10.3 16.7167 10.5583 17.4042 10.875 18.0625C11.1917 18.7208 11.5667 19.35 12 19.95C12.3333 19.95 12.6667 19.9292 13 19.8875C13.3333 19.8458 13.6667 19.8083 14 19.775V21.825C13.6667 21.8583 13.3333 21.8958 13 21.9375C12.6667 21.9792 12.3333 22 12 22ZM4.25 14H7.65C7.6 13.6667 7.5625 13.3333 7.5375 13C7.5125 12.6667 7.5 12.3333 7.5 12C7.5 11.6667 7.5125 11.3333 7.5375 11C7.5625 10.6667 7.6 10.3333 7.65 10H4.25C4.16667 10.3333 4.10417 10.6667 4.0625 11C4.02083 11.3333 4 11.6667 4 12C4 12.3333 4.02083 12.6667 4.0625 13C4.10417 13.3333 4.16667 13.6667 4.25 14ZM5.1 8H8.05C8.2 7.38333 8.3875 6.77917 8.6125 6.1875C8.8375 5.59583 9.1 5.01667 9.4 4.45C8.48333 4.75 7.65833 5.20417 6.925 5.8125C6.19167 6.42083 5.58333 7.15 5.1 8ZM9.4 19.55C9.1 18.9833 8.8375 18.4042 8.6125 17.8125C8.3875 17.2208 8.2 16.6167 8.05 16H5.1C5.58333 16.85 6.19167 17.5792 6.925 18.1875C7.65833 18.7958 8.48333 19.25 9.4 19.55ZM10.1 8H13.9C13.7 7.28333 13.4417 6.59583 13.125 5.9375C12.8083 5.27917 12.4333 4.65 12 4.05C11.5667 4.65 11.1917 5.27917 10.875 5.9375C10.5583 6.59583 10.3 7.28333 10.1 8ZM15.95 8H18.9C18.4167 7.15 17.8083 6.42083 17.075 5.8125C16.3417 5.20417 15.5167 4.75 14.6 4.45C14.9 5.01667 15.1625 5.59583 15.3875 6.1875C15.6125 6.77917 15.8 7.38333 15.95 8Z" fill="#1C1B1F" />
                                </g>
                            </svg>
                        </button>



                    </MudTd>
                    <MudTd DataLabel="Status">
                        <button @onclick="@(e => ChangeClientActivity(context))"
                                class="aro-status-button @(context.IsActive ? "active" : "inactive")">
                            @(context.IsActive ? "Active" : "Inactive")
                        </button>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <div class="h-stack">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete" @onclick="@(e => DeleteGroup(context.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" aria-label="edit" @onclick="@(e => GoToEditGroup(context.Id))" />
                        </div>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    @* Custom pagination controls *@
                </PagerContent>
            </MudTable>

            <div class="mt-auto d-flex align-items-end justify-content-end">

                <span class="me-auto small text-muted">
                    @infoFormat
                </span>

                @*                         
                <MudButton 
                    Variant="Variant.Text"
                    OnClick="@FirstPage"
                    Disabled="@(currentPage == 1)"
                    Class="pagination-button"
                >
                    &lt; &lt;
                </MudButton> 
                *@


                <MudButton Variant="Variant.Text"
                           OnClick="@PrevPage"
                           Disabled="@(currentPage == 1)"
                           Class="pagination-button">
                    &lt;
                </MudButton>

                @* Pagination numbers *@
                @for (int i = 1; i <= lastPage; i++)
                {
                    var page = i;
                    var isActive = page == currentPage;

                    <MudButton Variant="Variant.Text"
                               Disabled="@(isActive)"
                               @onclick="@(e => GoToPage(page))"
                               Class="@(isActive ? "pagination-button active" : "pagination-button")">
                        @(page)
                    </MudButton>
                }

                <MudButton Variant="Variant.Text"
                           OnClick="@NextPage"
                           Disabled="@(currentPage == lastPage)"
                           Class="pagination-button">
                    &gt;
                </MudButton>

                @*                         
                <MudButton 
                    Variant="Variant.Text"
                    OnClick="@LastPage"
                    Disabled="@(currentPage == lastPage)"
                            Class="pagination-button">
                    &gt; &gt;
                </MudButton> 
                *@

            </div>
        }
        else
        {
            <div class="w-100 d-flex justify-content-center align-items-center" style="height: 200px">
                <span>Nothing to show</span>
            </div>
        }

    </div>
</div>

@code {
    [Inject] private NavigationManager? NavigationManager { get; set; }

    [Parameter] public string ClientFilter { get; set; } = string.Empty;

    private string selectedLetter = string.Empty;

    private string searchString1 = "";
    private string infoFormat = string.Empty;

    char[] alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".ToCharArray();

    private string ActivityFilter = "All";

    private GroupTableRow selectedRow;

    private bool isLoading = true;

    private readonly RenderFragment loadingContent = @<MudSkeleton />;
    private readonly RenderFragment loadingContentBody = @<text>
@for (int r = 0; r< 4; r++) // 4 fake rows
    {
    <MudTr>
        @for (int c = 0; c< 5; c++) // 5 columns as above
                {
        <MudTd><MudSkeleton /></MudTd>
                }
    </MudTr>
    }
</text>
    ;

private List<GroupTableRow> _allRows = new List<GroupTableRow>();
private List<GroupTableRow> tableRows = new List<GroupTableRow>();


private int currentPage = 1;
private const int pageSize = 10;
private int totalEntries = 0;
private int lastPage => (int)Math.Ceiling((double)totalEntries / pageSize);

protected override async Task OnInitializedAsync()
{
    await LoadAllGroups();
    ApplyFiltersAndPaging();
}

protected override void OnParametersSet()
{
    currentPage = 1;
    ApplyFiltersAndPaging();
}

private string cachedApiBaseAddress => Configuration["ApiBaseAddress"]?.TrimEnd('/') ?? "https://localhost:7225";

private async Task LoadAllGroups()
{
    try
    {
        isLoading = true;

        // Retrieve all records, no paging
        GetGroupsRequest groupsRequest = new(
            selectedLetter,
            "PrimaryContact,PrimaryContact.ContactInfo",
            currentPage,
            int.MaxValue,
            string.Empty,
            true);

        var response = await GroupService.GetGroups(groupsRequest);

        if (response is null || response.Groups is null)
        {
            _allRows = [];
            totalEntries = 0;
        }
        else
        {


            _allRows = response.Groups
                .Select(g => new GroupTableRow
                {
                    Id = g.Id,
                    GroupName = g.GroupName,
                    PrimaryContactId = g.PrimaryContactId,
                    PrimaryContactName = g.PrimaryContactName,
                    PrimaryContactEmail = g.PrimaryContactEmail,
                    WebsiteURL = string.Empty,
                    IsActive = g.IsActive,
                    LogoUrl = g.LogoId.HasValue ? $"{cachedApiBaseAddress}/api/group/image/{g.Id}/{g.LogoId.Value}" : string.Empty

                })
                .ToList();
            totalEntries = response.TotalCount;
        }

        isLoading = false;

    }
    catch (HttpRequestException httpEx)
    {
        Snackbar.Add($"Network/API error: {httpEx.Message}", MudBlazor.Severity.Error);
    }
    catch (Exception ex)
    {
        Snackbar.Add($"Unexpected error: {ex.Message}", MudBlazor.Severity.Error);
    }
}

private void OnActivityFilterChanged(string value)
{
    ActivityFilter = value;
    currentPage = 1;
    ApplyFiltersAndPaging();
}


private void ApplyFiltersAndPaging()
{
    IEnumerable<GroupTableRow> query = _allRows;

    // Letter filter
    if (!string.IsNullOrWhiteSpace(selectedLetter))
    {
        query = query.Where(x =>
            x.GroupName.StartsWith(selectedLetter, StringComparison.OrdinalIgnoreCase));
    }

    // Debounced search filter
    if (!string.IsNullOrWhiteSpace(ClientFilter))
    {
        query = query.Where(x => x.GroupName?.Contains(ClientFilter, StringComparison.OrdinalIgnoreCase) ?? false);
        // (x.PrimaryContactName?.Contains(_effectiveSearch, StringComparison.OrdinalIgnoreCase) ?? false) ||
        // (x.PrimaryContactEmail?.Contains(_effectiveSearch, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    switch (ActivityFilter)
    {
        case "All":
            break;

        case "Active":
            query = query.Where(x => x.IsActive);
            break;

        case "Inactive":
            query = query.Where(x => !x.IsActive);
            break;
    }

    totalEntries = query.Count();

    tableRows = query
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    infoFormat = $"Showing {(tableRows.Count == 0 ? 0 : (currentPage - 1) * pageSize + 1)} to {(currentPage - 1) * pageSize + tableRows.Count} of {totalEntries} entries";
}



private async void PageChanged(int page)
{
    currentPage = page;
    ApplyFiltersAndPaging();
}

private async void FirstPage()
{
    if (currentPage != 1)
    {
        PageChanged(1);
    }
}

private async void PrevPage()
{
    if (currentPage > 1)
    {
        PageChanged(currentPage - 1);
    }
}

private async void NextPage()
{
    if (currentPage < lastPage)
    {
        PageChanged(currentPage + 1);
    }

}

private async void LastPage()
{
    if (currentPage != lastPage)
    {
        PageChanged(lastPage);
    }
}

private async void GoToPage(int pageNumber)
{

    if (currentPage != pageNumber && pageNumber >= 1 && pageNumber <= lastPage)
    {
        PageChanged(pageNumber);
    }
}



private void HandleAddGroup()
{
    // Navigate to add group page or show dialog
    NavigationManager?.NavigateTo("/groups/add");
}

private void GoToGroupView(Guid groupId)
{
    NavigationManager?.NavigateTo($"/group/view/{groupId}");
}

private Task SetOption(string letter)
{
    selectedLetter = selectedLetter == letter ? string.Empty : letter;
    currentPage = 1;
    ApplyFiltersAndPaging();
    return Task.CompletedTask;
}


private void GoToWebsite(Guid Id)
{
    try
    {
        // Get website URL
    }
    catch
    {

    }

    Snackbar.Add($"No website has been configured for this client yet");
}


private void GoToEditGroup(Guid Id)
{
    NavigationManager?.NavigateTo($"/group/edit/{Id}");
}

private async Task DeleteGroup(Guid id)
{
    var response = await GroupService.DeleteGroup(id);

    if (response is null || response.Id == Guid.Empty)
    {
        Snackbar.Add("Group not found", MudBlazor.Severity.Error);
        return;
    }

    _allRows.RemoveAll(x => x.Id == id);
    ApplyFiltersAndPaging();
}

private async Task ChangeClientActivity(GroupTableRow row)
{
    // Optimistic toggle
    row.IsActive = !row.IsActive;
    ApplyFiltersAndPaging();

    try
    {
        var patch = new PatchGroupRequest(
            row.Id,
            null, null, null, null, null, null, null, null,
            row.IsActive
        );

        var response = await GroupService.PatchGroup(patch);

        if (response.Id == Guid.Empty)
            throw new InvalidOperationException("Group not found");

        Snackbar.Add("Group activity changed", MudBlazor.Severity.Success);
    }
    catch
    {
        // Rollback
        row.IsActive = !row.IsActive;
        ApplyFiltersAndPaging();

        Snackbar.Add("Failed to change activity", MudBlazor.Severity.Error);
    }
}

}

<style>
    /* =====================================
               MOBILE – CENTER ALL CONTENT BELOW HEADER
               ===================================== */
    @@media (max-width: 768px) {
        .hstack.p-3 {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

            .hstack.p-3 .ms-auto {
                margin-left: 0 !important;
            }

            .hstack.p-3 button {
                width: 100%;
            }

        .card-body {
            align-items: center;
        }

        .mud-table-cell[data-label="Client Name"]::before {
            display: none !important;
            content: none !important;
        }

        .card-body > * {
            width: 100%;
            max-width: 100%;
        }
        /* ===============================
                   ALPHABET FILTER – CENTER
                   =============================== */
        .h-stack {
            justify-content: center;
            text-align: center;
        }
        /* ===============================
                   STATUS / ACTIVITY BAR – CENTER
                   =============================== */
        .ps-5 {
            padding-left: 0 !important;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .mud-toggle-group {
            justify-content: center;
        }
        /* ===============================
                   GROUP CARDS – CENTER
                   =============================== */
        .mud-table {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .mud-table-row {
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .mud-table,
        .mud-table-body,
        .mud-table-row {
            width: 100% !important;
            max-width: 100% !important;
        }

        .mud-table-row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .mud-table-cell[data-label="Client Name"] .hstack {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mud-table-cell[data-label="Client Name"] img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mud-table-cell[data-label="Client Name"] .mud-button {
            padding: 0;
            text-align: left;
            font-size: 15px;
            font-weight: 600;
        }
        /* ===============================
                   PAGINATION – CENTER
                   =============================== */
        .mt-auto {
            justify-content: center !important;
            flex-wrap: wrap;
            gap: 6px;
        }

        .mud-xs-table .mud-table-cell {
            padding: 10px 10px !important;
        }

        .mt-auto span {
            width: 100%;
            text-align: center;
            margin-bottom: 6px;
        }

        .mud-table-cell[data-label="Client Name"] .hstack {
            display: flex;
            align-items: center !important;
            gap: 80px !important;
        }

        .mud-xs-table .mud-table-cell {
            display: flex;
            justify-content: flex-start !important;
            gap: 80px !important;
            text-align: start !important;
        }
    }
</style>
