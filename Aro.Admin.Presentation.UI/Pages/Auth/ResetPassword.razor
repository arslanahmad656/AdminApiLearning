@page "/reset-password"
@page "/reset"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@using Aro.Admin.Presentation.UI.Services
@inject NavigationManager NavigationManager
@inject IPasswordResetService PasswordResetService
@inject ISnackbar Snackbar

<div class="login-container">
    <div class="login-left-panel">
        <div class="logo-container">
            <img src="aro-logo.svg" alt="ARO Digital Strategy" class="aro-logo-svg" />
        </div>
    </div>

    <div class="login-right-panel">
        <div class="login-card">
            @if (string.IsNullOrEmpty(resetToken))
            {
                <div class="login-header">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Class="mb-3" />
                    <h2 class="login-text">Invalid Reset Link</h2>
                </div>

                <MudAlert Severity="Severity.Error" Class="mb-4">
                    This password reset link is invalid or has expired.
                </MudAlert>

                <MudText Typo="Typo.body2" Class="mb-4">
                    Please request a new password reset link.
                </MudText>

                <div class="login-button-container">
                    <MudButton Variant="Variant.Filled"
                               Class="login-button"
                               Href="/forgot-password"
                               FullWidth="false">
                        Request New Link
                    </MudButton>
                </div>
            }
            else
            {
                <div class="login-header">
                    <h1 class="welcome-text">Welcome</h1>
                    <h2 class="login-text">Reset Password</h2>
                </div>

                <MudText Typo="Typo.body2" Class="mb-4">
                    Enter your new password below.
                </MudText>

                <MudForm @ref="form" Class="login-form">
                    <MudTextField @bind-Value="model.NewPassword"
                                  Label="New password"
                                  Variant="Variant.Outlined"
                                  InputType="@newPasswordInputType"
                                  Class="login-input"
                                  Required="true"
                                  RequiredError="New password is required"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@newPasswordIcon"
                                  OnAdornmentClick="ToggleNewPasswordVisibility"
                                  HelperText="Must be at least 8 characters with uppercase, lowercase, and number" />

                    <MudTextField @bind-Value="model.ConfirmPassword"
                                  Label="Confirm new password"
                                  Variant="Variant.Outlined"
                                  InputType="@confirmPasswordInputType"
                                  Class="login-input"
                                  Required="true"
                                  RequiredError="Please confirm your password"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@confirmPasswordIcon"
                                  OnAdornmentClick="ToggleConfirmPasswordVisibility" />

                    <div class="login-button-container">
                        <MudButton Variant="Variant.Filled"
                                   Class="login-button"
                                   OnClick="HandleResetPassword"
                                   Disabled="@isLoading"
                                   FullWidth="false">
                            @if (isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Resetting...</MudText>
                            }
                            else
                            {
                                <MudText>Reset Password</MudText>
                            }
                        </MudButton>
                    </div>
                </MudForm>
            }
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private ResetPasswordModel model = new();
    private string? resetToken;
    private bool isLoading = false;

    private bool newPasswordVisible = false;
    private InputType newPasswordInputType = InputType.Password;
    private string newPasswordIcon = Icons.Material.Filled.Visibility;

    private bool confirmPasswordVisible = false;
    private InputType confirmPasswordInputType = InputType.Password;
    private string confirmPasswordIcon = Icons.Material.Filled.Visibility;

    protected override void OnInitialized()
    {
        // Get token from query string
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        resetToken = query["token"];

        Console.WriteLine($"ResetPassword: Token from URL: {(string.IsNullOrEmpty(resetToken) ? "missing" : "present")}");
    }

    private void ToggleNewPasswordVisibility()
    {
        newPasswordVisible = !newPasswordVisible;
        newPasswordInputType = newPasswordVisible ? InputType.Text : InputType.Password;
        newPasswordIcon = newPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        confirmPasswordVisible = !confirmPasswordVisible;
        confirmPasswordInputType = confirmPasswordVisible ? InputType.Text : InputType.Password;
        confirmPasswordIcon = confirmPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    private async Task HandleResetPassword()
    {
        await form!.Validate();

        if (!form.IsValid)
        {
            return;
        }

        // Validate passwords match
        if (model.NewPassword != model.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        if (string.IsNullOrEmpty(resetToken))
        {
            Snackbar.Add("Invalid reset token", Severity.Error);
            return;
        }

        isLoading = true;

        try
        {
            var response = await PasswordResetService.ResetPasswordAsync(resetToken, model.NewPassword);

            if (response != null && response.Success)
            {
                Snackbar.Add("Password reset successfully! Please login with your new password.", Severity.Success);

                // Small delay to show the success message
                await Task.Delay(1000);

                // Navigate to login page with success indicator
                NavigationManager.NavigateTo("/login?passwordReset=true");
            }
            else
            {
                var errorMessage = response?.Message ?? "Failed to reset password. The link may have expired.";
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Reset password error: {ex.Message}");
            Snackbar.Add("An error occurred. Please try again.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class ResetPasswordModel
    {
        [Required(ErrorMessage = "New password is required")]
        [MinLength(8, ErrorMessage = "Password must be at least 8 characters")]
        [RegularExpression(@"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$",
            ErrorMessage = "Password must contain at least one uppercase letter, one lowercase letter, and one number")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
