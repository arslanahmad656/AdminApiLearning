@page "/reset"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@inject NavigationManager NavigationManager

<div class="login-container">
    <div class="login-left-panel">
        <div class="logo-container">
            <img src="aro-logo.svg" alt="ARO Digital Strategy" class="aro-logo-svg" />
        </div>
    </div>

    <div class="login-right-panel">
        <div class="login-card">
            <div class="login-header">
                <h1 class="welcome-text">Welcome</h1>
                <h2 class="login-text">Reset Password</h2>
            </div>

            <MudForm @ref="form" Class="login-form">
                <MudTextField @bind-Value="model.Username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Class="login-input"
                              Required="true"
                              RequiredError="Username is required" />

                <MudTextField @bind-Value="model.NewPassword"
                              Label="New password"
                              Variant="Variant.Outlined"
                              InputType="@newPasswordInputType"
                              Class="login-input"
                              Required="true"
                              RequiredError="New password is required"
                              Adornment="Adornment.End"
                              AdornmentIcon="@newPasswordIcon"
                              OnAdornmentClick="ToggleNewPasswordVisibility" />

                <MudTextField @bind-Value="model.ConfirmPassword"
                              Label="Confirm new password"
                              Variant="Variant.Outlined"
                              InputType="@confirmPasswordInputType"
                              Class="login-input"
                              Required="true"
                              RequiredError="Please confirm your password"
                              Adornment="Adornment.End"
                              AdornmentIcon="@confirmPasswordIcon"
                              OnAdornmentClick="ToggleConfirmPasswordVisibility" />

                <div class="login-button-container">
                    <MudButton Variant="Variant.Filled"
                               Class="login-button"
                               OnClick="HandleResetPassword"
                               FullWidth="false">
                        Continue
                    </MudButton>
                </div>
            </MudForm>
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private ResetPasswordModel model = new();

    private bool newPasswordVisible = false;
    private InputType newPasswordInputType = InputType.Password;
    private string newPasswordIcon = Icons.Material.Filled.Visibility;

    private bool confirmPasswordVisible = false;
    private InputType confirmPasswordInputType = InputType.Password;
    private string confirmPasswordIcon = Icons.Material.Filled.Visibility;

    private void ToggleNewPasswordVisibility()
    {
        newPasswordVisible = !newPasswordVisible;
        newPasswordInputType = newPasswordVisible ? InputType.Text : InputType.Password;
        newPasswordIcon = newPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        confirmPasswordVisible = !confirmPasswordVisible;
        confirmPasswordInputType = confirmPasswordVisible ? InputType.Text : InputType.Password;
        confirmPasswordIcon = confirmPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    private async Task HandleResetPassword()
    {
        await form!.Validate();

        if (form.IsValid)
        {
            // Validate passwords match
            if (model.NewPassword != model.ConfirmPassword)
            {
                // TODO: Show error message that passwords don't match
                Console.WriteLine("Passwords do not match");
                return;
            }

            // TODO: Implement actual password reset logic here
            // Call your API to reset the password
            Console.WriteLine($"Resetting password for: {model.Username}");

            // Navigate to login page with success message
            NavigationManager.NavigateTo("/login?passwordReset=true");
        }
    }

    public class ResetPasswordModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "New password is required")]
        [MinLength(8, ErrorMessage = "Password must be at least 8 characters")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
