@page "/login"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Aro.Admin.Presentation.UI.Services
@inject NavigationManager NavigationManager
@inject IAuthenticationService AuthService
@inject ApiAuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<div class="login-container">
    <div class="login-left-panel">
        <div class="logo-container">
            <img src="aro-logo.svg" alt="ARO Digital Strategy" class="aro-logo-svg" />
        </div>
    </div>

    <div class="login-right-panel">
        <div class="login-card">
            @if (showSuccessMessage)
            {
                <MudAlert Severity="Severity.Success" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => showSuccessMessage = false)">
                    New password has been set!
                </MudAlert>
            }

            <div class="login-header">
                <h1 class="welcome-text">Welcome</h1>
                <h2 class="login-text">Login</h2>
            </div>

            <MudForm @ref="form" Class="login-form">
                <MudTextField @bind-Value="model.Username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Class="login-input"
                              Required="true"
                              RequiredError="Username is required" />

                <MudTextField @bind-Value="model.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="@passwordInputType"
                              Class="login-input"
                              Required="true"
                              RequiredError="Password is required"
                              Adornment="Adornment.End"
                              AdornmentIcon="@passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility" />

                <div class="remember-me-container">
                    <MudCheckBox @bind-Value="model.RememberMe" Color="Color.Dark">
                        Remember me
                    </MudCheckBox>
                </div>

                <div class="forgot-password-container">
                    <span>Forgot your password? <MudLink Href="/forgot-password" Underline="Underline.Always" Color="Color.Dark">Reset here.</MudLink></span>
                </div>

                <div class="login-button-container">
                    <MudButton Variant="Variant.Filled"
                               Class="login-button"
                               OnClick="HandleLogin"
                               Disabled="@isLoading"
                               FullWidth="false">
                        @if (isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Logging in...</MudText>
                        }
                        else
                        {
                            <MudText>Continue</MudText>
                        }
                    </MudButton>
                </div>
            </MudForm>
        </div>
    </div>
</div>

@code {
    private MudForm? form;
    private LoginModel model = new();
    private bool showSuccessMessage = false;
    private bool isLoading = false;
    private bool passwordVisible = false;
    private InputType passwordInputType = InputType.Password;
    private string passwordIcon = Icons.Material.Filled.Visibility;

    protected override void OnInitialized()
    {
        // Check if redirected from password reset
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (query["passwordReset"] == "true")
        {
            showSuccessMessage = true;
        }
    }

    private void TogglePasswordVisibility()
    {
        passwordVisible = !passwordVisible;
        passwordInputType = passwordVisible ? InputType.Text : InputType.Password;
        passwordIcon = passwordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    }

    private async Task HandleLogin()
    {
        await form!.Validate();

        if (!form.IsValid)
        {
            return;
        }

        isLoading = true;

        try
        {
            // Call API to authenticate with rememberMe parameter
            var response = await AuthService.LoginAsync(model.Username, model.Password, model.RememberMe);

            if (response != null)
            {
                // Clear any existing toasts before showing success
                Snackbar.Clear();

                // Update authentication state
                await AuthStateProvider.MarkUserAsAuthenticated();

                // Show success message
                Snackbar.Add("Login successful! Welcome back.", Severity.Success);

                // Small delay to show success message before navigation
                await Task.Delay(500);

                // Navigate to home page
                NavigationManager.NavigateTo("/");
            }
            else
            {
                // Clear any existing toasts first
                Snackbar.Clear();

                // Show error message
                Snackbar.Add("Invalid email or password. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            // Clear any existing toasts first
            Snackbar.Clear();

            Snackbar.Add("An error occurred during login. Please try again.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; } = false;
    }
}
